<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>ELF を吐く C コンパイラを Rui 本の方式で作る</title>
	<meta name="viewport" content="width=device-width">
<style>
		img.icon {
			border-radius: 50%;
		}
		div.one_person {
			display: flex;
			padding-bottom: 10px;
		}
		blockquote {
			position: relative;
			border-left: 3px solid #005242;
			padding-left: 10px;
			margin-inline-start: 10px;
			white-space: pre-wrap;
		}
		a {
			overflow-wrap: anywhere;
		}
		h3 {
			margin-top: 15px;
		}
		.name a {
			text-decoration: none;
			color: inherit;
		}
		.name a:hover {
			text-decoration: underline;
		}
		div.name_and_content {
			padding-left: 10px;
		}
		pre {
			white-space: pre-wrap;
		}
		body {
			text-size-adjust: 100%;
			-webkit-text-size-adjust: 100%;
		}
		.permalink {
			margin-left: 15px;
			padding: .2em .6em .3em;
			font-size: 75%;
			font-weight: 700;
			line-height: 1;
			color: #fff;
			text-align: center;
			white-space: nowrap;
			vertical-align: center;
			border-radius: .25em;
			background-color: #666666;
			text-decoration: none;
			visibility: hidden;
		}
	</style>
	<link rel="stylesheet" href="vs.min.css">
	<script src="highlight.min.js"></script>
	<script>hljs.highlightAll();</script>
</head>
<body style="background-color: #eeeeee">
<h1>ELF を吐く C コンパイラを Rui 本の方式で作る</h1>
<p>編纂者：<a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></p>
<p><a href="https://github.com/sozysozbot/c_to_elf_compiler">リポジトリへのリンク</a></p>
<p><a href="https://docs.google.com/presentation/d/1ms7ZhaBbwB9zPcvax-ElwFXIMu28jE4D6QRBWNPoIDo">Google Presentation へのバックリンク</a></p>

<h2>会話ログ本体</h2><h3 class="date">2022年10月3日（Discord にて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_95d88f0ac94e8d1025e3d1eec271a1bb').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_95d88f0ac94e8d1025e3d1eec271a1bb').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_95d88f0ac94e8d1025e3d1eec271a1bb" href="#permalink_95d88f0ac94e8d1025e3d1eec271a1bb" class="permalink">¶</a>
		<div class="content">そういや C コンパイラやってないな。アセンブリ言語を機械語にするのに binutils のを使うのもどうなんだろと思ってたらそのまま数ヶ月経ってた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3f2a03d776d134865ea86738cf71dd63').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3f2a03d776d134865ea86738cf71dd63').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3f2a03d776d134865ea86738cf71dd63" href="#permalink_3f2a03d776d134865ea86738cf71dd63" class="permalink">¶</a>
		<div class="content">いいですね。だったら、Rui 本の原則に則って、『step 1 からもう ELF バイナリへとコンパイルしちゃう』『常に実行形式をコンパイラが生成し続けられるようにする』というのでやってみませんか？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1ff958f9377fd22e8367451f0a272399').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1ff958f9377fd22e8367451f0a272399').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1ff958f9377fd22e8367451f0a272399" href="#permalink_1ff958f9377fd22e8367451f0a272399" class="permalink">¶</a>
		<div class="content">なるほど</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_671c245347ecd6731eaf4f9ba276e82f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_671c245347ecd6731eaf4f9ba276e82f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_671c245347ecd6731eaf4f9ba276e82f" href="#permalink_671c245347ecd6731eaf4f9ba276e82f" class="permalink">¶</a>
		<div class="content">C → アセンブラのコンパイラをセルフホストしたあとにアセンブラとリンカと libc と書くのは既に ushitora_anqou がやってるけど、最初から ELF バイナリへとコンパイルしつづける形式で Rui 本を走ってる人を私は知らないので、やってみるとおもしろそう</div>
		<div class="content">教材書けとは言わんので、作業ログでもいいんで書いてみません？言語はどれでやるんです？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_770da497666650cc1b0b2648b7612410').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_770da497666650cc1b0b2648b7612410').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_770da497666650cc1b0b2648b7612410" href="#permalink_770da497666650cc1b0b2648b7612410" class="permalink">¶</a>
		<div class="content">もちろん Rust</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cc97c50cfe1e67a2658c96151f6e1d2d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cc97c50cfe1e67a2658c96151f6e1d2d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_cc97c50cfe1e67a2658c96151f6e1d2d" href="#permalink_cc97c50cfe1e67a2658c96151f6e1d2d" class="permalink">¶</a>
		<div class="content">じゃあ、step 1 は『return 3; するやつと return 42; するやつを gcc でコンパイルして ELF バイナリを吐いて、その差分を比較してどのバイトを置き換えるべきかを調べ、それを &#x60;include_bytes!()&#x60; する』という方針にするのがよさそう</div>
		<div class="content">なので、step 1 ではアセンブラもリンカもない。まあ、拡張していくと、機械語を直にいじるのがじきにきつくなるので、だんだんアセンブリ言語が育っていって、それは GNU のアセンブリ言語とそれなりに互換性があることが期待されるが、別にそれを目標にするわけではない。</div>
		<div class="content">という感じでやっていくとよさそう。今日はもう寝ます？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2549241bf7ae5f463ba351590415956b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2549241bf7ae5f463ba351590415956b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_2549241bf7ae5f463ba351590415956b" href="#permalink_2549241bf7ae5f463ba351590415956b" class="permalink">¶</a>
		<div class="content">いま布団の中です</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bef481b97aada825069536205dcb453f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bef481b97aada825069536205dcb453f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_bef481b97aada825069536205dcb453f" href="#permalink_bef481b97aada825069536205dcb453f" class="permalink">¶</a>
		<div class="content">ではでは、おやすみなさい〜</div>
	</div>
</div>
<h3 class="date">2022年10月3日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8e86cb6e213cb27b3a5ab911be5549a5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8e86cb6e213cb27b3a5ab911be5549a5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8e86cb6e213cb27b3a5ab911be5549a5" href="#permalink_8e86cb6e213cb27b3a5ab911be5549a5" class="permalink">¶</a>
		<div class="content">じゃあ私が勝手に step 1 を実装するか。なんなら会話ログももうレンダリングできるようにしておこう</div>
		<div class="content">とりあえず docs フォルダを立てて、docs/dialog.txt に会話を書いて docs/ 内で node index.js したらログがレンダリングできるようにしておいた</div>
		<div class="content">このリポジトリに招待を飛ばしておいて、</div>
		<div class="content">Ubuntu の方にリポジトリをクローンし、cargo init し、議事録を書く。おや、npm が通らない。えっと <a href="https://stackoverflow.com/questions/67938486/after-installing-npm-on-wsl-ubuntu-20-04-i-get-the-message-usr-bin-env-bash" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/67938486/after-installing-npm-on-wsl-ubuntu-20-04-i-get-the-message-usr-bin-env-bash</a> に従ったら直った。</div>
		<div class="content">ちゃんと README.md も書いておこう。まあ日本語と英語で書いておくか。</div>
		<div class="content">もう step 1 は私がやってしまおう。experiment フォルダにファイルを用意して、</div>
		<div class="content">とりあえず Makefile はこんな感じでいいか</div>
		<pre><code class="language-Makefile">CFLAGS=-std=c17 -Wall -s

3: 3.c
42: 42.c

clean: 
	rm 3
	rm 42

.PHONY: clean
</code></pre>
		<div class="content">gcc が出力したファイルのサイズを数えると、</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c 3
13296 3
</code></pre>
		<div class="content">うーむ、デカい！</div>
		<div class="content">まあ、考えてみると、一応 gcc の出力をそのまま使う必要もないんだよな</div>
		<div class="content"> <a href="https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html" target="_blank" rel="noopener noreferrer">https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html</a> に頼って、もっと小さい実行形式を出力できるようなお膳立てをしてからじゃないと step 1 にふさわしくない気がする</div>
		<div class="content">というか、reproducible なビルドになるようにしないといけないんだよな</div>
		<div class="content">……よし、こうするか。</div>
		<div class="content"><ol><li>nasm かなんかで小さな .asm をコンパイルすることで、我々が目指すべき「動く小さい ELF バイナリ」を得る</li><li>それはそれとして、我々が作るのは C コンパイラなので、常に C 言語（のようなもの）を入力として取る</li></ol></div>
	</div>
</div>
<h3 class="date">2022年10月3日（yukata_yu との会話）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer"><img alt="ゆかたゆ" class="icon" src="icons/ゆかたゆ.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_049f6dcd21896d3f1dc0920038a74215').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_049f6dcd21896d3f1dc0920038a74215').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer">ゆかたゆ</a></span><a id="permalink_049f6dcd21896d3f1dc0920038a74215" href="#permalink_049f6dcd21896d3f1dc0920038a74215" class="permalink">¶</a>
		<div class="content">-O1 を使わないのですか？ (エイリアスなんでしたっけ)</div>
		<div class="content">あー， -Osがあるんだ…</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8ea4f902ea0033bc92d29429e5baa815').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8ea4f902ea0033bc92d29429e5baa815').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8ea4f902ea0033bc92d29429e5baa815" href="#permalink_8ea4f902ea0033bc92d29429e5baa815" class="permalink">¶</a>
		<div class="content">-O1 を導入せず、gcc を消し飛ばして nasm で作るようにします</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer"><img alt="ゆかたゆ" class="icon" src="icons/ゆかたゆ.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e98a8badb501679c38398e0088e8b483').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e98a8badb501679c38398e0088e8b483').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer">ゆかたゆ</a></span><a id="permalink_e98a8badb501679c38398e0088e8b483" href="#permalink_e98a8badb501679c38398e0088e8b483" class="permalink">¶</a>
		<div class="content">なるほ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_92f7f54b86e83f024726da054ab0a5db').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_92f7f54b86e83f024726da054ab0a5db').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_92f7f54b86e83f024726da054ab0a5db" href="#permalink_92f7f54b86e83f024726da054ab0a5db" class="permalink">¶</a>
		<div class="content">-Os を使うと、3 + 4 - 2 とかが畳み込まれちゃう気がするので</div>
		<div class="content">まあ一応 -Os でどれくらい減るのかも実験しておくか。そもそも nasm にする予定だけど。CFLAGS=-std=c17 -Wall -s -Os で試すと、</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make 3
cc -std=c17 -Wall -s -Os    3.c   -o 3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make 42
cc -std=c17 -Wall -s -Os    42.c   -o 42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c 3
14328 3
</code></pre>
		<div class="content">はい、ということで nasm 使います</div>
	</div>
</div>
<h3 class="date">2022年10月3日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7bd3a87583996ba4a89e989af9ee14d7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7bd3a87583996ba4a89e989af9ee14d7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7bd3a87583996ba4a89e989af9ee14d7" href="#permalink_7bd3a87583996ba4a89e989af9ee14d7" class="permalink">¶</a>
		<div class="content">とりあえず、原典にこうあるけど、</div>
		<pre><code class="language-x86asm">  ; tiny.asm
  BITS 32
  GLOBAL _start
  SECTION .text
  _start:
                mov     eax, 1
                mov     ebx, 42  
                int     0x80
</code></pre>
		<div class="content">64 ビット環境だし、この BITS 32 を削って実行してみるか。Makefile はこんな感じ</div>
		<pre><code class="language-Makefile">tiny42: tiny42.asm
	nasm -f elf tiny42.asm
	gcc -Wall -s -nostdlib tiny42.o -o tiny42
</code></pre>
		<div class="content">make tiny42 をすると～？</div>
		<pre><code class="language-shell">nasm -f elf tiny42.asm
gcc -Wall -s -nostdlib tiny42.o -o tiny42
/usr/bin/ld: i386 architecture of input file &#x60;tiny42.o&#x27; is incompatible with i386:x86-64 output
collect2: error: ld returned 1 exit status
make: *** [Makefile:12: tiny42] Error 1
</code></pre>
		<div class="content">はい。正直そんな気はしてた</div>
		<div class="content">普通に gcc 付属のアセンブラを使ってみるか</div>
		<pre><code class="language-x86asm">.globl _start
_start:
	movl	$1, %eax
	movl	$42, %ebx  
	int		$0x80
</code></pre>
		<div class="content">に対して</div>
		<pre><code class="language-Makefile">tiny42: tiny42.s
	gcc -Wall -s -nostdlib tiny42.s -o tiny42
</code></pre>
		<div class="content">をかませてやると、まあちゃんと動く。しかし wc -c tiny42 すると 13024 tiny42 なので、結局問題が解決してないんだよな</div>
		<div class="content">食事から戻った。やっていき</div>
		<div class="content"><a href="https://cs.lmu.edu/~ray/notes/nasmtutorial/" target="_blank" rel="noopener noreferrer">https://cs.lmu.edu/~ray/notes/nasmtutorial/</a> 曰く、</div>
		<pre><code class="language-">nasm -felf64 hello.asm &amp;&amp; ld hello.o &amp;&amp; ./a.out
</code></pre>
		<div class="content">でよいとのこと。なるほど、やってみるか</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64 tiny42.asm
ld tiny42.o -o tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ echo $?
42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c tiny42
4672 tiny42
</code></pre>
		<div class="content">まあこんなもんか。これ以上削るのはやりすぎな気もする</div>
		<div class="content">一応マニュアル <a href="https://www.nasm.us/doc/" target="_blank" rel="noopener noreferrer">https://www.nasm.us/doc/</a> を見る。あ、--reproducible があるのか、都合がいい、つけておこう</div>
		<div class="content">おや、動かない。このバージョンの nasm にはないのかな</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ nasm --version
NASM version 2.14.02
</code></pre>
		<div class="content">マニュアルは version 2.15.05 となっている。この --reproducible、なんと version 2.15.05 で加わった最新の機能だそうだ。すばらしい</div>
		<div class="content">手元の WSL 2 上の Ubuntu でも sudo apt-get update からの sudo apt-get -y install nasm をすれば nasm が最新になってくれたりしないかな</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ sudo apt-get -y install nasm
Reading package lists... Done
Building dependency tree       
Reading state information... Done
nasm is already the newest version (2.14.02-1).
The following package was automatically installed and is no longer required:
  libfwupdplugin1
Use &#x27;sudo apt autoremove&#x27; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 44 not upgraded.
</code></pre>
		<div class="content">残念。じゃあ自分で入れるしかないか</div>
		<div class="content">とりあえず <a href="https://www.linuxfromscratch.org/blfs/view/svn/general/nasm.html" target="_blank" rel="noopener noreferrer">https://www.linuxfromscratch.org/blfs/view/svn/general/nasm.html</a> に従って入れて……</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ nasm --version
NASM version 2.15.05 compiled on Oct  3 2022
</code></pre>
		<div class="content">よし。ではいよいよ</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64  --reproducible tiny42.asm
ld tiny42.o -o tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny3
nasm -felf64  --reproducible tiny3.asm
ld tiny3.o -o tiny3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42; echo $?
42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny3; echo $?
3
</code></pre>
		<div class="content">これは、やったか？</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ cmp -l ./tiny42 ./tiny3
4103  52   3
4185  21  20
4209  14  13
4233  30  27
4257  37  36
4286  64  63
4287  62  56
4288  56 141
4289 141 163
4290 163 155
4291 155   0
4292   0 137
4294 137 142
4295 142 163
4297 163 137
4298 137 163
4299 163 164
4300 164 141
4301 141 162
4302 162 164
4303 164   0
4304   0 137
4305 137 145
4306 145 144
4307 144 141
4308 141 164
4309 164 141
4310 141   0
4311   0 137
4312 137 145
4313 145 156
4314 156 144
4315 144   0
4317   0  56
4318  56 163
4319 163 171
4320 171 155
4321 155 164
4322 164 141
4323 141 142
4324 142   0
4325   0  56
4326  56 163
4327 163 164
4328 164 162
4329 162 164
4330 164 141
4331 141 142
4332 142   0
4333   0  56
4334  56 163
4335 163 150
4336 150 163
4337 163 164
4338 164 162
4339 162 164
4340 164 141
4341 141 142
4342 142   0
4343   0  56
4344  56 164
4345 164 145
4346 145 170
4347 170 164
4348 164   0
4577  44  43
4633 334 333
</code></pre>
		<div class="content">んー。ああそうか、ld 側にも reproducible にしてくれと頼まないと</div>
		<div class="content">……軽く調べたが、頼み方がよくわからん。リンカを gold にしたらバージョン名を埋め込んできたし。んー、1 バイトのズレはファイル名『tiny3.asm』『tiny42.asm』の差に起因してるっぽいし、そこを strip かなんかで処理すれば解決するかも？</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64  --reproducible tiny42.asm
ld tiny42.o -o tiny42
strip tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny3
nasm -felf64  --reproducible tiny3.asm
ld tiny3.o -o tiny3
strip tiny3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42; echo $?; ./tiny3; echo $?
42
3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ cmp -l ./tiny42 ./tiny3
4103  52   3
</code></pre>
		<div class="content">よし、差分が 1 バイトになった！！！！！</div>
		<div class="content">ここで 52 って出てるのは cmp コマンドがバイトを 8 進数で出力する仕様になっているからであって、これは 10 進数だと 42 なのでこれで正解です</div>
		<div class="content">よーし、やっとスタート地点に立つことができた</div>
		<pre><code class="language-rust">fn main() -&gt; std::io::Result&lt;()&gt; {
    let input = std::env::args().nth(1).expect(&quot;入力が与えられていません&quot;);
    let input: u8 = input.parse().expect(&quot;入力をパースできません&quot;);
    let tiny_3 = include_bytes!(&quot;../experiment/tiny3&quot;);
    let tiny_42 = include_bytes!(&quot;../experiment/tiny42&quot;);
    assert_eq!(tiny_3.len(), tiny_42.len());

    let file = std::fs::File::create(&quot;a.out&quot;)?;

    {
        use std::io::Write;
        let mut writer = std::io::BufWriter::new(file);
        for (index, byte) in tiny_3.iter().enumerate() {
            if *byte == tiny_42[index] {
                writer.write_all(&amp;[*byte])?;
            } else if *byte == 3 &amp;&amp; tiny_42[index] == 42 {
                writer.write_all(&amp;[input])?;
            } else {
                panic!(&quot;&#x60;../experiment/tiny3&#x60; と &#x60;../experiment/tiny42&#x60; の間に非自明な差分が見つかったので、なにを出力すべきか分かりません&quot;)
            }
        }
    }
    Ok(())
}
</code></pre>
		<div class="content">これで、step 1 達成！</div>
	</div>
</div>
<h3 class="date">2022年10月15日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_776345dcf24b83983b634024dc21ee83').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_776345dcf24b83983b634024dc21ee83').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_776345dcf24b83983b634024dc21ee83" href="#permalink_776345dcf24b83983b634024dc21ee83" class="permalink">¶</a>
		<div class="content">そういえば、あの実行形式まで作る c-to-elf-compiler</div>
		<div class="content">あれステップの偶奇で交互にやりません？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3edcb1c9d03799deaded0284c0037468').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3edcb1c9d03799deaded0284c0037468').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_3edcb1c9d03799deaded0284c0037468" href="#permalink_3edcb1c9d03799deaded0284c0037468" class="permalink">¶</a>
		<div class="content">あそこから先ってどうやるつもりなんです？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a5e38cf1f66271d8f6a94d174487b79a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a5e38cf1f66271d8f6a94d174487b79a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_a5e38cf1f66271d8f6a94d174487b79a" href="#permalink_a5e38cf1f66271d8f6a94d174487b79a" class="permalink">¶</a>
		<div class="content">いまは写経させてるわけですけど、ステップが進むごとに、その写経してる実行ファイルの内容を少しずつ学ばないといけない</div>
		<div class="content">逆に、学ばなくていいところは未来に先送りする</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b08f0e4aa2dd086ecc5d5628c2c15808').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b08f0e4aa2dd086ecc5d5628c2c15808').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_b08f0e4aa2dd086ecc5d5628c2c15808" href="#permalink_b08f0e4aa2dd086ecc5d5628c2c15808" class="permalink">¶</a>
		<div class="content">そこらへんの仕様って……ネットで調べれば落ちてるか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6a99f7d55f0c0423d2afa70274c2b030').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6a99f7d55f0c0423d2afa70274c2b030').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_6a99f7d55f0c0423d2afa70274c2b030" href="#permalink_6a99f7d55f0c0423d2afa70274c2b030" class="permalink">¶</a>
		<div class="content">それを調べてログに書くのもステップの一部とする、という方針で考えてます</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/yuchiki1000yen" target="_blank" rel="noopener noreferrer"><img alt="yuchiki" class="icon" src="icons/yuchiki.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6e6d11cc98d6a8933b9e0ee02d205b47').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6e6d11cc98d6a8933b9e0ee02d205b47').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/yuchiki1000yen" target="_blank" rel="noopener noreferrer">yuchiki</a></span><a id="permalink_6e6d11cc98d6a8933b9e0ee02d205b47" href="#permalink_6e6d11cc98d6a8933b9e0ee02d205b47" class="permalink">¶</a>
		<div class="content">教育的授業だ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bf486d7b2a2c1a5ef6ec2dbe4a18b619').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bf486d7b2a2c1a5ef6ec2dbe4a18b619').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_bf486d7b2a2c1a5ef6ec2dbe4a18b619" href="#permalink_bf486d7b2a2c1a5ef6ec2dbe4a18b619" class="permalink">¶</a>
		<div class="content">自分でバイナリを吐き出したい、と</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d2c1d15a6d8e11663fde07e6cb842be5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d2c1d15a6d8e11663fde07e6cb842be5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_d2c1d15a6d8e11663fde07e6cb842be5" href="#permalink_d2c1d15a6d8e11663fde07e6cb842be5" class="permalink">¶</a>
		<div class="content">つまり、要は作る側が頑張らないことで、読む側も頑張らなくて済む。少しずつ、ELF の中身を謎解きしていく追体験ができる</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_975190c17473c286ddf30539ac76566b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_975190c17473c286ddf30539ac76566b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_975190c17473c286ddf30539ac76566b" href="#permalink_975190c17473c286ddf30539ac76566b" class="permalink">¶</a>
		<div class="content">まあたしかにたしかに</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a46ab2cc04f56602aceac18ab5c9f06d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a46ab2cc04f56602aceac18ab5c9f06d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_a46ab2cc04f56602aceac18ab5c9f06d" href="#permalink_a46ab2cc04f56602aceac18ab5c9f06d" class="permalink">¶</a>
		<div class="content">というのを考えています。ということで、ステップ 2 『足し算と引き算』やってみません？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_9d026e2f629913f144b8538b22e09e5c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_9d026e2f629913f144b8538b22e09e5c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_9d026e2f629913f144b8538b22e09e5c" href="#permalink_9d026e2f629913f144b8538b22e09e5c" class="permalink">¶</a>
		<div class="content">足し算と引き算をやって、終了コードで返す</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fd5fcb5999be919888b9000f46c9098e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fd5fcb5999be919888b9000f46c9098e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_fd5fcb5999be919888b9000f46c9098e" href="#permalink_fd5fcb5999be919888b9000f46c9098e" class="permalink">¶</a>
		<div class="content">そうそう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d3e635471d6c8f6ed280d6fe74eb5cd8').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d3e635471d6c8f6ed280d6fe74eb5cd8').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d3e635471d6c8f6ed280d6fe74eb5cd8" href="#permalink_d3e635471d6c8f6ed280d6fe74eb5cd8" class="permalink">¶</a>
		<div class="content">結局 main 関数からリターンするだけか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_21e1e82ad5a00aff60b5f4350041dabb').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_21e1e82ad5a00aff60b5f4350041dabb').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_21e1e82ad5a00aff60b5f4350041dabb" href="#permalink_21e1e82ad5a00aff60b5f4350041dabb" class="permalink">¶</a>
		<div class="content">実はですね、今の実装は（ログに書いてありますが）_start なので、リンクせずに ebx レジスタに値をセットして、残りを OS に任せてる</div>
		<div class="content">これにより、リンクが要らない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_51fe2ef55f6bf0a4500100a9a288de38').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_51fe2ef55f6bf0a4500100a9a288de38').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_51fe2ef55f6bf0a4500100a9a288de38" href="#permalink_51fe2ef55f6bf0a4500100a9a288de38" class="permalink">¶</a>
		<div class="content">musl と crt とリンクさせる方針じゃなくても直接吐けばいいのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7e30f0026f4ce6a59d006627f49abc57').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7e30f0026f4ce6a59d006627f49abc57').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7e30f0026f4ce6a59d006627f49abc57" href="#permalink_7e30f0026f4ce6a59d006627f49abc57" class="permalink">¶</a>
		<div class="content">いずれは C コンパイラになることが期待されているので、いずれは関数 main や関数 foo が宣言できるようになる予定だけど、ステップ 1 を実現するのにはどう考えてもいらないので、したがって省いている</div>
		<div class="content">そう、要はなにかというと、この方法を取ることによって、まず謎解き感覚になって面白い。次に、『調べすぎちゃいけない』という縛りにしておくことで、我々ともに下手するとコンパイラにかまけて授業とか研究の手を抜きそうな民なので、それをある程度抑止できる</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_57d668909bf3b4a2ec6db14bd1e5e4c7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_57d668909bf3b4a2ec6db14bd1e5e4c7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_57d668909bf3b4a2ec6db14bd1e5e4c7" href="#permalink_57d668909bf3b4a2ec6db14bd1e5e4c7" class="permalink">¶</a>
		<div class="content">なるべくラクしてバイナリを吐こう、ってことか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_19649451ea1a2ab0ec1f15b19fbeca3c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_19649451ea1a2ab0ec1f15b19fbeca3c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_19649451ea1a2ab0ec1f15b19fbeca3c" href="#permalink_19649451ea1a2ab0ec1f15b19fbeca3c" class="permalink">¶</a>
		<div class="content">そうそう。要は compilerbook ってかなりよく書かれた教材なので、逆に言うとあの本をそのまま再走してもあんま面白くない。私に至っては 4 年前にやったし</div>
		<div class="content">となると、こういう企画にするのが、『我々にとっての面白さ』『我々にとっての勉強になる度』『学校・趣味バランス』の 3 点において優れている、と主張します</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_155fa3a0d065d7566d704057c3341300').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_155fa3a0d065d7566d704057c3341300').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_155fa3a0d065d7566d704057c3341300" href="#permalink_155fa3a0d065d7566d704057c3341300" class="permalink">¶</a>
		<div class="content">前は gcc のコンパイル結果を比較してた？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5eb42e8dba7c977d7a54af80a4456378').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5eb42e8dba7c977d7a54af80a4456378').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_5eb42e8dba7c977d7a54af80a4456378" href="#permalink_5eb42e8dba7c977d7a54af80a4456378" class="permalink">¶</a>
		<div class="content">実はリポジトリに会話ログを全部取ってあって、リポジトリが <a href="https://github.com/sozysozbot/c_to_elf_compiler" target="_blank" rel="noopener noreferrer">https://github.com/sozysozbot/c_to_elf_compiler</a> 、ログが <a href="https://sozysozbot.github.io/c_to_elf_compiler/log.html" target="_blank" rel="noopener noreferrer">https://sozysozbot.github.io/c_to_elf_compiler/log.html</a> </div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8857b292525df7826c18c6841fa7ddce').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8857b292525df7826c18c6841fa7ddce').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_8857b292525df7826c18c6841fa7ddce" href="#permalink_8857b292525df7826c18c6841fa7ddce" class="permalink">¶</a>
		<div class="content">なんか招待来てたな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_879027ce81c5750d693c6347341f8b3e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_879027ce81c5750d693c6347341f8b3e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_879027ce81c5750d693c6347341f8b3e" href="#permalink_879027ce81c5750d693c6347341f8b3e" class="permalink">¶</a>
		<div class="content">じゃあ再送しときます</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f328a6c9737e21f70e7565974fcba948').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f328a6c9737e21f70e7565974fcba948').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_f328a6c9737e21f70e7565974fcba948" href="#permalink_f328a6c9737e21f70e7565974fcba948" class="permalink">¶</a>
		<div class="content">受け取った気がする</div>
		<div class="content">足し算ステップってなにやるんでしたっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1a2399f4f6ff6bd3531fc4b78919d733').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1a2399f4f6ff6bd3531fc4b78919d733').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1a2399f4f6ff6bd3531fc4b78919d733" href="#permalink_1a2399f4f6ff6bd3531fc4b78919d733" class="permalink">¶</a>
		<div class="content">3+5-2とかをコンパイルする</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1b4559e877b3044382348470a15fe1fc').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1b4559e877b3044382348470a15fe1fc').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1b4559e877b3044382348470a15fe1fc" href="#permalink_1b4559e877b3044382348470a15fe1fc" class="permalink">¶</a>
		<div class="content">スタックは使わないやつだった気がする</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4f237fbef1240b754134426c1ade0ea2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4f237fbef1240b754134426c1ade0ea2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4f237fbef1240b754134426c1ade0ea2" href="#permalink_4f237fbef1240b754134426c1ade0ea2" class="permalink">¶</a>
		<div class="content">そう</div>
		<div class="content">構成としては、最初はマジでわけが分からずバイナリをただ写経してただけだったのが、ステップを進めていくうちに『これを実装するには、自分の理解を増やすことを強いられるな……』が積み重なって、最終的にアセンブラとリンカが勝手に生えてくる</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d0b83bc0897e55589339e1c517359752').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d0b83bc0897e55589339e1c517359752').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d0b83bc0897e55589339e1c517359752" href="#permalink_d0b83bc0897e55589339e1c517359752" class="permalink">¶</a>
		<div class="content">ELF の数値の表現ってどうでしたっけ。127 以下だとどうこう、だっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e92b3002157bb7585a563b95f97fb2ef').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e92b3002157bb7585a563b95f97fb2ef').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e92b3002157bb7585a563b95f97fb2ef" href="#permalink_e92b3002157bb7585a563b95f97fb2ef" class="permalink">¶</a>
		<div class="content">最初は小さい数だけが動けばよし！</div>
		<div class="content">というのが、そもそも Rui 本のスピリット</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e7e5b5fba690d3673304d1f5b1e906f8').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e7e5b5fba690d3673304d1f5b1e906f8').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_e7e5b5fba690d3673304d1f5b1e906f8" href="#permalink_e7e5b5fba690d3673304d1f5b1e906f8" class="permalink">¶</a>
		<div class="content">たしかに</div>
		<div class="content">なんて名前でしたっけ、可変長の表現の名前。そうだleb128だ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_dd6521e28da7314fdccb4694b6682549').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_dd6521e28da7314fdccb4694b6682549').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_dd6521e28da7314fdccb4694b6682549" href="#permalink_dd6521e28da7314fdccb4694b6682549" class="permalink">¶</a>
		<div class="content">そういう話も、調べて、メモって、『ここ対応できるようにしたいなぁ』となったときに初めて書く、という方針になるわけですね</div>
		<div class="content">あと言うべきこととしては、とりあえずリポジトリのドキュメンテーションはそれなりには書いたので、読めば分かる</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_019733818af50ca0a38be4385b98d432').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_019733818af50ca0a38be4385b98d432').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_019733818af50ca0a38be4385b98d432" href="#permalink_019733818af50ca0a38be4385b98d432" class="permalink">¶</a>
		<div class="content">開発環境は？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_26bb1c75b943195fa18e8da39c1b681e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_26bb1c75b943195fa18e8da39c1b681e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_26bb1c75b943195fa18e8da39c1b681e" href="#permalink_26bb1c75b943195fa18e8da39c1b681e" class="permalink">¶</a>
		<div class="content">Ubuntu on WSL</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e20fb0e97fd48c91f07d8d99dd8e00b6').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e20fb0e97fd48c91f07d8d99dd8e00b6').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_e20fb0e97fd48c91f07d8d99dd8e00b6" href="#permalink_e20fb0e97fd48c91f07d8d99dd8e00b6" class="permalink">¶</a>
		<div class="content">WSL 上じゃないと開発できないようになってそう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f1919ce259e895fdc0a8164fa71b3cc4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f1919ce259e895fdc0a8164fa71b3cc4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f1919ce259e895fdc0a8164fa71b3cc4" href="#permalink_f1919ce259e895fdc0a8164fa71b3cc4" class="permalink">¶</a>
		<div class="content">正解のバイナリを吐くのに使ってるアセンブラ nasm が、比較的最近 --reproducible ってオプションを実装してくれたので、LTS の Ubuntu で apt で入るやつにはまだこのオプションがなく、自分で configure して make する必要がある</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_39bad6d3ab37c251fdf8536e6284ec68').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_39bad6d3ab37c251fdf8536e6284ec68').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_39bad6d3ab37c251fdf8536e6284ec68" href="#permalink_39bad6d3ab37c251fdf8536e6284ec68" class="permalink">¶</a>
		<div class="content">nasm でしたっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cdc4bc05c8de5f42d2b51b572e57d1e5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cdc4bc05c8de5f42d2b51b572e57d1e5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_cdc4bc05c8de5f42d2b51b572e57d1e5" href="#permalink_cdc4bc05c8de5f42d2b51b572e57d1e5" class="permalink">¶</a>
		<div class="content">実をいうと、nasm が動かなくても、nasm が生成してくれたバイナリは『コミットしてある』ので、なくても我々の c-to-elf コンパイラは走る</div>
		<div class="content">あと、ログのレンダリングは私が雑に実装したレンダラでやってて、CI のセットアップしてないので、</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a7e837f16af289d29d8d24141ba5900c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a7e837f16af289d29d8d24141ba5900c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_a7e837f16af289d29d8d24141ba5900c" href="#permalink_a7e837f16af289d29d8d24141ba5900c" class="permalink">¶</a>
		<div class="content">勝手にはされない、と</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7db7f177fe29c6fec509435169fdc8a2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7db7f177fe29c6fec509435169fdc8a2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7db7f177fe29c6fec509435169fdc8a2" href="#permalink_7db7f177fe29c6fec509435169fdc8a2" class="permalink">¶</a>
		<div class="content">node index.js をコミット前にする必要がある</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1c47768436bc0d9c4a60bc02eed2dd4c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1c47768436bc0d9c4a60bc02eed2dd4c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1c47768436bc0d9c4a60bc02eed2dd4c" href="#permalink_1c47768436bc0d9c4a60bc02eed2dd4c" class="permalink">¶</a>
		<div class="content">nasm の 2.15 だと動きます？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_155028e5c0d93bb6cb93f92c1453a083').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_155028e5c0d93bb6cb93f92c1453a083').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_155028e5c0d93bb6cb93f92c1453a083" href="#permalink_155028e5c0d93bb6cb93f92c1453a083" class="permalink">¶</a>
		<div class="content">自信ないけど 2.16 以降が必要だったかな</div>
	</div>
</div>
<h3 class="date">2022年10月16日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_dc2876834cbd13f59b52401128da150d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_dc2876834cbd13f59b52401128da150d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_dc2876834cbd13f59b52401128da150d" href="#permalink_dc2876834cbd13f59b52401128da150d" class="permalink">¶</a>
		<div class="content">加減算の実装</div>
		<div class="content">&#x60;experiment/tiny3&#x60; のサイズが4kを超えていて機械語どころかアセンブリも詳しくない人には厳しい。</div>
		<div class="content">以下プログラムで127バイトのelfを生成して実行すると終了コード0を出力することを確認。<a href="https://github.com/tchajed/minimal-elf" target="_blank" rel="noopener noreferrer">https://github.com/tchajed/minimal-elf</a></div>
		<div class="content">&#x60;31 ff (xor %edi,%edi&#x60;) を &#x60;6a 01 (push $0x01) 5f (pop %edi)&#x60; にバイナリエディタで書き換えると終了コードが1になることを確認。アドレス &#x60;0x78&#x60; 以降を書き換えれば加減算の実装は簡単にできそうだ。</div>
		<div class="content">objdumpコマンドでmovやaddやsubのバイナリ表現を調べて実装終わり</div>
	</div>
</div>
<h3 class="date">2022年10月17日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f1c2f3cca27c834a18e455680da1d6fc').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f1c2f3cca27c834a18e455680da1d6fc').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f1c2f3cca27c834a18e455680da1d6fc" href="#permalink_f1c2f3cca27c834a18e455680da1d6fc" class="permalink">¶</a>
		<div class="content"></div>
		<div class="content">えーと次にやるべきは……『<a href="https://www.sigbus.info/compilerbook#%E3%82%B9%E3%83%86%E3%83%83%E3%83%973%E3%83%88%E3%83%BC%E3%82%AF%E3%83%8A%E3%82%A4%E3%82%B6%E3%82%92%E5%B0%8E%E5%85%A5">ステップ3：トークナイザを導入</a>』か。すぐ終わりそう</div>
		<div class="content">check 2 &quot;5 - 3&quot; を走らせ、テストが無事落ちることを確認。</div>
		<div class="content">トークナイザをサクッと書いて、挿げ替えて、テストが通ることを確認。</div>
	</div>
</div>
<h3 class="date">2022年10月27日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0314cf3f3f5e8aba97d25eccf9be3133').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0314cf3f3f5e8aba97d25eccf9be3133').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_0314cf3f3f5e8aba97d25eccf9be3133" href="#permalink_0314cf3f3f5e8aba97d25eccf9be3133" class="permalink">¶</a>
		<div class="content">エラーメッセージを改善するだけ</div>
		<div class="content">エラー型を定義して関数分割して実装。分岐を少なくするためにtokenにeofを追加</div>
	</div>
</div>
<h3 class="date">2022年10月29日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cb79ec7e5c13f1a1980fe29388b12e53').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cb79ec7e5c13f1a1980fe29388b12e53').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_cb79ec7e5c13f1a1980fe29388b12e53" href="#permalink_cb79ec7e5c13f1a1980fe29388b12e53" class="permalink">¶</a>
		<div class="content">tkr からプルリクが来ておる。コードを読んだ。なるほどね。マージ</div>
	</div>
</div>
<h3 class="date">2022年10月29日（Discord にて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e859820effc6566b471cfcfca220cadd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e859820effc6566b471cfcfca220cadd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e859820effc6566b471cfcfca220cadd" href="#permalink_e859820effc6566b471cfcfca220cadd" class="permalink">¶</a>
		<div class="content">とまあこういうことをやってるんですよ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer"><img alt="hiromi_mi" class="icon" src="icons/hiromi_mi.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cf1df300e9c18d4fddd307a8e9b97757').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cf1df300e9c18d4fddd307a8e9b97757').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer">hiromi_mi</a></span><a id="permalink_cf1df300e9c18d4fddd307a8e9b97757" href="#permalink_cf1df300e9c18d4fddd307a8e9b97757" class="permalink">¶</a>
		<div class="content">おもしろかったです、ushitora_anqouと違ってELFファイルを出力できるような状態をたもちつつ拡張するなど、アイデアに一本取られました</div>
		<div class="content">LEB128 はこれですね <a href="https://ja.osdn.net/projects/drdeamon64/wiki/LEB128%E3%81%AA%E6%95%B0%E3%81%AE%E8%A1%A8%E7%8F%BE" target="_blank" rel="noopener noreferrer">https://ja.osdn.net/projects/drdeamon64/wiki/LEB128%E3%81%AA%E6%95%B0%E3%81%AE%E8%A1%A8%E7%8F%BE</a> </div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0bfa2d49560c30d5588d81f60e09e182').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0bfa2d49560c30d5588d81f60e09e182').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_0bfa2d49560c30d5588d81f60e09e182" href="#permalink_0bfa2d49560c30d5588d81f60e09e182" class="permalink">¶</a>
		<div class="content">ふむふむ。わりと自然な発想のエンコーディングですね</div>
	</div>
</div>
<h3 class="date">2022年10月29日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8f33bc9708a4a396fb603b7896001e84').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8f33bc9708a4a396fb603b7896001e84').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8f33bc9708a4a396fb603b7896001e84" href="#permalink_8f33bc9708a4a396fb603b7896001e84" class="permalink">¶</a>
		<div class="content">さてやっていこう。compilerbook のステップ 5 には</div>
		<blockquote>説明の都合上、一気に*、/、()を実装しているような話の流れになっていますが、実際には一気に実装することは避ける方がよいでしょう。
元々、加減算ができる機能があったわけですから、まずはその機能を壊さずに、抽象構文木とそれを使ったコードジェネレータを導入するようにしてみてください。
そのときには新たな機能を足すわけではないので、新しいテストは必要ありません。その後に、*、/、()を、テスト込みで実装していってください。
</blockquote>
		<div class="content">と書いてあるので、まずは抽象構文木を導入すべきなんだな</div>
		<div class="content">まずは clippy の pedantic でも足して、</div>
		<div class="content">あとそろそろ tokenize を別ファイルに分離するか</div>
		<div class="content">apperror.rs と tokenize.rs を分離</div>
	</div>
</div>
<h3 class="date">2022年10月30日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1c655b71d5d85463db69d6f591b175bb').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1c655b71d5d85463db69d6f591b175bb').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1c655b71d5d85463db69d6f591b175bb" href="#permalink_1c655b71d5d85463db69d6f591b175bb" class="permalink">¶</a>
		<div class="content">そして抽象構文木を導入</div>
		<div class="content">さて、コードジェネレーターでこれを使わなきゃいけないんだよな</div>
	</div>
</div>
<h3 class="date">2022年10月30日（Discord にて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ea3cf2e058f8392a7b8eb2baaedbaab2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ea3cf2e058f8392a7b8eb2baaedbaab2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_ea3cf2e058f8392a7b8eb2baaedbaab2" href="#permalink_ea3cf2e058f8392a7b8eb2baaedbaab2" class="permalink">¶</a>
		<div class="content">とまあこういうことをやっています</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/ikubaku10" target="_blank" rel="noopener noreferrer"><img alt="ikubaku" class="icon" src="icons/ikubaku.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7c3f3ecc1b31296179b0b264dfccb0ca').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7c3f3ecc1b31296179b0b264dfccb0ca').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/ikubaku10" target="_blank" rel="noopener noreferrer">ikubaku</a></span><a id="permalink_7c3f3ecc1b31296179b0b264dfccb0ca" href="#permalink_7c3f3ecc1b31296179b0b264dfccb0ca" class="permalink">¶</a>
		<div class="content">実行形式の中でも ELF にしてるのってどういう理由です？ELF はそれなりに複雑であり、難易度が上がる気がしていますけど</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1b1f4ef9eddfccd5f59c04bb367d3789').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1b1f4ef9eddfccd5f59c04bb367d3789').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1b1f4ef9eddfccd5f59c04bb367d3789" href="#permalink_1b1f4ef9eddfccd5f59c04bb367d3789" class="permalink">¶</a>
		<div class="content">一番ポピュラーであり、私の WSL 環境で動くからです。あと、その複雑さを上手く回避する小技を導入しています（step 1 をどう実装したかを見せる）</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer"><img alt="hiromi_mi" class="icon" src="icons/hiromi_mi.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4977d1186cc476a2c0af300da656df3b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4977d1186cc476a2c0af300da656df3b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer">hiromi_mi</a></span><a id="permalink_4977d1186cc476a2c0af300da656df3b" href="#permalink_4977d1186cc476a2c0af300da656df3b" class="permalink">¶</a>
		<div class="content">最近の Linux では a.out フォーマットのサポートが消えたので、ELF を選択するという判断は妥当そうに思えます。Windows の com も今はダメですし</div>
	</div>
</div>
<h3 class="date">2022年10月30日（コードジェネレーター）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3043e58678ee7f4aa7cc4eb0e01f71f0').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3043e58678ee7f4aa7cc4eb0e01f71f0').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3043e58678ee7f4aa7cc4eb0e01f71f0" href="#permalink_3043e58678ee7f4aa7cc4eb0e01f71f0" class="permalink">¶</a>
		<div class="content">抽象構文木を導入したことにより、許容される式の自由度が真に上がったので、コードジェネレーターを書き換えねばならない。</div>
		<div class="content">……よな？ここをちゃんと確認しないと『必要最低限のみを調べる』という縛りに抵触してしまう。</div>
		<div class="content">うむ、一方向にのみ伸びているとは限らない木を処理できるようにするには、スタックマシンの仕組みを導入しないと無理ですな</div>
		<div class="content">えーと tkr の書いたバイナリ表現を読まないとリファクタリングできない。よって調べる</div>
		<div class="content"><a href="https://defuse.ca/online-x86-assembler.htm" target="_blank" rel="noopener noreferrer">https://defuse.ca/online-x86-assembler.htm</a> に投げたところ、bf ** 00 00 00 は edi レジスタに ** をセットするらしい。じゃあ 83 c7 ** は edi を増やして 83 ef ** は edi を減らすのでしょう</div>
		<div class="content">とはいえ、我々は「なるべくアセンブリ言語について知らないようにしている」という設定なので、これに mov とか add とか名前を付けるのでは面白くない</div>
		<div class="content">せっかく Rust が識別子に日本語を許すようになったのだし、『edi増加』『edi減少』とかの関数名にしてしまえ</div>
		<div class="content">えーと、スタックマシンにする必要がある。そのためにはどのような機械語が必要だろうか。レジスタとメモリの間で色々移動させる必要がありそうだな</div>
		<div class="content">『即値をスタックにpush』『レジスタをスタックにpush』『スタックからレジスタへとpop』『レジスタの中身を、別のレジスタに足し合わせる』があればいい</div>
		<div class="content">tkr が既に「6a 01 (push $0x01)」「5f (pop %edi)」というのを調べてくれている。えーと、</div>
		<blockquote>☑ 即値をプッシュ 
☒ ediをプッシュ
☑ ediへとポップ
☒ eaxへとポップ
☒ ediにeaxを足し合わせる
☒ ediからeaxを減じる
</blockquote>
		<div class="content">ということで、あとは残り 4 つを調べればよい</div>
		<pre><code class="language-rust">fn 即値をプッシュ(n: u8) -&gt; [u8; 2] {
    [0x6a, n]
}

fn ediをプッシュ() -&gt; [u8; 1] {
    [0x57]
}

fn ediへとポップ() -&gt; [u8; 1] {
    [0x5f]
}

fn eaxへとポップ() -&gt; [u8; 1] {
    [0x58]
}

fn ediにeaxを足し合わせる() -&gt; [u8; 2] {
    [0x01, 0xc7]
}

fn ediからeaxを減じる() -&gt; [u8; 2] {
    [0x29, 0xc7]
}
</code></pre>
		<div class="content">あとはこれらを組み合わせれば動くはず。これでいいかな</div>
		<pre><code class="language-rust">fn exprを評価してediレジスタへ(writer: &amp;mut impl Write, expr: &amp;Expr) {
    match expr {
        Expr::BinaryExpr {
            op: BinaryOp::Add,
            op_pos: _,
            左辺,
            右辺,
        } =&gt; {
            exprを評価してediレジスタへ(writer, 左辺);
            writer.write_all(&amp;ediをプッシュ()).unwrap();
            exprを評価してediレジスタへ(writer, 右辺);
            writer.write_all(&amp;ediをプッシュ()).unwrap();
            writer.write_all(&amp;eaxへとポップ()).unwrap();
            writer.write_all(&amp;ediへとポップ()).unwrap();
            writer.write_all(&amp;ediにeaxを足し合わせる()).unwrap();
        }
        Expr::BinaryExpr {
            op: BinaryOp::Sub,
            op_pos: _,
            左辺,
            右辺,
        } =&gt; {
            exprを評価してediレジスタへ(writer, 左辺);
            writer.write_all(&amp;ediをプッシュ()).unwrap();
            exprを評価してediレジスタへ(writer, 右辺);
            writer.write_all(&amp;ediをプッシュ()).unwrap();
            writer.write_all(&amp;eaxへとポップ()).unwrap();
            writer.write_all(&amp;ediへとポップ()).unwrap();
            writer.write_all(&amp;ediからeaxを減じる()).unwrap();
        }
        Expr::Primary { val, pos: _ } =&gt; {
            writer.write_all(&amp;ediに代入(*val)).unwrap();
        }
    }
}

fn parse_and_codegen(
    mut writer: &amp;mut impl Write,
    tokens: &amp;[Token],
    input: &amp;str,
) -&gt; Result&lt;(), AppError&gt; {
    let expr = parse(tokens, input)?;

    let tiny = include_bytes!(&quot;../experiment/tiny&quot;);
    writer.write_all(&amp;tiny[0..0x78]).unwrap();
    writer.write_all(&amp;[0xb8, 0x3c, 0x00, 0x00, 0x00]).unwrap();

    exprを評価してediレジスタへ(&amp;mut writer, &amp;expr);

    writer.write_all(&amp;[0x0f, 0x05]).unwrap();
    Ok(())
}
</code></pre>
		<div class="content">走らせてみよう</div>
		<pre><code class="language-">[FAIL] 1+2 =&gt; 3 expected, but got 139
</code></pre>
		<div class="content">なるほど落ちる。あー、多分 eax レジスタをなんか別ので使ってるんだろうな。0xb8, 0x3c, 0x00, 0x00, 0x00 辺りかな</div>
		<div class="content">じゃあそれを『exprを評価してediレジスタへ』より後ろに回すと……動いた。</div>
	</div>
</div>
<h3 class="date">2022年10月30日（乗算）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1b28c8027b05825cacf886323884e99a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1b28c8027b05825cacf886323884e99a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1b28c8027b05825cacf886323884e99a" href="#permalink_1b28c8027b05825cacf886323884e99a" class="permalink">¶</a>
		<div class="content">次は乗算を組んでいこう。まず構文木に BinaryOp::Mul を加える。対応するバイナリ表現も調べる</div>
		<pre><code class="language-rust">fn ediをeax倍にする() -&gt; [u8; 3] {
    [0x0f, 0xaf, 0xf8]
}
</code></pre>
		<div class="content">次に、再帰下降パーサにする。前に自分で書いた Rust での再帰下降を眺めよう</div>
		<div class="content"><a href="https://docs.google.com/presentation/d/180pyDEMnBUPVIsQuNYgbdD0oWB-vZdzoJR4md_yEYRQ/edit#slide=id.g1339727b6e0_0_237" target="_blank" rel="noopener noreferrer">https://docs.google.com/presentation/d/180pyDEMnBUPVIsQuNYgbdD0oWB-vZdzoJR4md_yEYRQ/edit#slide=id.g1339727b6e0_0_237</a></div>
		<div class="content">再帰下降パーサというのは、『読めるところまで読み、それ以外は読み残す』という挙動をする部品を組み合わせることで上手くいく</div>
		<div class="content">ということで、とりあえずイテレータを取るような関数へと変更。peekable もほしいかな</div>
		<div class="content">そして parse_multiplicative 関数を実装し、parse の中ではそれを呼ぶようにする</div>
		<div class="content">さて 3*4-5 が動くかな？おっと Mac ではそもそもどのテストケースも通らない。WSL で試すか</div>
		<div class="content">ああ普通に 1+2 が落ちてる。それはそうで、せっかく peekable にしたのに peek していない</div>
		<div class="content">peekするようにすると……おっと『演算子かeofが期待されていますが、数か * が来ました』と言われる。ああここも peek にしないとね。あと第一式も parse_multiplicative にしないと</div>
		<div class="content">修正したら通った。&quot;9 *8  - 7*  6 + 5*  4*1&quot; とかも通りますね</div>
		<div class="content">次はカッコを実装しよう。そのためには、</div>
		<div class="content"><ul><li>数値リテラルを読むところを parse_primary 関数に切り出す</li><li>『全部読めていない場合に落とす』の部分を parse 関数から切り出す</li><li>カッコで括った式を primary と見なす</li></ul></div>
		<div class="content">という変更を加えることになる。とりあえず最初の二つをやり、テストが通ることを確認</div>
		<div class="content">次はトークナイザへのカッコの追加だ。正直 paren, sqbracket, brace とかより『開き丸括弧』の方が読みやすくない？バンバン日本語識別子を使っていこう</div>
		<div class="content">そうしたら parse_primary の中で parse_additive を呼んでやって、テストを書く</div>
		<div class="content">えーと &quot;5*(6-3)*7&quot; が「演算子の次に来ているものが数値ではありません」で落ちる</div>
		<div class="content">ああ、parse_multicative の右辺の方を parse_primary にしていなかったな。直した。テストが通る</div>
		<div class="content">残るは除算の実装だけ。これ面倒なんだよな。compilerbook にはこう書いてある</div>
		<blockquote>特にパースやコード生成において重要なポイントではないのですが、トリッキーな仕様のidiv命令が上のコードでは使われているので、それについて説明しておきましょう。

idivは符号あり除算を行う命令です。x86-64のidivが素直な仕様になっていれば、上のコードでは本来idiv rax, rdiのように書きたかったところですが、そのような2つのレジスタをとる除算命令はx86-64には存在しません。その代わりに、idivは暗黙のうちにRDXとRAXを取って、それを合わせたものを128ビット整数とみなして、それを引数のレジスタの64ビットの値で割り、商をRAXに、余りをRDXにセットする、という仕様になっています。cqo命令を使うと、RAXに入っている64ビットの値を128ビットに伸ばしてRDXとRAXにセットすることができるので、上記のコードではidivを呼ぶ前にcqoを呼んでいます。
</blockquote>
		<div class="content">ということで、足すべきは以下の通り</div>
		<pre><code class="language-rust">fn eaxの符号ビットをedxへ拡張() -&gt; [u8; 1] {
    [0x99]
}

fn edx_eaxをediで割る_商はeaxに_余りはedxに() -&gt; [u8; 2] {
    [0xf7, 0xff]
}

fn eaxをプッシュ() -&gt; [u8; 1] {
    [0x50]
}
</code></pre>
		<div class="content">テストケースも足したし、これで『ステップ5：四則演算のできる言語の作成』が完了</div>
	</div>
</div>
<h3 class="date">2022年10月31日（Discordにて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ca831b8a56a7c365a365176b1a395618').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ca831b8a56a7c365a365176b1a395618').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_ca831b8a56a7c365a365176b1a395618" href="#permalink_ca831b8a56a7c365a365176b1a395618" class="permalink">¶</a>
		<div class="content">コードレビューお願いします</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fadde74faef94ad4b48c034a1156818b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fadde74faef94ad4b48c034a1156818b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_fadde74faef94ad4b48c034a1156818b" href="#permalink_fadde74faef94ad4b48c034a1156818b" class="permalink">¶</a>
		<div class="content">diff がでかくて見るのが大変で放置してた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3ae073460abb79cdc6419b3f5e23433c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3ae073460abb79cdc6419b3f5e23433c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3ae073460abb79cdc6419b3f5e23433c" href="#permalink_3ae073460abb79cdc6419b3f5e23433c" class="permalink">¶</a>
		<div class="content">まあ再帰下降にする過程で全部書き直す羽目になりますからねぇ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_254d1ad01548c243fe4c97615b7e2486').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_254d1ad01548c243fe4c97615b7e2486').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_254d1ad01548c243fe4c97615b7e2486" href="#permalink_254d1ad01548c243fe4c97615b7e2486" class="permalink">¶</a>
		<div class="content">わかるなぁ</div>
		<div class="content">そういえば、ログのページを生成するのも CI にしたい。えーと今は master ブランチの上の GitHub Pages を直に公開してるのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3cd63bac44e2773ac5eba6c3a59aec4d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3cd63bac44e2773ac5eba6c3a59aec4d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3cd63bac44e2773ac5eba6c3a59aec4d" href="#permalink_3cd63bac44e2773ac5eba6c3a59aec4d" class="permalink">¶</a>
		<div class="content">じゃあ step 8 の代わりに CI の整備とかお願いしていいですかね。本来の step 8 はコンパイラのソースコードをファイル分割して Makefile をセットアップするプロセスなんですけど、Rust で書いている我々にとっては既にそれは解決されているので</div>
	</div>
</div>
<h3 class="date">2022年10月31日（GitHubにて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_eb926e9e0618b979e705a25a46220017').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_eb926e9e0618b979e705a25a46220017').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_eb926e9e0618b979e705a25a46220017" href="#permalink_eb926e9e0618b979e705a25a46220017" class="permalink">¶</a>
		<div class="content">これposどこにするか迷う 🤔</div>
		<div class="content">エラーメッセージ的にはここが正しそうだけど「unexpected token」的なエラーメッセージとどっちが分かりやすいんだろう</div>
		<pre><code class="language-rust">                _ =&gt; Err(AppError {
                    message: &quot;この開き丸括弧に対応する閉じ丸括弧がありません&quot;.to_string(),
                    input: input.to_string(),
                    pos: *pos,
</code></pre>
		<div class="content">というのが気になったけど、大体よさそう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_623da2754d9a13aa2e732b9dc394497b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_623da2754d9a13aa2e732b9dc394497b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_623da2754d9a13aa2e732b9dc394497b" href="#permalink_623da2754d9a13aa2e732b9dc394497b" class="permalink">¶</a>
		<div class="content">まあ理想的には Rust みたいに「範囲」でエラーを持つ方がきれいですよね。まあ Rui 本はあんまりエラーに凝らない設計なので、あんま深く考えなくていいでしょう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_440e5c364874e021496b2b407cacaeed').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_440e5c364874e021496b2b407cacaeed').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_440e5c364874e021496b2b407cacaeed" href="#permalink_440e5c364874e021496b2b407cacaeed" class="permalink">¶</a>
		<div class="content">あとは Peekable 使うかスライス使うかとか迷うなぁ</div>
		<div class="content">パーサのファイル分割とかはstep8？でやるかー</div>
	</div>
</div>
<h3 class="date">2022年11月7日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_83d515068a98112f517a67f012288f3d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_83d515068a98112f517a67f012288f3d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_83d515068a98112f517a67f012288f3d" href="#permalink_83d515068a98112f517a67f012288f3d" class="permalink">¶</a>
		<div class="content">そろそろやらなければ</div>
		<div class="content">単項演算子の実装はパーサー少し変更するだけっぽいので一瞬で終わった</div>
		<div class="content">色々テスト書いて終わり</div>
		<div class="content">今後 &#x60;-&quot;x&quot;&#x60; みたいな型エラー発生するコードを書いたときにエラーメッセージが微妙に分かりにくくなるのが気になるが</div>
	</div>
</div>
<h3 class="date">2022年11月9日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e03f7074bd5561684ee5a00d3b3d9580').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e03f7074bd5561684ee5a00d3b3d9580').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e03f7074bd5561684ee5a00d3b3d9580" href="#permalink_e03f7074bd5561684ee5a00d3b3d9580" class="permalink">¶</a>
		<div class="content">やるぞ</div>
		<div class="content">比較演算子を実装。ここら辺は本当にやるだけだな</div>
		<div class="content">関数が長くなりすぎて clippy が文句を言ってきているな。でもこれ過剰に分割しても読みやすくならないだろうし、#[allow(clippy::too_many_lines)] でお茶を濁そう</div>
	</div>
</div>
<h3 class="date">2022年11月10日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_851228c2ce77ea9f2b04f90377355ba2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_851228c2ce77ea9f2b04f90377355ba2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_851228c2ce77ea9f2b04f90377355ba2" href="#permalink_851228c2ce77ea9f2b04f90377355ba2" class="permalink">¶</a>
		<div class="content">CIの整備をします</div>
		<div class="content">github pagesの設定を修正してactionsからのアップロードみたいなのに変更する必要があるけど権限ないのでお願いします</div>
		<div class="content">やったことはコミットメッセージに</div>
	</div>
</div>
<h3 class="date">2022年11月11日（CIの修正）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1191af1a99124606724e61679c923bb2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1191af1a99124606724e61679c923bb2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1191af1a99124606724e61679c923bb2" href="#permalink_1191af1a99124606724e61679c923bb2" class="permalink">¶</a>
		<div class="content">tkr からプルリクが来ておるな</div>
		<div class="content">CIの整備と、ファイル分割がされている。ありがたい。まずマージして、</div>
		<div class="content">設定を変更して、えっと</div>
		<div class="content">あーあれか、マージしてから設定を変更したせいで、この版まではデフォルトのgithub-pages アクションに基づいて生成されているのか</div>
		<div class="content">じゃあ、もう一回コミットしたら tkr の書いた GitHub Action が走ってくれる？</div>
		<div class="content">んー、Workflow details will appear here once your site has been deployed. と言われる</div>
		<div class="content">Your site was last deployed to the github-pages environment by the pages build and deployment workflow. とのことだから、設定できてないな</div>
		<div class="content"><a href="https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site" target="_blank" rel="noopener noreferrer">https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site</a> 曰く、</div>
		<blockquote>If you already have a workflow to publish your site, you can skip this step. 

GitHub Pages does not associate a specific workflow to the GitHub Pages settings. However, the GitHub Pages settings will link to the workflow run that most recently deployed your site.
</blockquote>
		<div class="content">とのこと。つまり、Source: GitHub Actions とだけ出てそれ以上設定する画面がないという現状で問題ないっぽい</div>
		<div class="content">次に、<a href="https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site#creating-a-custom-github-actions-workflow-to-publish-your-site" target="_blank" rel="noopener noreferrer">https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site#creating-a-custom-github-actions-workflow-to-publish-your-site</a> を見ると、</div>
		<blockquote>The general flow of a workflow is to:

1. Trigger whenever there is a push to the default branch of the repository or whenever the workflow is run manually from the Actions tab.

2. Use the actions/checkout action to check out the repository contents.
    
3. If required by your site, build any static site files.

4. Use the actions/upload-pages-artifact action to upload the static files as an artifact.
    
5. If the workflow was triggered by a push to the default branch, use the actions/deploy-pages action to deploy the artifact. This step is skipped if the workflow was triggered by a pull request.
</blockquote>
		<div class="content">と書いてある。tkr の書いてくれた workflows/docs.yaml には actions/checkout と actions/upload-pages-artifact が言及されている</div>
		<div class="content">ふむ、The starter workflows use a deployment environment called github-pages. If your repository does not already include an environment called github-pages, the environment will be created automatically. と書いてある。名前を変えてみるか</div>
		<div class="content">うまくいかない。 actions/deploy-pages action を足してみるか</div>
		<div class="content">CI が落ちた。<a href="https://github.com/sozysozbot/c_to_elf_compiler/actions/runs/3438529083/jobs/5734705044" target="_blank" rel="noopener noreferrer">https://github.com/sozysozbot/c_to_elf_compiler/actions/runs/3438529083/jobs/5734705044</a> </div>
		<blockquote>Error: Error message: Unable to get ACTIONS_ID_TOKEN_REQUEST_URL env variable
    at Function.&lt;anonymous&gt; (/home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/oidc-utils.js:71:1)
    at Generator.next (&lt;anonymous&gt;)
    at /home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/oidc-utils.js:8:1
    at new Promise (&lt;anonymous&gt;)
    at __webpack_modules__.8041.__awaiter (/home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/oidc-utils.js:4:1)
    at Function.getIDToken (/home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/oidc-utils.js:57:1)
    at Object.&lt;anonymous&gt; (/home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/core.js:315:1)
    at Generator.next (&lt;anonymous&gt;)
    at /home/runner/work/_actions/actions/deploy-pages/v1/webpack:/deploy-pages/node_modules/@actions/core/lib/core.js:27:1
    at new Promise (&lt;anonymous&gt;)
Error: Ensure GITHUB_TOKEN has permission &quot;idToken: write&quot;.
</blockquote>
		<div class="content">うーむ。とりあえず上手くいっていないので、せっかくバージョン管理されていることだし、上手くいっていたところまで強引に世界を差し戻すか？</div>
		<div class="content">いや、<a href="https://github.com/jurliyuuri/cerke_online_alpha/blob/master/.github/workflows/deploy.yml" target="_blank" rel="noopener noreferrer">https://github.com/jurliyuuri/cerke_online_alpha/blob/master/.github/workflows/deploy.yml</a> のを転用して、gh-pages ブランチからページを生やすようにしよう</div>
		<div class="content">えーと、<a href="https://github.com/sozysozbot/c_to_elf_compiler/actions/runs/3438695080/workflow" target="_blank" rel="noopener noreferrer">https://github.com/sozysozbot/c_to_elf_compiler/actions/runs/3438695080/workflow</a> 曰く、</div>
		<blockquote>The workflow is not valid. .github/workflows/docs.yaml (Line: 35, Col: 14): Unexpected value &#x27;&#x27; .github/workflows/docs.yaml (Line: 36, Col: 9): Unexpected value &#x27;github_token&#x27;
</blockquote>
		<div class="content">それはそう。え、でも cerke_online_alpha には secret が設定されていないと書いてあるけど</div>
		<div class="content"><a href="https://github.com/peaceiris/actions-gh-pages" target="_blank" rel="noopener noreferrer">https://github.com/peaceiris/actions-gh-pages</a> 曰く、</div>
		<blockquote>For newbies of GitHub Actions: Note that the GITHUB_TOKEN is NOT a personal access token. A GitHub Actions runner automatically creates a GITHUB_TOKEN secret to authenticate in your workflow. So, you can start to deploy immediately without any configuration.
</blockquote>
		<div class="content">あ、そうなの。じゃあなんで落ちてるんだろうか</div>
		<div class="content"><a href="https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-first-deployment-with-github_token" target="_blank" rel="noopener noreferrer">https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-first-deployment-with-github_token</a> を読む。なるほど、初回は失敗することが想定されているのか。へー</div>
		<div class="content">とりあえず git checkout --orphan gh-pages をして push することで gh-pages ブランチを作るか</div>
		<div class="content">えーとインデントが壊れている。直そう</div>
		<div class="content">ジョブは走っているが、ページが出力されない。.nojekyll ってファイルだけが生えておる</div>
		<div class="content">ああ、publish_dir がミスってるのか</div>
		<div class="content">直したら直った！URL も今までと変わらず提供できている。勝利ですね。リポジトリの README も直しておくか</div>
	</div>
</div>
<h3 class="date">2022年11月11日（一文字変数）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_874905eba43503712b5fd73718fe67dc').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_874905eba43503712b5fd73718fe67dc').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_874905eba43503712b5fd73718fe67dc" href="#permalink_874905eba43503712b5fd73718fe67dc" class="permalink">¶</a>
		<div class="content">さて、次は複文と一文字変数</div>
		<div class="content">そういえば、compilerbook では『一番最後の式の結果をプログラム全体の計算結果とすることにします』として、構文定義がこうなってるけど、</div>
		<blockquote>program    = stmt*
stmt       = expr &quot;;&quot;
expr       = assign
assign     = equality (&quot;=&quot; assign)?
equality   = relational (&quot;==&quot; relational | &quot;!=&quot; relational)*
relational = add (&quot;&lt;&quot; add | &quot;&lt;=&quot; add | &quot;&gt;&quot; add | &quot;&gt;=&quot; add)*
add        = mul (&quot;+&quot; mul | &quot;-&quot; mul)*
mul        = unary (&quot;*&quot; unary | &quot;/&quot; unary)*
unary      = (&quot;+&quot; | &quot;-&quot;)? primary
primary    = num | ident | &quot;(&quot; expr &quot;)&quot;
</blockquote>
		<div class="content">このプロジェクトは Rust で書いてるんだし、Rust と同様に『文の列の最後に式を書くと、それが戻り値になる』で組もうかな</div>
		<div class="content">こうすることの利点としては、</div>
		<div class="content"><ul><li>今までのテストケースに手を入れなくて済む</li><li>スタック操作をミスってバグが出たときに、より早期に気づきやすい（Cコンパイラ班の受講生で、ここの周りで混乱してバグらせた人を見た）</li><li>実はセミコロンを中置演算子として見ることができ、既存の再帰下降のコピペで実装が終わる</li></ul></div>
		<div class="content">などが挙げられそう</div>
		<div class="content">ところで、関係ないけど、このログを生成する自作ツール PseudoRoku に箇条書き機能欲しくなってきたな。$HTML コマンドに &lt;ul&gt; を食わせて1行ずつで書かなきゃいけないのが面倒になってきた</div>
		<div class="content">さて、とりあえずトークナイザに一文字変数を足さねば。あと Assign 演算子も足そう。右結合だから、ループにせずとも再帰で十分</div>
		<div class="content">いや、まずは最小限の変更で動かしたいから、最初はセミコロンだけだな。AndThenという二項演算子として処理して、</div>
		<pre><code class="language-rust">        Expr::BinaryExpr {
            op: BinaryOp::AndThen,
            op_pos: _,
            左辺,
            右辺,
        } =&gt; {
            exprを評価してediレジスタへ(writer, 左辺); // 左辺は push せずに捨てる
            exprを評価してediレジスタへ(writer, 右辺);
        }
</code></pre>
		<div class="content">これだけで動くはず。便利</div>
		<div class="content">次に、一文字変数と代入が必要。&#x27;a&#x27; から &#x27;z&#x27; および &#x27;=&#x27; をトークナイズし、パーサーを増やす。parse_primary で識別子を読むコードも必要</div>
		<div class="content">あとはコード生成を書くだけ。今回の実装では return しないので、エピローグは不要で、プロローグで変数 26 個分の領域を確保すれば十分</div>
		<div class="content">おや、パースが通らない。なるほど、再帰下降のコピペミスか。直した。しかし Mac だとテストケースごとに docker run するから遅いな。しょうがないけど</div>
		<div class="content">直したらパースが通るようになったが、&#x60;a = 3; b = 4; a + b&#x60; で &#x60;7 expected, but got 139&#x60; が出ている。なんかミスっておるな</div>
		<div class="content">&#x60;a = 7; a&#x60; でも同じ。ところで、この手のミスをすると毎回 139 が来る気がするけど、これなんなんだろう</div>
		<div class="content">あーわかった。コメントアウトしてた『ediから即値を引く』関数をそのまま使ってたけど、これは『edi から即値を引く』から、rdi の上位 32 ビットがクリアされちゃってるんだな</div>
		<div class="content">ということで、</div>
		<pre><code class="language-rust">fn rdiから即値を引く(n: u8) -&gt; [u8; 4] {
    [0x48, 0x83, 0xef, n]
}
</code></pre>
		<div class="content">にしたら……動いた！</div>
		<div class="content">今までは意図的に 32 ビットレジスタと 64 ビットレジスタを混同するような書き方をしてきたけど、そろそろちゃんと分ける必要が出てきますわね</div>
		<div class="content">あ、CI で cargo fmt が要求されてる。掛けておくか</div>
		<div class="content">そういえば、せっかく &#x60;a = b = 7&#x60; みたいなやつに対応してあるんだから、テストケースに足しておこう</div>
	</div>
</div>
<h3 class="date">2022年11月21日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7a3da0f0db1edd3974e41bdb1909e8b4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7a3da0f0db1edd3974e41bdb1909e8b4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7a3da0f0db1edd3974e41bdb1909e8b4" href="#permalink_7a3da0f0db1edd3974e41bdb1909e8b4" class="permalink">¶</a>
		<div class="content">そういやこの 139 ってなんなんですかね。SIGSEGV のシグナル自体は 139 ではなかった気がするんですけど</div>
		<div class="content">あー、シグナルが 11 で exit code が 139 か</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer"><img alt="hiromi_mi" class="icon" src="icons/hiromi_mi.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7be1a50a776247fcbc68f5ec6317c574').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7be1a50a776247fcbc68f5ec6317c574').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_hiromi_mi" target="_blank" rel="noopener noreferrer">hiromi_mi</a></span><a id="permalink_7be1a50a776247fcbc68f5ec6317c574" href="#permalink_7be1a50a776247fcbc68f5ec6317c574" class="permalink">¶</a>
		<div class="content">『なんらかの異常値である』必要はそりゃあると思いますけど、具体的になんで 139 なんですかね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7bef5bd2a3692070fa6b5ea724c7de8a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7bef5bd2a3692070fa6b5ea724c7de8a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7bef5bd2a3692070fa6b5ea724c7de8a" href="#permalink_7bef5bd2a3692070fa6b5ea724c7de8a" class="permalink">¶</a>
		<div class="content">あ、128 + 11 ってことなのかな</div>
	</div>
</div>
<h3 class="date">2022年11月24日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_eff0c80e74d6e2ed5114532412a45ef8').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_eff0c80e74d6e2ed5114532412a45ef8').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_eff0c80e74d6e2ed5114532412a45ef8" href="#permalink_eff0c80e74d6e2ed5114532412a45ef8" class="permalink">¶</a>
		<div class="content">複数文字のローカル変数</div>
		<div class="content">Rustなので &#x60;HashMap&#x60; 使ってまあ適当に</div>
		<div class="content">変数にアンダースコアとか数値も使えるように</div>
		<div class="content">ローカル変数情報のバケツリレーつらいからそろそろcodegenをstructにしてもいいかもな</div>
		<div class="content">compilerbookだとこのステップ終わっても26個しか変数使えなくない？この制限解除しようとすると &#x60;rspから即値を引く&#x60; の段階では変数の数決まらないからきついな。とりあえず &#x60;Write + Seek&#x60; にするか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0989c89f653118769f1d4cbd4eacbe70').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0989c89f653118769f1d4cbd4eacbe70').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_0989c89f653118769f1d4cbd4eacbe70" href="#permalink_0989c89f653118769f1d4cbd4eacbe70" class="permalink">¶</a>
		<div class="content">tkr からのプルリクを読みます</div>
		<div class="content">読んだ。マージした。</div>
		<div class="content">さて、今回は return 文なわけで、これによって既存のテストケースを変更する必要がある</div>
		<pre><code class="language-diff">-   a = b = 7; a 
+   a = b = 7; return a;
</code></pre>
		<div class="content">みたいな変更を全部に入れる必要があり、とりあえずそれのコンパイルを通す必要がある</div>
		<div class="content">まあ、とりあえずは return キーワードをトークナイザに足すところからですな</div>
		<div class="content">一瞬で足せた。payload をすり替えるだけだな。で、次にパーサーに手を加える必要がある。今まではセミコロンを 2 項演算子として扱っていたので、それを修正する必要がある</div>
		<div class="content">まず、Expr と Program を分離していく。定義を複製してすり替えることで、とりあえず動くものを作る</div>
		<div class="content">次に、Statement 型を立てていく。parse_statement を立て、それの繰り返しにより parse_program を定義する。Program は Vec&lt;Statement&gt; とする</div>
		<div class="content">えーっと、今回は return してるわけじゃないんだよな。とはいえ syscall したら帰ってこないから、普通にエピローグを出力すればいいのか</div>
		<div class="content">これはテストケースにもう return を足して、return 文も実装してしまおう</div>
		<div class="content">えーと通らない。『数値リテラルでも開き丸括弧でもないものが来ました』というメッセージ。多分再帰下降のどこかで「エラーを出さずにスルー」を忘れている</div>
		<div class="content">いや違うな。eof トークンがあるから while tokens.peek().is_some() ではダメなんだ。</div>
		<div class="content">直したら動いた</div>
		<div class="content">よしプルリクエストを作成。あ、テストケースを増やした方がいいな</div>
	</div>
</div>
<h3 class="date">2022年12月3日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f88cdba870ca7e94245dcc780e85f92c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f88cdba870ca7e94245dcc780e85f92c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_f88cdba870ca7e94245dcc780e85f92c" href="#permalink_f88cdba870ca7e94245dcc780e85f92c" class="permalink">¶</a>
		<div class="content">とりあえずトークナイザ実装</div>
		<div class="content">jmp/jeのバイナリ表現を調べたら0xEB バイト数/0x74 バイト数であることが分かった。前方ジャンプは負の数かつジャンプ命令自体のサイズを含むので-2となることに注意。</div>
	</div>
</div>
<h3 class="date">2022年12月4日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1773a208b83b6508a36fcd13aba1c908').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1773a208b83b6508a36fcd13aba1c908').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1773a208b83b6508a36fcd13aba1c908" href="#permalink_1773a208b83b6508a36fcd13aba1c908" class="permalink">¶</a>
		<div class="content">コード生成のインターフェイスをもう少し整備したい。jmp命令という中間の命令列のバイト数情報が必要なコードの生成を考えるとWrite + Seekを持ち回すのは限界を感じる。RopeっぽいBufを実装する</div>
		<div class="content">parser実装。forの初期化部はint i = 0のような変数定義が許されるので厳密には式ではないけど今の仕様だと定義なしで代入すると変数が作られる仕様なのでとりあえず式でいいか</div>
		<div class="content">前回書いたSeekを使う汚いコードをBufを使って書き直した</div>
	</div>
</div>
<h3 class="date">2022年12月5日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bc52690208a2b75d371d584c28abaea5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bc52690208a2b75d371d584c28abaea5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_bc52690208a2b75d371d584c28abaea5" href="#permalink_bc52690208a2b75d371d584c28abaea5" class="permalink">¶</a>
		<div class="content">ifとwhileのコード生成は前回の調査結果から実装。forはwhileのsyntax sugarとして実装</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8dbf6abb4f9913efeb9e13bb539f4654').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8dbf6abb4f9913efeb9e13bb539f4654').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8dbf6abb4f9913efeb9e13bb539f4654" href="#permalink_8dbf6abb4f9913efeb9e13bb539f4654" class="permalink">¶</a>
		<div class="content">見ていくか</div>
		<div class="content">statement が statment になってる誤字があるのと、そもそも関数「statementを評価してediレジスタへ」って値を「ediレジスタへ」確実に書いてくれるんでしたっけ？</div>
		<div class="content"><ul><li>まずediレジスタへ確実に書いてくれるかわからん</li><li>書いてくれていたとしても、「edi レジスタに書きこんでいる」を前提としたコードは文のレベルでは不存在っぽそう？</li></ul></div>
		<div class="content">ということで、関数名だけ変更してマージしておきますね</div>
		<div class="content">あ、clippy が Buf に Default とか is_empty を足せと言ってくるので一応足しておく</div>
		<div class="content">マージしたので、step 13 をやっていく。ブロックか。簡単だ</div>
		<div class="content">波括弧をトークナイザに追加し、パーサで読み、ああコードジェネレータにはもう既にあるのか（for を while に書き換える際に必要であったため）。</div>
		<div class="content">ということで、かなり少ない作業量でブロックの実装が完了。dangling else のテストケースも追加しておこう。よし通った</div>
	</div>
</div>
<h3 class="date">2022年12月7日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fa47efc706fae850b8ed2de48f8bac19').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fa47efc706fae850b8ed2de48f8bac19').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_fa47efc706fae850b8ed2de48f8bac19" href="#permalink_fa47efc706fae850b8ed2de48f8bac19" class="permalink">¶</a>
		<div class="content">step14のテストどうしましょう。本だとオブジェクトファイルを生成して自作関数とリンクすることになっていますが、、 </div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f2dc12b4e19a010bc93a2e5d259cf5ec').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f2dc12b4e19a010bc93a2e5d259cf5ec').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f2dc12b4e19a010bc93a2e5d259cf5ec" href="#permalink_f2dc12b4e19a010bc93a2e5d259cf5ec" class="permalink">¶</a>
		<div class="content">リンカ実装は明らかに荷が重いので、なんらかの syscall を呼ぶ関数を最初の魔法の 78 バイト付近に埋め込んで、__builtin() でその関数をコールできるようにする、でどうでしょう？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4327c7f5b23b612fb17efe0b67d11ece').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4327c7f5b23b612fb17efe0b67d11ece').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_4327c7f5b23b612fb17efe0b67d11ece" href="#permalink_4327c7f5b23b612fb17efe0b67d11ece" class="permalink">¶</a>
		<div class="content">たーしかに…とりあえずビルドイン関数でなんとかしますかー。グローバル変数はまだまだ先だったしそれが楽そう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a59bb0655e753bc5b7f0604d3f3a8327').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a59bb0655e753bc5b7f0604d3f3a8327').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_a59bb0655e753bc5b7f0604d3f3a8327" href="#permalink_a59bb0655e753bc5b7f0604d3f3a8327" class="permalink">¶</a>
		<div class="content">まず __builtin_three()（3 を rax に入れて ret するだけ）を実装し、次に __builtin_putchar(int char) を実装、といった感じかなぁ</div>
	</div>
</div>
<h3 class="date">2022年12月30日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4cfd130d847c4e4534161afb6cc68684').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4cfd130d847c4e4534161afb6cc68684').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_4cfd130d847c4e4534161afb6cc68684" href="#permalink_4cfd130d847c4e4534161afb6cc68684" class="permalink">¶</a>
		<div class="content">トークナイザは変更しなくていい。パーサーは</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_38a0b50d8d173fbbf1563268751dd112').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_38a0b50d8d173fbbf1563268751dd112').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_38a0b50d8d173fbbf1563268751dd112" href="#permalink_38a0b50d8d173fbbf1563268751dd112" class="permalink">¶</a>
		<div class="content">primary_expression の定義を変えるんだっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8c5f631277ba7a4d789e973a42074587').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8c5f631277ba7a4d789e973a42074587').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_8c5f631277ba7a4d789e973a42074587" href="#permalink_8c5f631277ba7a4d789e973a42074587" class="permalink">¶</a>
		<div class="content">compilerbook はそうしてますね。まずは引数のないやつだけ組むのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4ba734bf162cf881cda83fc773f3027a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4ba734bf162cf881cda83fc773f3027a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4ba734bf162cf881cda83fc773f3027a" href="#permalink_4ba734bf162cf881cda83fc773f3027a" class="permalink">¶</a>
		<div class="content">__builtin_three がちょうどいいですね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_096bcafca9321f50f114cc9da0f00cf1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_096bcafca9321f50f114cc9da0f00cf1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_096bcafca9321f50f114cc9da0f00cf1" href="#permalink_096bcafca9321f50f114cc9da0f00cf1" class="permalink">¶</a>
		<div class="content">パーサーの実装の入れ子が深くなっちゃうな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_af9b177458ed53aeae0ef7c4170ad049').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_af9b177458ed53aeae0ef7c4170ad049').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_af9b177458ed53aeae0ef7c4170ad049" href="#permalink_af9b177458ed53aeae0ef7c4170ad049" class="permalink">¶</a>
		<div class="content">まあ後で浅くなるので気にしなくてよいのでは</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fff26bd35192a0ae1869633f43e83ded').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fff26bd35192a0ae1869633f43e83ded').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_fff26bd35192a0ae1869633f43e83ded" href="#permalink_fff26bd35192a0ae1869633f43e83ded" class="permalink">¶</a>
		<div class="content">パーサーはこれでいい。codegen 面倒だなぁ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5a2b91f707233ca79262da61ffbd2a57').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5a2b91f707233ca79262da61ffbd2a57').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_5a2b91f707233ca79262da61ffbd2a57" href="#permalink_5a2b91f707233ca79262da61ffbd2a57" class="permalink">¶</a>
		<div class="content">まあね</div>
		<div class="content">関数名が __builtin_three じゃなかったらエラー吐いて落ちればいいでしょ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_34d6e9540777ed36505b2bfbc6647f5a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_34d6e9540777ed36505b2bfbc6647f5a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_34d6e9540777ed36505b2bfbc6647f5a" href="#permalink_34d6e9540777ed36505b2bfbc6647f5a" class="permalink">¶</a>
		<div class="content">codegen ではエラーを吐かない方がいいのでは？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b8327cd6e857578383426cbc00f792ed').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b8327cd6e857578383426cbc00f792ed').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_b8327cd6e857578383426cbc00f792ed" href="#permalink_b8327cd6e857578383426cbc00f792ed" class="permalink">¶</a>
		<div class="content">関数の不存在はリンクエラーの領分だし、codegen が落ちてもいいでしょ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_294fae39036d29034a1f42cd636508fb').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_294fae39036d29034a1f42cd636508fb').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_294fae39036d29034a1f42cd636508fb" href="#permalink_294fae39036d29034a1f42cd636508fb" class="permalink">¶</a>
		<div class="content">たしかにそうか</div>
		<div class="content">えーと jmp が必要で</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_754dbeedb3f30122f7d47ae0afac9905').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_754dbeedb3f30122f7d47ae0afac9905').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_754dbeedb3f30122f7d47ae0afac9905" href="#permalink_754dbeedb3f30122f7d47ae0afac9905" class="permalink">¶</a>
		<div class="content">いえ、call です</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_66ef058170c6c8445dcbe2a7ac04049b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_66ef058170c6c8445dcbe2a7ac04049b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_66ef058170c6c8445dcbe2a7ac04049b" href="#permalink_66ef058170c6c8445dcbe2a7ac04049b" class="permalink">¶</a>
		<div class="content">名前では呼べませんよね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_053dbe393d279544a44d70303870ba16').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_053dbe393d279544a44d70303870ba16').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_053dbe393d279544a44d70303870ba16" href="#permalink_053dbe393d279544a44d70303870ba16" class="permalink">¶</a>
		<div class="content">そりゃあね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4d265879bad6dbd3e0ffdd51a618df34').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4d265879bad6dbd3e0ffdd51a618df34').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_4d265879bad6dbd3e0ffdd51a618df34" href="#permalink_4d265879bad6dbd3e0ffdd51a618df34" class="permalink">¶</a>
		<div class="content">とりあえずアセンブリを書いてビルドしてみて実践するしかないか</div>
		<pre><code class="language-">GLOBAL _start
SECTION .text
_test:
        ;mov rax, 3
        ret
_start:
            mov     eax, 1
            call    _test
            mov     ebx, eax
            int     0x80
</code></pre>
		<div class="content">なんで 0 を返して正常終了するんだろう。3 が返ってきてほしいのに</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f23ad521630e9574c19c22ed489199b4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f23ad521630e9574c19c22ed489199b4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f23ad521630e9574c19c22ed489199b4" href="#permalink_f23ad521630e9574c19c22ed489199b4" class="permalink">¶</a>
		<div class="content">./tiny ではなく ./tiny3 を走らせる必要がありませんか？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6b7e7f4c5eb6e1d846dffde42202774a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6b7e7f4c5eb6e1d846dffde42202774a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_6b7e7f4c5eb6e1d846dffde42202774a" href="#permalink_6b7e7f4c5eb6e1d846dffde42202774a" class="permalink">¶</a>
		<div class="content">ほんとだ。そうすると……セグフォ？なぜ</div>
		<div class="content">rsp の操作が要りそうだな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f2dc8a03d3729d694543d0ec1dd2b3a9').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f2dc8a03d3729d694543d0ec1dd2b3a9').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f2dc8a03d3729d694543d0ec1dd2b3a9" href="#permalink_f2dc8a03d3729d694543d0ec1dd2b3a9" class="permalink">¶</a>
		<div class="content">ん、call はそこら辺ちゃんとやってくれるから要らないのでは</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ceee19966bb36ce70b7ce9f6450333d1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ceee19966bb36ce70b7ce9f6450333d1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_ceee19966bb36ce70b7ce9f6450333d1" href="#permalink_ceee19966bb36ce70b7ce9f6450333d1" class="permalink">¶</a>
		<div class="content">pop が要るんじゃね？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cb2e80e64c0df222eba737722ce000e2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cb2e80e64c0df222eba737722ce000e2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_cb2e80e64c0df222eba737722ce000e2" href="#permalink_cb2e80e64c0df222eba737722ce000e2" class="permalink">¶</a>
		<div class="content">いや、要らないと思うけどなぁ。gcc で return 3; をコンパイルしたアセンブリはどうなります？</div>
		<div class="content">セグフォなんですが、ありそうだと思ってるのが、実はビルドが完成していなくて、本来はリンカが call の対象を直して実行ファイルにするんですけど、その直すのがされていないままの、リンカを通っていないやつを実行してセグフォしているのでは？という気もします</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_757addb79269fd025d71082aeb8156b2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_757addb79269fd025d71082aeb8156b2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_757addb79269fd025d71082aeb8156b2" href="#permalink_757addb79269fd025d71082aeb8156b2" class="permalink">¶</a>
		<div class="content">Makefile の中で ld 通ってますよ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f02dd6c638ec5f2bed3312ca235ccb11').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f02dd6c638ec5f2bed3312ca235ccb11').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f02dd6c638ec5f2bed3312ca235ccb11" href="#permalink_f02dd6c638ec5f2bed3312ca235ccb11" class="permalink">¶</a>
		<div class="content">たしかに〜</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d6be51604dd11882428b26d93b2e9c04').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d6be51604dd11882428b26d93b2e9c04').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d6be51604dd11882428b26d93b2e9c04" href="#permalink_d6be51604dd11882428b26d93b2e9c04" class="permalink">¶</a>
		<div class="content">call を jmp にすり替えたらセグフォせずに無限ループになっているので、そこの問題はないと思われますが</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_156e32405e2de76ad58c67e127178b58').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_156e32405e2de76ad58c67e127178b58').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_156e32405e2de76ad58c67e127178b58" href="#permalink_156e32405e2de76ad58c67e127178b58" class="permalink">¶</a>
		<div class="content">もう gdb で攻める以外の方法思いつかない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1e8dc42e907957fa53a3227d9f44757b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1e8dc42e907957fa53a3227d9f44757b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1e8dc42e907957fa53a3227d9f44757b" href="#permalink_1e8dc42e907957fa53a3227d9f44757b" class="permalink">¶</a>
		<div class="content">使ったことない〜。でも使わないと今後きつそう。まあとりあえず gcc でコンパイルしてみよう</div>
		<div class="content">ベースポインタの退避とかしなくていいんですかね。call 命令はやってくれる？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_892d1c90557e435439b2eab5fe180f7d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_892d1c90557e435439b2eab5fe180f7d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_892d1c90557e435439b2eab5fe180f7d" href="#permalink_892d1c90557e435439b2eab5fe180f7d" class="permalink">¶</a>
		<div class="content">call 命令は退避はしてくれないので、呼ぶ側はプロローグ書かないとですね。呼ばれる方の builtin_three は要らない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1e47cd610e56e8ed9acd88ab5f5f5169').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1e47cd610e56e8ed9acd88ab5f5f5169').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1e47cd610e56e8ed9acd88ab5f5f5169" href="#permalink_1e47cd610e56e8ed9acd88ab5f5f5169" class="permalink">¶</a>
		<div class="content">あーじゃあそれのせいだな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_9847d5f106f51a20e69b31f3de3758bd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_9847d5f106f51a20e69b31f3de3758bd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_9847d5f106f51a20e69b31f3de3758bd" href="#permalink_9847d5f106f51a20e69b31f3de3758bd" class="permalink">¶</a>
		<div class="content">プロローグは compilerbook にあるのでそれを使えばいいでしょう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0b0abc7f42bd1335cd3cde6ddc8fd816').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0b0abc7f42bd1335cd3cde6ddc8fd816').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_0b0abc7f42bd1335cd3cde6ddc8fd816" href="#permalink_0b0abc7f42bd1335cd3cde6ddc8fd816" class="permalink">¶</a>
		<div class="content">でも compilerbook はプロローグ無しで call できてそうだけど</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4e78b2d9959af189165b8e5bf961ccbd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4e78b2d9959af189165b8e5bf961ccbd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4e78b2d9959af189165b8e5bf961ccbd" href="#permalink_4e78b2d9959af189165b8e5bf961ccbd" class="permalink">¶</a>
		<div class="content">具体的にどこの？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_69dca9b29d08519e82459bacd7fc0553').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_69dca9b29d08519e82459bacd7fc0553').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_69dca9b29d08519e82459bacd7fc0553" href="#permalink_69dca9b29d08519e82459bacd7fc0553" class="permalink">¶</a>
		<div class="content">ここですね</div>
		<blockquote>このCコードに対応するアセンブリは次のようになります。

.intel_syntax noprefix
.globl plus, main

plus:
        add rsi, rdi
        mov rax, rsi
        ret

main:
        mov rdi, 3
        mov rsi, 4
        call plus
        ret
</blockquote>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3a319ac7c79e1a0ec6c70255b69d2042').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3a319ac7c79e1a0ec6c70255b69d2042').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3a319ac7c79e1a0ec6c70255b69d2042" href="#permalink_3a319ac7c79e1a0ec6c70255b69d2042" class="permalink">¶</a>
		<div class="content">たしかにね。このコードを標準的な gcc でビルドすることによってまず動かして、どこを nasm にすり替えるとこれがこわれるのかを調べるのが近道かな？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4bc6b3a7f7c10406dd526ebbe77ccdb9').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4bc6b3a7f7c10406dd526ebbe77ccdb9').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_4bc6b3a7f7c10406dd526ebbe77ccdb9" href="#permalink_4bc6b3a7f7c10406dd526ebbe77ccdb9" class="permalink">¶</a>
		<div class="content">call 終わった時点ではセグフォ起きてない。これ↓がセグフォせず無限ループしてるので</div>
		<pre><code class="language-">GLOBAL _start
SECTION .text
_test:
        mov eax, 3
        ret
_start:
            call    _test
a:
            jmp a
            mov     ebx, eax
            int     0x80
</code></pre>
		<div class="content">なんでこれがセグフォしないんだ？</div>
		<div class="content">あ、もしかして int 0x80 が eax に 1 を必要とする？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_eefa3eb25b43ac16daa8d0d2bd6c452f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_eefa3eb25b43ac16daa8d0d2bd6c452f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_eefa3eb25b43ac16daa8d0d2bd6c452f" href="#permalink_eefa3eb25b43ac16daa8d0d2bd6c452f" class="permalink">¶</a>
		<div class="content">可能性がある。int 0x80 の直前に mov eax, 1 書いたらどうなります？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5d929ff296eb90c2eb155b88e1a5b84d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5d929ff296eb90c2eb155b88e1a5b84d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_5d929ff296eb90c2eb155b88e1a5b84d" href="#permalink_5d929ff296eb90c2eb155b88e1a5b84d" class="permalink">¶</a>
		<div class="content">いけた。call のせいじゃなくて syscall の使い方間違えてるだけだったわ</div>
		<div class="content">あーそうか、syscall 番号が eax か。0x80 がシステムコール番号なのではなくて</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d5206284212ba19cd8592e5d83e5c251').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d5206284212ba19cd8592e5d83e5c251').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_d5206284212ba19cd8592e5d83e5c251" href="#permalink_d5206284212ba19cd8592e5d83e5c251" class="permalink">¶</a>
		<div class="content">私も一時期その勘違いしてた気がするな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7f398bd730903ead733dfdc49d0e1a6f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7f398bd730903ead733dfdc49d0e1a6f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_7f398bd730903ead733dfdc49d0e1a6f" href="#permalink_7f398bd730903ead733dfdc49d0e1a6f" class="permalink">¶</a>
		<div class="content">syscall 命令みたいなのなかったっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_83affce9d9092db782d4b9720b14b041').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_83affce9d9092db782d4b9720b14b041').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_83affce9d9092db782d4b9720b14b041" href="#permalink_83affce9d9092db782d4b9720b14b041" class="permalink">¶</a>
		<div class="content">とりあえず動いたのでヨシ</div>
		<div class="content">で、結局バイナリを見て call がどう翻訳されてるかを確認したかったんですよね？</div>
		<pre><code class="language-">GLOBAL _start
SECTION .text
_test:
        mov eax, 3
        ret
_start:
        call    _test
        mov     ebx, eax
        mov     eax, 1
        int     0x80
</code></pre>
		<div class="content">とりあえずその前に、動いたアセンブリとバイナリをコミットし、</div>
		<div class="content">私が書いてるログも入れるとよさそう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c4797d9bf074e0253e2a44717a5b687b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c4797d9bf074e0253e2a44717a5b687b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_c4797d9bf074e0253e2a44717a5b687b" href="#permalink_c4797d9bf074e0253e2a44717a5b687b" class="permalink">¶</a>
		<div class="content">Makefile いじろう</div>
		<div class="content">既存のファイルが .out に変わるけどとりあえず今のところは影響ないか</div>
		<div class="content">てかコミットしてるなら clean 自体が要らない気がするな</div>
		<div class="content">あ、Makefile のルールをそもそも拡張子なしにできるからそれでいいのか</div>
	</div>
</div>
<h3 class="date">2023年1月1日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b56696eebef24f43dc9a8eab3231661e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b56696eebef24f43dc9a8eab3231661e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_b56696eebef24f43dc9a8eab3231661e" href="#permalink_b56696eebef24f43dc9a8eab3231661e" class="permalink">¶</a>
		<div class="content">Macだとasm-&gt;elfの実験ができなかったりテスト遅かったりして開発しにくかったので改善</div>
		<div class="content">call命令も相対アドレスなのかなりめんどくさい。jmpは文を先に生成してサイズ見てでよかったけどcallは今まで生成したコードサイズを記録しないといけないからかなり大変</div>
		<div class="content">call レジスタ名 と指定すれば絶対アドレスでいけるらしいのでとりあえずこれでいいかな。多分ダイナミックディスパッチと同じで遅いけど</div>
		<div class="content">またセグフォー、多分これ__builtin_threeがエントリポイントになってるなうげ〜。出力バイナリの0x18から2バイト(?)をエントリポイントのアドレスに書き換えたらいけるかも</div>
		<div class="content">そろそろLEB128の実装が必要そう</div>
		<div class="content">mov rax, 120; call rax; (120は__builtin_threeのアドレス)しても必ずraxに120が入ってる。そもそも__builtin_threeが実行されていなさそう。謎</div>
		<div class="content">eaxに即値をセットする命令は4byte指定しないといけなかったのと、call命令は0x00400000をelf内のアドレスに足さないといけなかったらしい。gdbの使い方少し覚えた。0x00400000がベースアドレスだったのか</div>
	</div>
</div>
<h3 class="date">2023年1月2日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1cdf95f4f2e4107f6c63e31471aee172').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1cdf95f4f2e4107f6c63e31471aee172').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1cdf95f4f2e4107f6c63e31471aee172" href="#permalink_1cdf95f4f2e4107f6c63e31471aee172" class="permalink">¶</a>
		<div class="content">お、できておる。すごい。えーと clippy が通っていない</div>
		<div class="content">なるほど、i32 じゃなくて i8 の to_le_bytes してるところがあるのか。でも呼ばれてないから今の所問題が露呈していない、と</div>
		<div class="content">それを直していただいたら、とりあえずこれでマージしちゃって、__builtin_putchar は step14-2 ってブランチでやっちゃいましょう</div>
		<div class="content">しかしなんとか突破できて本当によかった。ステップ 14 はだいぶ苦しくなるだろうと思ってたし、クリアがなされたのはめちゃめちゃえらいんだよな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_16e6a4782aa751221334b3fdaa7e1335').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_16e6a4782aa751221334b3fdaa7e1335').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_16e6a4782aa751221334b3fdaa7e1335" href="#permalink_16e6a4782aa751221334b3fdaa7e1335" class="permalink">¶</a>
		<div class="content">そもそもアセンブリもよく知らない状況だったから大変だった</div>
		<div class="content">どこらへんでぶっ壊れてるかもわからんから gdb の使い方から調べて。思ったよりハードコアだった。x64 のバイナリフォーマット相当複雑じゃないですか？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_03b8f2fbe6784c9f768b35ddce6a5351').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_03b8f2fbe6784c9f768b35ddce6a5351').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_03b8f2fbe6784c9f768b35ddce6a5351" href="#permalink_03b8f2fbe6784c9f768b35ddce6a5351" class="permalink">¶</a>
		<div class="content">実はね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_73d743bf056b85b89ed1c61234de4e4f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_73d743bf056b85b89ed1c61234de4e4f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_73d743bf056b85b89ed1c61234de4e4f" href="#permalink_73d743bf056b85b89ed1c61234de4e4f" class="permalink">¶</a>
		<div class="content">wasm は本当にラクだったけど、x64 やばすぎる</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ce3551c3cbdbc800feede420c0dc003f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ce3551c3cbdbc800feede420c0dc003f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_ce3551c3cbdbc800feede420c0dc003f" href="#permalink_ce3551c3cbdbc800feede420c0dc003f" class="permalink">¶</a>
		<div class="content">ところで、この追加されてる .nix とか .lock とかについて知るには何を読めばいいですか？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ba2f29631fefc2d64053eaf57ad4c1e4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ba2f29631fefc2d64053eaf57ad4c1e4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_ba2f29631fefc2d64053eaf57ad4c1e4" href="#permalink_ba2f29631fefc2d64053eaf57ad4c1e4" class="permalink">¶</a>
		<div class="content">Mac での開発用に足しただけなので、Linux でやってるなら気にしなくていいです</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5c86e8180ceab4cac507b45d99970b7b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5c86e8180ceab4cac507b45d99970b7b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_5c86e8180ceab4cac507b45d99970b7b" href="#permalink_5c86e8180ceab4cac507b45d99970b7b" class="permalink">¶</a>
		<div class="content">Mac で使えるのはうれしいので、これがなんであってどううれしいのか、みたいな話をお教えいただけると</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_be4365c36ffb92692dca0d4c482b492c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_be4365c36ffb92692dca0d4c482b492c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_be4365c36ffb92692dca0d4c482b492c" href="#permalink_be4365c36ffb92692dca0d4c482b492c" class="permalink">¶</a>
		<div class="content">なにしてたっけな。えっと、bintools とかを使えるようにした。Makefile で、Mac だと x64-linux 向けのリンカや strip コマンドが入っていないので、それを自動で入れて、Mac だったら自動でそれを使ってくれるように。experiment の中の Makefiles で BINTOOLS_PREFIX って書いてあるじゃないですか。ここに Mac だった場合に適切な prefix が入って、これがどこで定義されているかというと、break.nix の下の方に、x64-Linux だったら空、そうじゃない場合に適切な文字列を入れることで、Linux の ld とかが使えるようになって、それらをどこで開発環境にインストールしているかというと、24 行目を見ていただくと、開発用のシェルみたいなのを定義できるので、ここでインストールされている。この Linux パッケージというのは、ARM のだと用意されていなかったので、ARM の場合は x64 用のツールチェーンを使うように 18 行目で設定していて、そこら辺によって Linux 向けのリンカとかが簡単に使えるようになった</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_408df70bd5c20138161c612e9c6360a6').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_408df70bd5c20138161c612e9c6360a6').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_408df70bd5c20138161c612e9c6360a6" href="#permalink_408df70bd5c20138161c612e9c6360a6" class="permalink">¶</a>
		<div class="content">つまりこれは experiments 用のみであって、コンパイラをビルドしたりテストしたりするのには使ってない？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b9046510d295721fbd3a8b93899b0a5c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b9046510d295721fbd3a8b93899b0a5c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_b9046510d295721fbd3a8b93899b0a5c" href="#permalink_b9046510d295721fbd3a8b93899b0a5c" class="permalink">¶</a>
		<div class="content">今のところは使ってない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e321d78a082f67df38de9da2fefb8af2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e321d78a082f67df38de9da2fefb8af2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e321d78a082f67df38de9da2fefb8af2" href="#permalink_e321d78a082f67df38de9da2fefb8af2" class="permalink">¶</a>
		<div class="content">分かりました</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_407f7d3dce1e1241ece48998c61bc604').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_407f7d3dce1e1241ece48998c61bc604').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_407f7d3dce1e1241ece48998c61bc604" href="#permalink_407f7d3dce1e1241ece48998c61bc604" class="permalink">¶</a>
		<div class="content">で、これを使う場合には nix とか direnv ってのを入れなきゃいけなくて、入れると use flake ってのでさっき定義してた develop 用の環境が勝手にロードされるという仕組みになっている。使う場合はいろいろインストールが必要</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_677287a664afd69c767d3fd5d6a4cbc4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_677287a664afd69c767d3fd5d6a4cbc4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_677287a664afd69c767d3fd5d6a4cbc4" href="#permalink_677287a664afd69c767d3fd5d6a4cbc4" class="permalink">¶</a>
		<div class="content">なるほどなるほど</div>
		<div class="content">しかしまあ、なんとか突破できてよかった。いやまあギリギリ突破できそうで勉強になりそうだからこのテーマ設定にしたというのもあるけど。元の『低レイヤを知りたい人のためのCコンパイラ作成入門』は親切であるがゆえに『書いてあることをこなすとできる』って作業になってしまうのよね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c175fd6bc8b16aea96363ac346b79b49').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c175fd6bc8b16aea96363ac346b79b49').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_c175fd6bc8b16aea96363ac346b79b49" href="#permalink_c175fd6bc8b16aea96363ac346b79b49" class="permalink">¶</a>
		<div class="content">実は自分ひとりで元のもやってるんだけど、</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ddb9909dcfa72d8132e523c8ddb4bc9c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ddb9909dcfa72d8132e523c8ddb4bc9c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_ddb9909dcfa72d8132e523c8ddb4bc9c" href="#permalink_ddb9909dcfa72d8132e523c8ddb4bc9c" class="permalink">¶</a>
		<div class="content">あ、そうなの</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_50925a34395c8a43780e3c878e568c0f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_50925a34395c8a43780e3c878e568c0f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_50925a34395c8a43780e3c878e568c0f" href="#permalink_50925a34395c8a43780e3c878e568c0f" class="permalink">¶</a>
		<div class="content">やっぱり元のほうが圧倒的にラク</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_9c8d5daedd15000dd670b070ba0bb722').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_9c8d5daedd15000dd670b070ba0bb722').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_9c8d5daedd15000dd670b070ba0bb722" href="#permalink_9c8d5daedd15000dd670b070ba0bb722" class="permalink">¶</a>
		<div class="content">そりゃそうよね。かなり多くをアセンブラとリンカに押し付けることができるし</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_335ce7bc82cc765c07b9153f00890d33').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_335ce7bc82cc765c07b9153f00890d33').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_335ce7bc82cc765c07b9153f00890d33" href="#permalink_335ce7bc82cc765c07b9153f00890d33" class="permalink">¶</a>
		<div class="content">リンカはともかく、アセンブラなんて大したことやってないっしょって思ってたら、そんなことなかった。アセンブラって思った以上に複雑なことしてたんだな、こんな複雑だったんだ、っていう気持ちになった</div>
	</div>
</div>
<h3 class="date">2023年1月3日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_37fa0be8eb9b535d9297f9e16db116ab').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_37fa0be8eb9b535d9297f9e16db116ab').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_37fa0be8eb9b535d9297f9e16db116ab" href="#permalink_37fa0be8eb9b535d9297f9e16db116ab" class="permalink">¶</a>
		<div class="content">__builtin_putchar を書いたが動かない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_94e8bab3c379e971d02e6a63cc0d5c89').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_94e8bab3c379e971d02e6a63cc0d5c89').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_94e8bab3c379e971d02e6a63cc0d5c89" href="#permalink_94e8bab3c379e971d02e6a63cc0d5c89" class="permalink">¶</a>
		<div class="content">int 0x80 は 32 bit 用の ABI であって、64 bit のポインタを渡しても上位 32 bit は無視されるそうです</div>
		<div class="content">exit システムコールはポインタを用いなかったのでこの問題が露呈しなかったが、write システムコールはポインタを要求するので int 0x80 ではダメで syscall を使う必要があるとのこと</div>
		<div class="content"><a href="https://stackoverflow.com/questions/22503944/using-interrupt-0x80-on-64-bit-linux" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/22503944/using-interrupt-0x80-on-64-bit-linux</a></div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5cc744f03cfed83fefdda8fbcf33e963').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5cc744f03cfed83fefdda8fbcf33e963').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_5cc744f03cfed83fefdda8fbcf33e963" href="#permalink_5cc744f03cfed83fefdda8fbcf33e963" class="permalink">¶</a>
		<div class="content">そもそもこれって32bitバイナリを吐き出すプロジェクトですか？64bitバイナリを吐き出すプロジェクトですか？</div>
		<div class="content">今のところコンパイラは32bitバイナリを吐き出しているのにexperimentのtiny以外は64bitバイナリ(ただし64bitでは使えなさそうな int 0x80 を使っている)を吐き出しているように見えます</div>
		<div class="content">qemuでセグフォが起きるのでどっちかに統一したいです</div>
		<div class="content">と思ったけどバイナリ自体は64bitなのでintをsyscallに書き換えればよさそう？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4a8f2647078f1bf76342e6178adbda0b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4a8f2647078f1bf76342e6178adbda0b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4a8f2647078f1bf76342e6178adbda0b" href="#permalink_4a8f2647078f1bf76342e6178adbda0b" class="permalink">¶</a>
		<div class="content">64 bit でも int 0x80 は使えるんですよね。exit は引数にポインタがないので int 0x80 をそのまま使って問題ないけど、write は引数にポインタがあるせいで困る</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c63059fc015507ddb8ffc885a6665267').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c63059fc015507ddb8ffc885a6665267').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_c63059fc015507ddb8ffc885a6665267" href="#permalink_c63059fc015507ddb8ffc885a6665267" class="permalink">¶</a>
		<div class="content">qemuの制限なんですかね？(qemuでエミュレーションしているm1 mac上のdockerだと死にました)</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_951e6e8397f7a5cb0e3e34d2b95f0326').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_951e6e8397f7a5cb0e3e34d2b95f0326').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_951e6e8397f7a5cb0e3e34d2b95f0326" href="#permalink_951e6e8397f7a5cb0e3e34d2b95f0326" class="permalink">¶</a>
		<div class="content">qemu はいろんなものが動かなかったりするという噂を聞いています</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2a50f921acddec94d0bfc3f1a1698ec7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2a50f921acddec94d0bfc3f1a1698ec7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_2a50f921acddec94d0bfc3f1a1698ec7" href="#permalink_2a50f921acddec94d0bfc3f1a1698ec7" class="permalink">¶</a>
		<div class="content">コンパイラが出力するバイナリはsyscallを使っているのでexperimentの方も書き換えておきます</div>
		<div class="content">qemuだと int 0x80 が動かないので syscall に書き換えた</div>
		<div class="content">putcharをアセンブリで書けた。writeに渡すbufはポインタじゃないといけないからスタックに引数をpushしてrspを渡せばいいかな</div>
		<div class="content">スタック領域を16の倍数にアライメントとかを考えるとpush/popでネストした式の途中結果を保存するより全部ローカル変数に入れた方が楽なのでは 🤔</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer"><img alt="れもん" class="icon" src="icons/れもん.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bb54a4ef215950db3d2ce4d362abb5a9').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bb54a4ef215950db3d2ce4d362abb5a9').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer">れもん</a></span><a id="permalink_bb54a4ef215950db3d2ce4d362abb5a9" href="#permalink_bb54a4ef215950db3d2ce4d362abb5a9" class="permalink">¶</a>
		<div class="content">その概念を拡張したのがregister allocation</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bd07b8acef40c73a33c49c30be7b1d67').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bd07b8acef40c73a33c49c30be7b1d67').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_bd07b8acef40c73a33c49c30be7b1d67" href="#permalink_bd07b8acef40c73a33c49c30be7b1d67" class="permalink">¶</a>
		<div class="content">実装したことがない😿</div>
	</div>
</div>
<h3 class="date">2023年1月4日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_aacd6c41b6b1c6c02580b43b489ead30').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_aacd6c41b6b1c6c02580b43b489ead30').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_aacd6c41b6b1c6c02580b43b489ead30" href="#permalink_aacd6c41b6b1c6c02580b43b489ead30" class="permalink">¶</a>
		<div class="content">アセンブリ→バイナリの変換規則眺めてもなんもわからんって思ってたけど、hexじゃなくて2進数列にしたらなんとなく分かったわ。そういうこと？？？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer"><img alt="れもん" class="icon" src="icons/れもん.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_000cf9c28842dbf4845c67fc2f58e830').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_000cf9c28842dbf4845c67fc2f58e830').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer">れもん</a></span><a id="permalink_000cf9c28842dbf4845c67fc2f58e830" href="#permalink_000cf9c28842dbf4845c67fc2f58e830" class="permalink">¶</a>
		<div class="content">x86は3bitでレジスタを表していたりする。64bit拡張命令(0x4_)とかも調べてみると面白いよ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d505b1cf52365994eed301ccffb89c82').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d505b1cf52365994eed301ccffb89c82').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d505b1cf52365994eed301ccffb89c82" href="#permalink_d505b1cf52365994eed301ccffb89c82" class="permalink">¶</a>
		<div class="content">やっぱ認識あってた。むずい</div>
		<div class="content">そういえば、標準出力のテストなんてものはいま無いので、追加するかどうか迷っています</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_314f2d5396e1c76913c9da71fa9c2490').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_314f2d5396e1c76913c9da71fa9c2490').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_314f2d5396e1c76913c9da71fa9c2490" href="#permalink_314f2d5396e1c76913c9da71fa9c2490" class="permalink">¶</a>
		<div class="content">まあほしいですよねテスト</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_33ae39385c8231e5cf6c7ac95d7e1d86').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_33ae39385c8231e5cf6c7ac95d7e1d86').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_33ae39385c8231e5cf6c7ac95d7e1d86" href="#permalink_33ae39385c8231e5cf6c7ac95d7e1d86" class="permalink">¶</a>
		<div class="content">わかる〜。作らなくては</div>
	</div>
</div>
<h3 class="date">2023年1月7日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_83c41c9bed37505dcfaf34ca0ce047c1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_83c41c9bed37505dcfaf34ca0ce047c1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_83c41c9bed37505dcfaf34ca0ce047c1" href="#permalink_83c41c9bed37505dcfaf34ca0ce047c1" class="permalink">¶</a>
		<div class="content">標準出力のテストどうするかね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_09a838f0a4aed46b95638970d0915fb5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_09a838f0a4aed46b95638970d0915fb5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_09a838f0a4aed46b95638970d0915fb5" href="#permalink_09a838f0a4aed46b95638970d0915fb5" class="permalink">¶</a>
		<div class="content">あーそういやこれドラフトのままだった。完全に終わってた気になってた。今のインターフェース的に標準出力のテストめんどいよな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3d2af614cb216a2ce56a090664d53dc2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3d2af614cb216a2ce56a090664d53dc2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_3d2af614cb216a2ce56a090664d53dc2" href="#permalink_3d2af614cb216a2ce56a090664d53dc2" class="permalink">¶</a>
		<div class="content">リダイレクトするのではいかんの？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_3573388cd4e5fabedc643aaa729fb20a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_3573388cd4e5fabedc643aaa729fb20a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_3573388cd4e5fabedc643aaa729fb20a" href="#permalink_3573388cd4e5fabedc643aaa729fb20a" class="permalink">¶</a>
		<div class="content">現状のシェルスクリプトが check って関数の形じゃないですか。あと、複数行コードが出てきたときに今のままだとつらい</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b1038b5c320781ce402a67881557b198').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b1038b5c320781ce402a67881557b198').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_b1038b5c320781ce402a67881557b198" href="#permalink_b1038b5c320781ce402a67881557b198" class="permalink">¶</a>
		<div class="content">もっとも簡単な形で解決すればいいので、check_stdout を新造するという形でいいのでは</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_391f754f9e79ce8b3f6fa4ab47aad313').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_391f754f9e79ce8b3f6fa4ab47aad313').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_391f754f9e79ce8b3f6fa4ab47aad313" href="#permalink_391f754f9e79ce8b3f6fa4ab47aad313" class="permalink">¶</a>
		<div class="content">それか環境変数で</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_896676fd66b5dc75887fb068cbb74bf7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_896676fd66b5dc75887fb068cbb74bf7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_896676fd66b5dc75887fb068cbb74bf7" href="#permalink_896676fd66b5dc75887fb068cbb74bf7" class="permalink">¶</a>
		<div class="content">関数分ければよくな〜い？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fbe25643f9e0c1f299d745237127aef5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fbe25643f9e0c1f299d745237127aef5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_fbe25643f9e0c1f299d745237127aef5" href="#permalink_fbe25643f9e0c1f299d745237127aef5" class="permalink">¶</a>
		<div class="content">とりあえず、check の第三引数にオプショナルで与えるということで</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_413e4db88292ae933e4ca590b9bebd36').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_413e4db88292ae933e4ca590b9bebd36').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_413e4db88292ae933e4ca590b9bebd36" href="#permalink_413e4db88292ae933e4ca590b9bebd36" class="permalink">¶</a>
		<div class="content">よさそう</div>
	</div>
</div>
<h3 class="date">2023年1月8日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0e808c83604b2a5fdd710506085e7bdd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0e808c83604b2a5fdd710506085e7bdd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_0e808c83604b2a5fdd710506085e7bdd" href="#permalink_0e808c83604b2a5fdd710506085e7bdd" class="permalink">¶</a>
		<div class="content">さて step 15 は『関数の定義に対応する』だった。関数を用意する方法自体は前のステップとかで整備されているはずなので、それに乗っかればまあ実装できるでしょう</div>
		<div class="content">とはいえ、ここからは main 関数が出てくるようになるという話もある。これをどうするか。</div>
		<div class="content">まあ、普通に、main 関数を定義して、それを暗黙にスタートアップルーチンから call するようにすればいいか</div>
		<div class="content">main を call するコードを出力するには、main(); というソースコードをそのまま解釈させればよかろう</div>
		<div class="content">とりあえず、現状のテストケースを全て暗黙に main 関数の中に突っ込み、エントリーポイントの中では暗黙に main(); を呼び出す実装へと変更しよう</div>
		<div class="content">先にコード生成部分をそう変更してから、その後にテストケース自体に main() { ... } を追加して、それをパースするようにと変更すればよさそうだな</div>
		<div class="content">ちょっとリファクタリング。u16 とか u8 幅を超えていたら明示的にエラーメッセージを出して落とすようにし、現状の codegen は関数テーブルを変更しないので mutable で渡しているところを immutable にし、generate_startup 関数として切り出す</div>
		<div class="content">ところで、エントリーポイントの実装は main(); じゃなくて return main(); にすべきだな。というか、現状の return は実は return ではなく exit を呼ぶ偽物なので、__builtin_exit みたいな名前に変更しちゃおうかな</div>
		<div class="content">カッコを要求してないし、JavaScript に倣って __throw でいいや</div>
		<div class="content">で、この __throw の実装を複製して return を作っていく</div>
		<div class="content">非自明なのは codegen だけで、このときには edi の結果をコピーして leave; ret すればいいのかな</div>
		<div class="content">よし、これで return が復活したはず。まだ試せないけど</div>
		<div class="content">そうしたら、次に目指すべきは、テストケースの __throw を return に戻して、</div>
		<pre><code class="language-c">__start() { __throw main(); }
main() { ここにテストケースを貼る }
</code></pre>
		<div class="content">といった感じへと改めていくことだな</div>
		<div class="content">えーっと、__throw main(); をトークナイズして、さっき切り出した関数に渡せば、これでよさそう？やってみよう</div>
		<div class="content">前述のとおり、テストケースの __throw を return に戻して、</div>
		<div class="content">よし動いた！</div>
		<div class="content">コード部分の変更ができたので、今度はテストケース自体を main() {} で囲うようにしよう</div>
		<div class="content">これにより、toplevel の概念が新たに生まれるようになるはず</div>
		<div class="content">えーと、とりあえず Program 型を FunctionContent とかに改名するか</div>
		<div class="content">変数名とかも適宜改名した。さて、残るは parse_program 関数だけであって、これが FunctionContent を返すのではなくて関数定義のリストを返すように変更すればよい</div>
		<div class="content">対応すべきは &#x60;foo(x, y) { ... }&#x60; という構文なので、とりあえず関数呼び出しの構文を定義している parse_primary をコピペして、実引数ではなく仮引数なので identifier だけを受理して、</div>
		<div class="content">よし、parse_toplevel_function_definition が実装できた</div>
		<div class="content">あとは、そうして読み込まれた関数定義ごとに、コード生成をしてやれば完成かな。まだ仮引数をレジスタから読みだすところを作ってないけど、とりあえずテストケースを main() { ... } で包んで実験しよう</div>
		<div class="content">よし、単に main() で包んだだけのやつは動いた。じゃあ関数定義を複数にすると？</div>
		<pre><code class="language-c">one() { return 1; } two() { return one() + 1; } main() { return one() + two() + __builtin_three(); }
</code></pre>
		<div class="content">動きますね。やったぁ</div>
		<div class="content">あとは仮引数をレジスタから読み出す処理を実装すれば、再帰でフィボナッチが呼べるはず</div>
		<div class="content">その前に、ちょっとコードをきれいにして、codegen に住んでいてもよさそうな感じのコードにしておこう</div>
		<div class="content">あー、std::mem::take ってこういうときに便利なのね。なるほどなぁ</div>
		<div class="content">さて、本題の実装。 <a href="https://www.sigbus.info/compilerbook#%E3%82%B9%E3%83%86%E3%83%83%E3%83%9715-%E9%96%A2%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B" target="_blank" rel="noopener noreferrer">https://www.sigbus.info/compilerbook#%E3%82%B9%E3%83%86%E3%83%83%E3%83%9715-%E9%96%A2%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B</a> には</div>
		<blockquote>xやyといったローカル変数が存在するものとしてコンパイルして、関数のプロローグの中で、レジスタの値をそのローカル変数のためのスタック上の領域に書き出してください。
</blockquote>
		<div class="content">とあるのだから、その通りにすればよい</div>
		<div class="content">えーと、引数自体が rdi に入っているから、計算をするのに rdi を使うことができなくて</div>
		<div class="content">もう直に mov [rbp-12], r9d とかの命令を使っちゃおう。さて実験だ</div>
		<div class="content">とりあえずフィボナッチ</div>
		<div class="content">はい～動かない</div>
		<div class="content">あ、Buf::new() に対して fold しておるな。『初期値代入』コードが入るべき場所はここだろ</div>
		<div class="content">んー動かない</div>
		<div class="content">……あっ、なるほどエラーメッセージが出てるけど他の成功メッセージで流れてしまってるのか</div>
		<div class="content">どれどれ</div>
		<pre><code class="language-">thread &#x27;main&#x27; panicked at &#x27;関数 fib が見つかりません&#x27;, src/codegen.rs:579:36
note: run with &#x60;RUST_BACKTRACE=1&#x60; environment variable to display a backtrace
</code></pre>
		<div class="content">あ～～なるほど、関数 fib の中ではまだ関数 fib が定義されていないから、再帰関数を呼び出すことができないのか</div>
		<div class="content">これはしょうがないので、テストケースを変えよう</div>
		<pre><code class="language-">[FAIL] add(x, y, z) { return x + y + z; } main() { return add(1, 2, __builtin_three()); } =&gt; 6 expected, but got 139
</code></pre>
		<div class="content">はいはいセグフォセグフォ</div>
		<div class="content">えーと失敗したときにも rm -rf してしまってるから調査対象物がない。成功時にのみ消すようにしよう</div>
		<pre><code class="language-">[FAIL] id(x) { return x; } main() { return id(6); } =&gt; 6 expected, but got 139
</code></pre>
		<div class="content">これでダメということは、まあなんかが根本的にダメなんだろうな。もうちょいソースを眺めるか</div>
		<div class="content">変数はスタック上にあるのではなくてベースポインタからの差分なのだから、stack_size には影響を与えないはず。だから stack_size は 8 のままにしなきゃいけないな</div>
		<div class="content">ところで、変数を読むところで落ちてる？変数を書き込むところで落ちてる？確認しよう</div>
		<pre><code class="language-">[FAIL] three(x) { return 3; } main() { return three(6); } =&gt; 3 expected, but got 139
</code></pre>
		<div class="content">まあそうよね</div>
		<div class="content">tkr の書いていたコードと重複があったことがわかり、リファクタリングをしていたところ、多分オフセットが -4 とかじゃなくて 0 になってるのがよくなさそうという気持ちになった。</div>
		<div class="content">しかし、謎がある。なぜ既存のコードではオフセットが 0 になることがなかったのだろうか</div>
		<div class="content">なってたけどバグってなかったのかもしれない。まあいいや、とりあえずオフセットは一律で idents.len() * 4 + 4、というか idx * 4 + 4、になるということに決めてしまおうか</div>
		<div class="content">というか idents じゃなくて lvar_table みたいな名前にしたいな。functions も function_table にしたいわね</div>
		<div class="content">はい無事動いた。とはいえ、再帰呼び出しができていないので、</div>
		<blockquote>このステップが終わるとフィボナッチ数列を再帰で計算しつつ表示したりできるようになるのでグッと面白くなるはずです。
</blockquote>
		<div class="content">が達成できていないな。じゃあ、せっかくなので、今回の機能を使ってフィボナッチをループで計算しつつ表示するテストケースを追加するか</div>
		<pre><code class="language-">check 0 &quot;if_non0(n) { __builtin_putchar(n ? n + 48 : 32); return 0; } print(n) { if_non0(n / 100); if_non0((n / 10) % 10); __builtin_putchar((n % 10) + 48); return 0; } main() { a = 0; b = 1; for(;a&lt;255;) { print(a); __builtin_putchar(44); c = a+b; a = b; b = c; } return 0; }&quot; &quot;  0,  1,  1,  2,  3,  5,  8, 13, 21, 34, 55, 89,144,233,&quot;
</code></pre>
		<div class="content">えーと % 演算子が実装されておらず、かつ % が bash の printf と衝突する。了解</div>
		<div class="content">とりあえず bash の printf と衝突するというのを直して、ループへと展開して、</div>
		<div class="content">はいはい、 % だけじゃなくて ? と ++ と -= もない。それもほぐしてやる。</div>
		<div class="content">255 が書けない。じゃあ、フィボナッチ数列ではなくリュカ数列にすればよい。すると</div>
		<pre><code class="language-">check 0 &quot;if_non0(n) { if (n) { __builtin_putchar(n + 48); } else { __builtin_putchar(32); } return 0; } print(n) { for(h=0;n&gt;=100;h=h+1){n=n-100;} if_non0(h); for(t=0;n&gt;=10;t=t+1){n=n-10;} if_non0(t); __builtin_putchar(n + 48); return 0; } main() { a = 2; b = 1; for(;a&lt;127;) { print(a); __builtin_putchar(44); c = a+b; a = b; b = c; } return 0; }&quot; &quot;  2,  1,  3,  4,  7, 11, 18, 29, 47, 76,123,&quot;

thread &#x27;main&#x27; panicked at &#x27;while 文の中でジャンプするためのバッファの長さが i8 に収まりません: TryFromIntError(())&#x27;, src/codegen.rs:326:65
</code></pre>
		<div class="content">なるほどね</div>
		<div class="content">バッファの中身を読んでみるか</div>
		<pre><code class="language-">thread &#x27;main&#x27; panicked at &#x27;while 文の中でジャンプするためのバッファの長さが i8 に収まりません。バッファの長さは 155、中身は 0x[55 5f 48 83 ef 04 48 8b 3f 57 bf 7f 00 00 00 57 5f 58 39 f8 0f 9c c0 0f b6 f8 83 ff 00 74 7e 48 83 ec 08 55 5f 48 83 ef 04 48 8b 3f 57 5f b8 0c 01 40 00 ff d0 89 c7 48 83 c4 08 48 83 ec 08 bf 2c 00 00 00 57 5f b8 87 00 40 00 ff d0 89 c7 48 83 c4 08 55 5f 48 83 ef 0c 57 55 5f 48 83 ef 04 48 8b 3f 57 55 5f 48 83 ef 08 48 8b 3f 57 58 5f 01 c7 58 89 38 55 5f 48 83 ef 04 57 55 5f 48 83 ef 08 48 8b 3f 58 89 38 55 5f 48 83 ef 08 57 55 5f 48 83 ef 0c 48 8b 3f 58 89 38] です&#x27;, src/codegen.rs:327:21
</code></pre>
		<div class="content">えーと disass して</div>
		<pre><code class="language-">0:  55                      push   rbp
1:  5f                      pop    rdi
2:  48 83 ef 04             sub    rdi,0x4
6:  48 8b 3f                mov    rdi,QWORD PTR [rdi]
9:  57                      push   rdi
a:  bf 7f 00 00 00          mov    edi,0x7f
f:  57                      push   rdi
10: 5f                      pop    rdi
11: 58                      pop    rax
12: 39 f8                   cmp    eax,edi
14: 0f 9c c0                setl   al
17: 0f b6 f8                movzx  edi,al
1a: 83 ff 00                cmp    edi,0x0
1d: 74 7e                   je     0x9d
1f: 48 83 ec 08             sub    rsp,0x8
23: 55                      push   rbp
24: 5f                      pop    rdi
25: 48 83 ef 04             sub    rdi,0x4
29: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
2c: 57                      push   rdi
2d: 5f                      pop    rdi
2e: b8 0c 01 40 00          mov    eax,0x40010c
33: ff d0                   call   rax
35: 89 c7                   mov    edi,eax
37: 48 83 c4 08             add    rsp,0x8
3b: 48 83 ec 08             sub    rsp,0x8
3f: bf 2c 00 00 00          mov    edi,0x2c
44: 57                      push   rdi
45: 5f                      pop    rdi
46: b8 87 00 40 00          mov    eax,0x400087
4b: ff d0                   call   rax
4d: 89 c7                   mov    edi,eax
4f: 48 83 c4 08             add    rsp,0x8
53: 55                      push   rbp
54: 5f                      pop    rdi
55: 48 83 ef 0c             sub    rdi,0xc
59: 57                      push   rdi
5a: 55                      push   rbp
5b: 5f                      pop    rdi
5c: 48 83 ef 04             sub    rdi,0x4
60: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
63: 57                      push   rdi
64: 55                      push   rbp
65: 5f                      pop    rdi
66: 48 83 ef 08             sub    rdi,0x8
6a: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
6d: 57                      push   rdi
6e: 58                      pop    rax
6f: 5f                      pop    rdi
70: 01 c7                   add    edi,eax
72: 58                      pop    rax
73: 89 38                   mov    DWORD PTR [rax],edi
75: 55                      push   rbp
76: 5f                      pop    rdi
77: 48 83 ef 04             sub    rdi,0x4
7b: 57                      push   rdi
7c: 55                      push   rbp
7d: 5f                      pop    rdi
7e: 48 83 ef 08             sub    rdi,0x8
82: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
85: 58                      pop    rax
86: 89 38                   mov    DWORD PTR [rax],edi
88: 55                      push   rbp
89: 5f                      pop    rdi
8a: 48 83 ef 08             sub    rdi,0x8
8e: 57                      push   rdi
8f: 55                      push   rbp
90: 5f                      pop    rdi
91: 48 83 ef 0c             sub    rdi,0xc
95: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
98: 58                      pop    rax
99: 89 38                   mov    DWORD PTR [rax],edi
</code></pre>
		<div class="content">はい、とりあえず for(;a&lt;127;) { print(a); __builtin_putchar(44); c = a+b; a = b; b = c; } が書けないのね</div>
		<div class="content">まあもうちょい削ったらいけるでしょ。削ります</div>
		<div class="content">よし！！！！いけた！！！！！</div>
		<div class="content">最終的なソースコードは以下の通り</div>
		<pre><code class="language-c">if_non0(n)
{
	if (n) {
		__builtin_putchar(n + 48);
	}
	else {
		__builtin_putchar(32);
	}
	return 0;
}

print(n)
{
	for (h = 0; n &gt;= 100; h = h + 1) {
		n = n - 100;
	}
	if_non0(h);
	for (t = 0; n &gt;= 10; t = t + 1) {
		n = n - 10;
	}
	if_non0(t);
	__builtin_putchar(n + 48);
	return 0;
}

printcomma(n)
{
	print(n);
	__builtin_putchar(44);
	return n;
}
main()
{
	a = 2;
	b = 1;
	while (a &lt; 127) {
		c = printcomma(a) + b;
		a = b;
		b = c;
	}
	return 0;
}
</code></pre>
		<div class="content">リュカ数列は知名度がないし、フィボナッチの例も足しておくか。上限を表すのに 255 とは書けないが、20*20などと書くことはできるので</div>
		<pre><code class="language-">thread &#x27;main&#x27; panicked at &#x27;while 文の中でジャンプするためのバッファの長さが i8 に収まりません。バッファの長さは 134、中身は 0x[55 5f 48 83 ef 04 48 8b 3f 57 bf 14 00 00 00 57 bf 14 00 00 00 57 58 5f 0f af f8 57 5f 58 39 f8 0f 9c c0 0f b6 f8 83 ff 00 74 5d 55 5f 48 83 ef 0c 57 48 83 ec 0c 55 5f 48 83 ef 04 48 8b 3f 57 5f b8 57 02 40 00 ff d0 89 c7 48 83 c4 0c 57 55 5f 48 83 ef 08 48 8b 3f 57 58 5f 01 c7 58 89 38 55 5f 48 83 ef 04 57 55 5f 48 83 ef 08 48 8b 3f 58 89 38 55 5f 48 83 ef 08 57 55 5f 48 83 ef 0c 48 8b 3f 58 89 38] です&#x27;, src/codegen.rs:327:21
</code></pre>
		<div class="content">そうでした～</div>
		<div class="content">まあ 89 まででいいか。そうなるとコードももうちょいシンプルにできて、</div>
		<pre><code class="language-c">print(n) { 
    for (t = 0; n &gt;= 10; t = t + 1) { 
        n = n - 10; 
    } 
    if (t) { 
        __builtin_putchar(t + 48); 
    } 
    else { 
        __builtin_putchar(32); 
    } 
    __builtin_putchar(n + 48); 
    return 0;
}
printcomma(n) {
    print(n);
    __builtin_putchar(44); 
    return n; 
} 
main() { 
    a = 0; b = 1; 
    while (a &lt; 100) { c = printcomma(a) + b; a = b; b = c; } 
    return 0; 
}
</code></pre>
		<div class="content">とすればよい。</div>
		<div class="content">終わらせたので、その旨をツイート</div>
		<div class="content"><a href="https://twitter.com/hsjoihs/status/1612090819871387648" target="_blank" rel="noopener noreferrer">https://twitter.com/hsjoihs/status/1612090819871387648</a></div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5371a23e1f567a57671ffbc0cbb9cc2f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5371a23e1f567a57671ffbc0cbb9cc2f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_5371a23e1f567a57671ffbc0cbb9cc2f" href="#permalink_5371a23e1f567a57671ffbc0cbb9cc2f" class="permalink">¶</a>
		<div class="content">はや</div>
		<div class="content">今再帰使えないっけ</div>
		<div class="content">あー関数のオフセットがいるのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_798b92b855a4df3d7920091fe1db1597').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_798b92b855a4df3d7920091fe1db1597').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_798b92b855a4df3d7920091fe1db1597" href="#permalink_798b92b855a4df3d7920091fe1db1597" class="permalink">¶</a>
		<div class="content">再帰できるようにしてからマージします？</div>
		<div class="content">そういえば、手元の非 M1 な Mac で試したら mktemp が illegal option で落ちましたね</div>
	</div>
</div>
<h3 class="date">2023年1月9日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bd8b07a1003b0e274f62c9986557f3cc').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bd8b07a1003b0e274f62c9986557f3cc').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_bd8b07a1003b0e274f62c9986557f3cc" href="#permalink_bd8b07a1003b0e274f62c9986557f3cc" class="permalink">¶</a>
		<div class="content">再帰大変そうーー</div>
		<div class="content">-dだめですっけ？</div>
		<div class="content">なんかオプション違ったようなー…</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2115427ca241d4c862c36ab469ad7f97').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2115427ca241d4c862c36ab469ad7f97').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_2115427ca241d4c862c36ab469ad7f97" href="#permalink_2115427ca241d4c862c36ab469ad7f97" class="permalink">¶</a>
		<div class="content">再帰わりとできそうな気がしたのでやってみるか</div>
		<div class="content">関数のオフセット自体は関数をコンパイルし始める直前に定まるので、その時点で関数テーブルに登録しておけば問題なく動くはずなんだよな</div>
		<pre><code class="language-">&#x27;else でジャンプするためのバッファの長さが i8 に収まりません。バッファの長さは 130、中身は 0x[55 5f 48 83 ef 04 48 8b 3f 57 bf 01 00 00 00 57 5f 58 39 f8 0f 94 c0 0f b6 f8 83 ff 00 74 0b bf 01 00 00 00 89 f8 c9 c3 eb 58 48 83 ec 08 55 5f 48 83 ef 04 48 8b 3f 57 bf 01 00 00 00 57 58 5f 29 c7 57 5f b8 a9 00 40 00 ff d0 89 c7 48 83 c4 08 57 48 83 ec 0c 55 5f 48 83 ef 04 48 8b 3f 57 bf 02 00 00 00 57 58 5f 29 c7 57 5f b8 a9 00 40 00 ff d0 89 c7 48 83 c4 0c 57 58 5f 01 c7 89 f8 c9 c3] です&#x27;, src/codegen.rs:303:41
</code></pre>
		<div class="content">ギリ足らんか。とはいえ else { return fib(n-1) + fib(n-2); } がコンパイルできないのは厳しいな。</div>
		<div class="content">まあ else の外に出してやればよく、はい普通に動いた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d63f3e4b7b16a3eebd5dd608c256073c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d63f3e4b7b16a3eebd5dd608c256073c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d63f3e4b7b16a3eebd5dd608c256073c" href="#permalink_d63f3e4b7b16a3eebd5dd608c256073c" class="permalink">¶</a>
		<div class="content">すご</div>
		<div class="content">定義時点のバイナリサイズをHashMapに突っ込めばいいのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f0684c7919a40c46903328ad3327ae32').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f0684c7919a40c46903328ad3327ae32').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_f0684c7919a40c46903328ad3327ae32" href="#permalink_f0684c7919a40c46903328ad3327ae32" class="permalink">¶</a>
		<div class="content">そういうことです</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0e0070b63b7b00f589b59bae5db516aa').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0e0070b63b7b00f589b59bae5db516aa').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_0e0070b63b7b00f589b59bae5db516aa" href="#permalink_0e0070b63b7b00f589b59bae5db516aa" class="permalink">¶</a>
		<div class="content">確かに、宣言+後ろで定義してある関数に飛ぶのはめんどくさそう…</div>
		<div class="content">少なくともワンパスじゃ多分無理😢</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4eed10a677f82fe47df78c69e235a865').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4eed10a677f82fe47df78c69e235a865').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4eed10a677f82fe47df78c69e235a865" href="#permalink_4eed10a677f82fe47df78c69e235a865" class="permalink">¶</a>
		<div class="content">現状の Buf を改造して、「名前付き穴」みたいなものを書けるようにし、.to_vec() で最終的に書き込むときにその「名前付き穴」を解決する、といった実装が一番シンプルなのかな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1554de221ead0d6a299d5d2254d0290d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1554de221ead0d6a299d5d2254d0290d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1554de221ead0d6a299d5d2254d0290d" href="#permalink_1554de221ead0d6a299d5d2254d0290d" class="permalink">¶</a>
		<div class="content">そうなんよなあ</div>
		<div class="content">ジャンプ先って可変長整数だっけ、そうだとしんでしまう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5cdb38a6cf6ca88c30d3560b8ceee5be').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5cdb38a6cf6ca88c30d3560b8ceee5be').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_5cdb38a6cf6ca88c30d3560b8ceee5be" href="#permalink_5cdb38a6cf6ca88c30d3560b8ceee5be" class="permalink">¶</a>
		<div class="content">実はね～（ログを見てもらうと分かる通り、ジャンプ先が現在 8 bit 固定なのでかなりのショートコーディングを強いられています）</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_ed0ce9ec86d97509fcba3b5d91e565d2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_ed0ce9ec86d97509fcba3b5d91e565d2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_ed0ce9ec86d97509fcba3b5d91e565d2" href="#permalink_ed0ce9ec86d97509fcba3b5d91e565d2" class="permalink">¶</a>
		<div class="content">わかる…</div>
		<div class="content">多分jmp命令って7bitで収まるなら1byte、14bitで収まるなら2byteみたいな感じな気がする😇😇</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_302b7612f27e464c2a0ea3c2f094bda1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_302b7612f27e464c2a0ea3c2f094bda1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_302b7612f27e464c2a0ea3c2f094bda1" href="#permalink_302b7612f27e464c2a0ea3c2f094bda1" class="permalink">¶</a>
		<div class="content">まあとりあえず、最後に「フィボナッチ数列を再帰で計算しつつ表示」を達成してからマージしてもらう、としようかな</div>
		<div class="content">ジャンプ先を 127 以内に収めながらのコーディングをもう一回やってみるか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_85783e02b69bb9e2450e9bbb55d920c5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_85783e02b69bb9e2450e9bbb55d920c5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_85783e02b69bb9e2450e9bbb55d920c5" href="#permalink_85783e02b69bb9e2450e9bbb55d920c5" class="permalink">¶</a>
		<div class="content">コードゴルフ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c4e98871f15e9ffc9b84c0a1b6dd5ed6').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c4e98871f15e9ffc9b84c0a1b6dd5ed6').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_c4e98871f15e9ffc9b84c0a1b6dd5ed6" href="#permalink_c4e98871f15e9ffc9b84c0a1b6dd5ed6" class="permalink">¶</a>
		<div class="content">ブロックの中をなるべく短くすることだけが必要なので、全体のコード長自体はむしろ増やす方向ですわね</div>
		<div class="content">できた</div>
		<pre><code class="language-c">if_non0(n) { if (n) { __builtin_putchar(n + 48); } else { __builtin_putchar(32); } return 0; } print(n) { for(h=0;n&gt;=100;h=h+1){n=n-100;} if_non0(h); for(t=0;n&gt;=10;t=t+1){n=n-10;} if_non0(t); __builtin_putchar(n + 48); return 0; } printcomma(n) { print(n); __builtin_putchar(44); return n; } fib(n) { if(n == 0){ return 0; } else if(n == 1) { return 1; } return fib(n-1) + fib(n-2); } main() { for(n=0;n&lt;17;n=n+1) {printcomma(fib(n));} return 0; }
</code></pre>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer"><img alt="れもん" class="icon" src="icons/れもん.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_76a4d48f1cae9b6ba1e58023e64d2065').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_76a4d48f1cae9b6ba1e58023e64d2065').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer">れもん</a></span><a id="permalink_76a4d48f1cae9b6ba1e58023e64d2065" href="#permalink_76a4d48f1cae9b6ba1e58023e64d2065" class="permalink">¶</a>
		<div class="content">別に最適化しないなら2byteだけ使っていればよいと思います</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c76d0178ce20054ba17cc5dbd6a4daf2').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c76d0178ce20054ba17cc5dbd6a4daf2').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_c76d0178ce20054ba17cc5dbd6a4daf2" href="#permalink_c76d0178ce20054ba17cc5dbd6a4daf2" class="permalink">¶</a>
		<div class="content">あ、それできるのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer"><img alt="れもん" class="icon" src="icons/れもん.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4641277a6c2b648dfbc5bfa6258e570a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4641277a6c2b648dfbc5bfa6258e570a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/_lem0n_" target="_blank" rel="noopener noreferrer">れもん</a></span><a id="permalink_4641277a6c2b648dfbc5bfa6258e570a" href="#permalink_4641277a6c2b648dfbc5bfa6258e570a" class="permalink">¶</a>
		<div class="content">あてかどうせならオペランドに4byte入る0xe9をどうぞ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b3e0e71a4ec0d90fb633c0b1cb964f8e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b3e0e71a4ec0d90fb633c0b1cb964f8e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_b3e0e71a4ec0d90fb633c0b1cb964f8e" href="#permalink_b3e0e71a4ec0d90fb633c0b1cb964f8e" class="permalink">¶</a>
		<div class="content">それでよさそう</div>
	</div>
</div>
<h3 class="date">2023年1月14日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6de01dcb3383edb142eaba8d247ece8b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6de01dcb3383edb142eaba8d247ece8b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_6de01dcb3383edb142eaba8d247ece8b" href="#permalink_6de01dcb3383edb142eaba8d247ece8b" class="permalink">¶</a>
		<div class="content">さて次は単項&amp;と単項*だからわりと簡単そう</div>
		<div class="content">と思いきや、今まで 4 バイトと 8 バイトを雑に扱ってたのを直さないといけないからちょっとめんどいかもね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d28fabc190a2aa3e1148fa7bf5167feb').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d28fabc190a2aa3e1148fa7bf5167feb').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d28fabc190a2aa3e1148fa7bf5167feb" href="#permalink_d28fabc190a2aa3e1148fa7bf5167feb" class="permalink">¶</a>
		<div class="content">忘れてた。来週の予定までにそこまでは終わらせておこう</div>
	</div>
</div>
<h3 class="date">2023年1月15日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_22947e1595d5eceaecea02afbb480165').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_22947e1595d5eceaecea02afbb480165').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_22947e1595d5eceaecea02afbb480165" href="#permalink_22947e1595d5eceaecea02afbb480165" class="permalink">¶</a>
		<div class="content">とりあえず雑に実装</div>
		<div class="content">*がセグフォする</div>
		<div class="content">とりあえずcodegen系関数に引き回すstate多くなってきたので構造体にまとめた</div>
		<div class="content">word sizeを64bitにしたけどセグフォがなおらん〜〜〜</div>
		<div class="content">*&amp;x はいけるけど y=&amp;x の時 *y はセグフォになる、変数の値の読み書き死んでるなこれ</div>
		<div class="content">mov [rax], edi -&gt; mov [rax], rdi にしたらなおった</div>
		<div class="content">add命令を64bit化したらテスト2も通るようになった。ついでにsub/mulも64bit化</div>
	</div>
</div>
<h3 class="date">2023年1月16日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_fc31c67c88a05f3a4e02a9cd76810015').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_fc31c67c88a05f3a4e02a9cd76810015').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_fc31c67c88a05f3a4e02a9cd76810015" href="#permalink_fc31c67c88a05f3a4e02a9cd76810015" class="permalink">¶</a>
		<div class="content">レビューをしていくか</div>
		<div class="content">mulにだけ0x48がついてませんね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1dfe620b9a215081b3a83d8f347dbce4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1dfe620b9a215081b3a83d8f347dbce4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_1dfe620b9a215081b3a83d8f347dbce4" href="#permalink_1dfe620b9a215081b3a83d8f347dbce4" class="permalink">¶</a>
		<div class="content">あれ、ミスってた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5515aa0eef88a8d294d1def2e08e8205').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5515aa0eef88a8d294d1def2e08e8205').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_5515aa0eef88a8d294d1def2e08e8205" href="#permalink_5515aa0eef88a8d294d1def2e08e8205" class="permalink">¶</a>
		<div class="content">この U32_WORD_SIZE って変数名、u32 そのものの size っぽく読めてしまって紛らわしいので、WORD_SIZE_AS_U32 みたいな変数名にしたほうがよいと思います</div>
		<div class="content">あと、トークンの方は Mul じゃなくて Asterisk にリネームしてもいいのかもですね。意味が 2 種類現れるようになったし。まあこのブランチをマージしたあとのリファクタリングとしてやってもいいか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_9f27abf71b3449ae4a11976235b813ba').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_9f27abf71b3449ae4a11976235b813ba').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_9f27abf71b3449ae4a11976235b813ba" href="#permalink_9f27abf71b3449ae4a11976235b813ba" class="permalink">¶</a>
		<div class="content">ですよねー</div>
	</div>
</div>
<h3 class="date">2023年1月17日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8610a519df99634382db90415ddd37dd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8610a519df99634382db90415ddd37dd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8610a519df99634382db90415ddd37dd" href="#permalink_8610a519df99634382db90415ddd37dd" class="permalink">¶</a>
		<div class="content">step 17 さっさとやっちゃうか</div>
		<div class="content">とりあえず、「関数はいままでfoo(x, y)といった形で書いていましたが、これをint foo(int x, int y)といった形になるように改造します。」が一番ラクなので、これをまずやる</div>
		<div class="content">えーと FunctionDefinition を生成しているところをいじればいいんだから</div>
		<div class="content">FunctionDefinition 型の定義を変更</div>
		<pre><code class="language-rust">pub struct FunctionDefinition {
    pub func_name: String,
    pub params: Vec&lt;(Type, ParameterIdentifier)&gt;,
    pub pos: usize,
    pub content: FunctionContent,
    pub return_type: Type
}
</code></pre>
		<div class="content">として型の情報を足せばよく、</div>
		<div class="content">トークナイザに予約語 int を足す必要もある</div>
		<div class="content">関数定義のパースに int をねじ込んだので、今度はテストケースに int を入れていく必要がある</div>
		<div class="content">足したはずなのに「トップレベルが型名でないもので始まっています」で落ちる。なぜだろう</div>
		<div class="content">あー理解。&#x60;Identifier(&quot;__start&quot;)&#x60; で始まってると言われている。つまり、__start を C で書いてるからそこも直さなきゃいけない</div>
		<div class="content">直した。テストが全部通ったのでコミット</div>
		<div class="content">あとは、「変数定義文」「未定義変数をエラー」の二つだな</div>
		<div class="content">こうなると、idents って HashMap を local_var_table に、functions って HashMap を function_table にしたくなる。しておこう</div>
		<div class="content">次に、パーサーに変数定義文を足す。「真にいにしえの C」と同様に、関数の頭でだけ変数定義ができるようにしておこう</div>
		<div class="content">after_param_list で関数の中身を読んでるので、そこの冒頭で変数宣言を読めるようにしよう</div>
		<div class="content">とりあえず local_var_definitions という HashMap に読み込んでおくか</div>
		<div class="content">で、それを FunctionDefinition に仕込んでおいて、</div>
		<div class="content">えーと未定義変数は Codegen で怒るか。えーっと local_var_table が Codegen にあるのは間違いで</div>
		<div class="content">あー、ちゃんと tkr もその問題に気づいていて「TODO: FunctionGenみたいなのに分けたい」というコメントが書いてあるな</div>
		<div class="content">まあとりあえず、先に変数宣言をちゃんと読めているかをテストしよう</div>
		<div class="content">読めているのでコミット</div>
		<div class="content">さてリファクタリングしたい。とりあえず、CodeGen 自体を FunctionGen へと改名し、必要に応じて FunctionGen から追い出していこう</div>
		<div class="content">リファクタリングした。『関数をコード生成しメインバッファとグローバル関数テーブルに挿入』だけを FunctionGen から追い出すだけで済んだ</div>
		<div class="content">そうしたら、今度は FunctionGen に『関数先頭で宣言されている変数の一覧』を渡して、それと照合してエラーを出せばよい</div>
		<div class="content">走らせてみると……関数の仮引数についても『知らん』と言われる。それはそう。なのでそいつらも合わせてやろう</div>
		<div class="content">ちなみに、関数の先頭で宣言された変数は、関数の仮引数と同じスコープを持ち、名前がかぶってはいけない、というのが C の仕様なので、本当に等価に扱えばよい</div>
		<div class="content">よし、実装できた</div>
		<div class="content">おや～未定義動作を含む x = 3; y = 5; z = &amp;y + 8; return *z; が CI でだけ落ちる。もういいや、未定義動作だしこのテストケースはコメントアウトしよう</div>
	</div>
</div>
<h3 class="date">2023年1月18日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2f3642b2089a7f5a7f5a23669811c039').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2f3642b2089a7f5a7f5a23669811c039').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_2f3642b2089a7f5a7f5a23669811c039" href="#permalink_2f3642b2089a7f5a7f5a23669811c039" class="permalink">¶</a>
		<div class="content">FunctionGen の外側の Codegen は今のところ複雑じゃないしまだ分けなくていいか(グローバル変数の定義とか出てきたら考えましょう)</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_38701f51b626d592824be5dd85489d09').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_38701f51b626d592824be5dd85489d09').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_38701f51b626d592824be5dd85489d09" href="#permalink_38701f51b626d592824be5dd85489d09" class="permalink">¶</a>
		<div class="content">そうね</div>
		<div class="content">tkr 担当の step 18 は簡単で、その次の私がやる step 19 は alloc4(&amp;p, 1, 2, 4, 8) ができるようにしなきゃいけないんだよな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4175e2498eb0e441bad5ea9c181519f9').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4175e2498eb0e441bad5ea9c181519f9').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_4175e2498eb0e441bad5ea9c181519f9" href="#permalink_4175e2498eb0e441bad5ea9c181519f9" class="permalink">¶</a>
		<div class="content">とりあえず来週火曜まではお休みで…(発表あるので)</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2ba0d4e719694ccd13b8efbb97545918').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2ba0d4e719694ccd13b8efbb97545918').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_2ba0d4e719694ccd13b8efbb97545918" href="#permalink_2ba0d4e719694ccd13b8efbb97545918" class="permalink">¶</a>
		<div class="content">了解です。私も授業が第二週に入ったのでそろそろ学業を真面目にやらんとあかん</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_41eb6acadc6a0385903d30be96aac8c5').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_41eb6acadc6a0385903d30be96aac8c5').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_41eb6acadc6a0385903d30be96aac8c5" href="#permalink_41eb6acadc6a0385903d30be96aac8c5" class="permalink">¶</a>
		<div class="content">あ、1.5年修士だからまだ忙しいのか</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_eee7e831bd9df87b9e9b0f58475708c1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_eee7e831bd9df87b9e9b0f58475708c1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_eee7e831bd9df87b9e9b0f58475708c1" href="#permalink_eee7e831bd9df87b9e9b0f58475708c1" class="permalink">¶</a>
		<div class="content">そういうことです（てか今学期末で卒業予定なので）</div>
		<div class="content">とりあえず brk() の使い方を雑に理解したので組めそうだな</div>
		<div class="content">この二つのリンクを残しておけば 2 週間後のわたしがサクッと組んでくれるでしょう</div>
		<div class="content"><a href="https://github.com/ushitora-anqou/aqcc/blob/master/as/stdlib.c" target="_blank" rel="noopener noreferrer">https://github.com/ushitora-anqou/aqcc/blob/master/as/stdlib.c</a></div>
		<div class="content"><a href="https://stackoverflow.com/questions/6988487/what-does-the-brk-system-call-do" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/6988487/what-does-the-brk-system-call-do</a></div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8d23896fc6ab65cd367bc24d22a05c9c').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8d23896fc6ab65cd367bc24d22a05c9c').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_8d23896fc6ab65cd367bc24d22a05c9c" href="#permalink_8d23896fc6ab65cd367bc24d22a05c9c" class="permalink">¶</a>
		<div class="content">ポインタ+1確かに+1じゃないのかこれ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_389364df37dc2b4ec72fa37beb3365fd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_389364df37dc2b4ec72fa37beb3365fd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_389364df37dc2b4ec72fa37beb3365fd" href="#permalink_389364df37dc2b4ec72fa37beb3365fd" class="permalink">¶</a>
		<div class="content">そうなのよね</div>
		<div class="content">とりあえず小さなリファクタリングだけ入れといたので一応 review を request しておく</div>
		<blockquote>パーサを式のとトップレベルのとに分ける
いちいち std::mem::take するのが面倒なので Buf::append を実装する
</blockquote>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_d43327dfd585f8fb42ad7ccb7b2a176f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_d43327dfd585f8fb42ad7ccb7b2a176f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_d43327dfd585f8fb42ad7ccb7b2a176f" href="#permalink_d43327dfd585f8fb42ad7ccb7b2a176f" class="permalink">¶</a>
		<div class="content">approve</div>
	</div>
</div>
<h3 class="date">2023年1月30日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_29e62b088bb8b5342578faa27d2844d7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_29e62b088bb8b5342578faa27d2844d7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_29e62b088bb8b5342578faa27d2844d7" href="#permalink_29e62b088bb8b5342578faa27d2844d7" class="permalink">¶</a>
		<div class="content">パーサを修正してcodegenを少しいじるだけでよさそう</div>
		<div class="content">ポインタ型ではないものをderefしたらエラーとかは今のところは不要みたい</div>
	</div>
</div>
<h3 class="date">2023年1月31日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_1c5a28d6fa223c19fa88b541cc752834').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_1c5a28d6fa223c19fa88b541cc752834').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_1c5a28d6fa223c19fa88b541cc752834" href="#permalink_1c5a28d6fa223c19fa88b541cc752834" class="permalink">¶</a>
		<div class="content">うわこの Addr と Deref の処理が対比的になってなくてかなり読みづらいな。バグあるんじゃないかと疑ってしまった。でも合ってはいるのでマージします</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_579c7c554466b282227cbd90397ccd3f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_579c7c554466b282227cbd90397ccd3f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_579c7c554466b282227cbd90397ccd3f" href="#permalink_579c7c554466b282227cbd90397ccd3f" class="permalink">¶</a>
		<div class="content">左辺値処理との一貫性を取ったらこっちが不一貫になっちゃった</div>
		<div class="content">新幹線の中でやったから酔ったけど、大した分量なかった</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b34631d40e37e46fdfa2d4e910ee6d03').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b34631d40e37e46fdfa2d4e910ee6d03').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_b34631d40e37e46fdfa2d4e910ee6d03" href="#permalink_b34631d40e37e46fdfa2d4e910ee6d03" class="permalink">¶</a>
		<div class="content">ステップ 18 はね</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_27df7531112bc050d3d607c1f7b0b3ac').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_27df7531112bc050d3d607c1f7b0b3ac').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_27df7531112bc050d3d607c1f7b0b3ac" href="#permalink_27df7531112bc050d3d607c1f7b0b3ac" class="permalink">¶</a>
		<div class="content">ステップ 19 大変そう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_327b13a6c2cd44d34501215d3ed8bdfd').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_327b13a6c2cd44d34501215d3ed8bdfd').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_327b13a6c2cd44d34501215d3ed8bdfd" href="#permalink_327b13a6c2cd44d34501215d3ed8bdfd" class="permalink">¶</a>
		<div class="content">そうそう。型をつけて回んなきゃいけない</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_631530858ee8b7e71b5d0d56efcfca9a').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_631530858ee8b7e71b5d0d56efcfca9a').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_631530858ee8b7e71b5d0d56efcfca9a" href="#permalink_631530858ee8b7e71b5d0d56efcfca9a" class="permalink">¶</a>
		<div class="content">型をつけてそれに応じて分岐とか面倒そう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_b24dcc252f9d89a77d3b34a3f66d4d6d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_b24dcc252f9d89a77d3b34a3f66d4d6d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_b24dcc252f9d89a77d3b34a3f66d4d6d" href="#permalink_b24dcc252f9d89a77d3b34a3f66d4d6d" class="permalink">¶</a>
		<div class="content">UntypedExpr からなる構文木を元に、TypedExpr からなる構文木を再構築する手と、構文木に漸次的に型をつけていく方法がある</div>
		<div class="content">私はどちらかというと前者が好み</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5438ff3359500b193bdd4c5d63b401a3').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5438ff3359500b193bdd4c5d63b401a3').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_5438ff3359500b193bdd4c5d63b401a3" href="#permalink_5438ff3359500b193bdd4c5d63b401a3" class="permalink">¶</a>
		<div class="content">そうよね。とはいえ面倒そう</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_99c23e3b911016aa998ee6c8b8a4edb7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_99c23e3b911016aa998ee6c8b8a4edb7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_99c23e3b911016aa998ee6c8b8a4edb7" href="#permalink_99c23e3b911016aa998ee6c8b8a4edb7" class="permalink">¶</a>
		<div class="content">まあ、まず恒等変換を書いて、その後に TypedExpr に型フィールドを要求してエラーが出たところをどんどん直すだけ。そんなに難しくはない</div>
		<div class="content">ということで、ステップ 19</div>
		<div class="content">Expr を UntypedExpr に改名しようかと思ったが、Rust だしジェネリックパラメータに空タプル or 型情報でやればいいか</div>
		<div class="content">空タプルを使うのもどうかと思うので、Any という名のゼロサイズ型を定義し、そいつをつけてまわることで、とりあえず UntypedExpr 化に成功</div>
		<div class="content">で、次に local_var_declarations を Context という名前の中に突っ込み、そいつを parse_statement につけてまわる</div>
		<div class="content">えーと関数定義から関数宣言を取り出してそいつも引き回さないといけない</div>
		<div class="content">んー、C だし『構文木に漸次的に型をつけていく方法』で十分だな。もうそっちにしよう</div>
		<div class="content">よし、一応一時間でできたな。スタートアップには main の定義を教えてやる必要があり、よしコンパイルが通った。実行じゃ</div>
		<div class="content">えーーとはい、『ビルトイン関数の宣言がない』『仮引数の宣言を知らされていない』というエラーが。至極ごもっとも</div>
		<div class="content">その二つの情報を教えると…『関数 fib は宣言されておらず、戻り値の型が分かりません』。あーはい。再帰のためには自身の戻り値の型をちゃんと教えないといけない</div>
		<div class="content">教えてやると……よ〜しできたできた</div>
		<div class="content">で、現状だと +933 -625 とあまりに diff が大きすぎる。しかしこれの大部分は式パーサーを impl Context にしたことによるインデントの変更なんだよな</div>
		<div class="content">これは本質ではないので、ちょっと先に diff を小さくする作業をしていくか</div>
		<div class="content">impl Context ではなく明示的に第一引数として引き回すようにする</div>
		<div class="content">なんかパソコンが重い</div>
		<div class="content">うおー Docker が変なエラーメッセージを吐いた。パソコン再起動</div>
		<div class="content">よし、diff が +410 -95 にまで減った</div>
		<div class="content">あとは、結局 Any を使わなかったので、それも削ろう</div>
		<div class="content">そしてジェネリクスにする必要ももはやないので、削る</div>
		<div class="content">これで +384 -70 で済んだ</div>
		<div class="content">あと、定義が</div>
		<pre><code class="language-rust">pub enum Expr {
    BinaryExpr {
        op: BinaryOp,
        op_pos: usize,
        左辺: Box&lt;Expr&gt;,
        右辺: Box&lt;Expr&gt;,
        typ: Type,
    },
    Numeric {
        val: u8,
        pos: usize,
        typ: Type,
    },
    Identifier {
        ident: String,
        pos: usize,
        typ: Type,
    },
    Call {
        ident: String,
        pos: usize,
        args: Vec&lt;Expr&gt;,
        typ: Type,
    },
    UnaryExpr {
        op: UnaryOp,
        op_pos: usize,
        expr: Box&lt;Expr&gt;,
        typ: Type,
    },
}
</code></pre>
		<div class="content">になってて、全部に typ を書いているのもあんまり賢くないんだよな。とはいえこれを変えると diff が増えるので今は放置しよう（本末転倒）</div>
		<div class="content">さて、じゃあ本題の『ポインタの加減算で sizeof を見る』を実装していきますか</div>
		<div class="content">足し算のときの変換を実装</div>
		<div class="content">引き算のときの変換を実装</div>
		<div class="content">さて、問題はこれをどうテストするかで、compilerbook には</div>
		<blockquote>この段階ではまだ連続してメモリをアロケートする方法がないので（我々のコンパイラにはまだ配列がない）、テストを書くのはちょっと大変です。ここは単に外部のコンパイラの助けを借りて、そちらのほうでmallocすることにして、自分のコンパイラの出力ではそのヘルパー関数を使ってテストを書くようにしてみてください。
</blockquote>
		<div class="content">とある。しかし我々は外部のコンパイラの生成したオブジェクトファイルとリンクできないので、これまたコンパイラディレクティブを新造しなければならない</div>
		<div class="content">さて、ここでログを遡ると、『この二つのリンクを残しておけば 2 週間後のわたしがサクッと組んでくれるでしょう』と 2 週間前の私が以下の二つのリンクを書き残している。</div>
		<div class="content"><a href="https://github.com/ushitora-anqou/aqcc/blob/master/as/stdlib.c" target="_blank" rel="noopener noreferrer">https://github.com/ushitora-anqou/aqcc/blob/master/as/stdlib.c</a></div>
		<div class="content"><a href="https://stackoverflow.com/questions/6988487/what-does-the-brk-system-call-do" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/6988487/what-does-the-brk-system-call-do</a></div>
		<div class="content">これが伏線回収ってやつですね</div>
		<div class="content">さて、これらのリンクを読んでいく限り、</div>
		<pre><code class="language-c">#include &lt;unistd.h&gt;

int brk(void* end_data_segment);
void *sbrk(intptr_t increment);

int alloc4(int **pp, int a, int b, int c, int d) {
    int *p = sbrk(0);
    brk(p + 4);
    p[0] = a;
    p[1] = b;
    p[2] = c;
    p[3] = d;
    *pp = p;
    return 0;
}
</code></pre>
		<div class="content">として alloc4 は実装できそうだ。wandbox でも試してみよう</div>
		<pre><code class="language-c">#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;

int brk(void* end_data_segment);
void *sbrk(intptr_t increment);

int alloc4(int **pp, int a, int b, int c, int d) {
    int *p = sbrk(0);
    brk(p + 4);
    p[0] = a;
    p[1] = b;
    p[2] = c;
    p[3] = d;
    *pp = p;
    return 0;
}

int main() {
    int *p;
    alloc4(&amp;p, 1, 2, 4, 8);
    int *q;
    q = p + 2;
    printf(&quot;%d, &quot;, *q); // 4
    q = p + 3;
    printf(&quot;%d\n&quot;, *q); // 8
    return 0;
}
</code></pre>
		<div class="content"><a href="https://wandbox.org/permlink/Z7DfkoQk7CX4QxVC" target="_blank" rel="noopener noreferrer">https://wandbox.org/permlink/Z7DfkoQk7CX4QxVC</a></div>
		<div class="content">ちゃんと動いてますね。もちろんたまたま動いているだけかもしれんけど</div>
		<div class="content">ん？ ushitora-anqou 実装では最初にゼロ渡すのもその後に拡張するのも両方 syscall(12, addr) で実装しているけど、これでいいの？</div>
		<div class="content">なるほど、 <a href="https://man7.org/linux/man-pages/man2/brk.2.html" target="_blank" rel="noopener noreferrer">https://man7.org/linux/man-pages/man2/brk.2.html</a> に書いてある。</div>
		<blockquote>However, the actual Linux system call returns the new program break on success.  On failure, the system call returns the current break.
</blockquote>
		<div class="content">理解。なので、syscall(12, NULL) を最初に走らせて現在の break 位置を知り、その後にその現在の break 位置から必要量だけ増やした位置を syscall(12, new_break) すれば動くのか</div>
		<div class="content">さて、こいつは 5 引数関数だから……あ、第一引数ポインタだから『rbpにoffsetを足した位置にediを代入』で事故りそう</div>
		<div class="content">まあいいや、とりあえず戻り値にポインタ入れちゃおう</div>
		<div class="content">あとはアセンブリプログラミングを頑張り、えーっとこうすればスタックを使わないからアラインメントも気にしなくてよくなって</div>
		<div class="content">よし、実装できた。あとはこれをコンパイラに教え、呼ぶだけだ</div>
		<div class="content">運命の時！</div>
		<blockquote>[FAIL] int main() { int *p; p = __builtin_alloc4(1, 2, 4, 8); return *p + *(p+1) + *(p+2) + *(p+3); } =&gt; 15 expected, but got 1
</blockquote>
		<div class="content">おや～？</div>
		<div class="content">えーと testwork フォルダ内に当該バイナリがあるはず。一旦 rm -rf testwork/* してから ./test.sh することにより ./a.out が手に入る</div>
		<div class="content">とりあえず failing.out とかいう名前を付けて一旦コミットし、この検体を分析しよう</div>
		<pre><code class="language-">hsjoihs@LAPTOP-BKHPSENK:~/c-compilers/c_to_elf_compiler$ gdb failing.out
GNU gdb (Ubuntu 9.2-0ubuntu1~20.04.1) 9.2
Copyright (C) 2020 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type &quot;show copying&quot; and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.

For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
Reading symbols from failing.out...
(No debugging symbols found in failing.out)
(gdb) run
Starting program: /home/hsjoihs/c-compilers/c_to_elf_compiler/failing.out 
[Inferior 1 (process 10911) exited with code 01]
(gdb) start
No symbol table is loaded.  Use the &quot;file&quot; command.
Make breakpoint pending on future shared library load? (y or [n]) y
Temporary breakpoint 1 (-qualified main) pending.
Starting program: /home/hsjoihs/c-compilers/c_to_elf_compiler/failing.out 
[Inferior 1 (process 10945) exited with code 01]
(gdb) file
No executable file now.
No symbol file now.
(gdb) 
</code></pre>
		<div class="content">え～っと run は動くが start も file も効かない。どうしようかな。あ、file failing.out なら動いた。そうするのか</div>
		<div class="content">いや stepi できないな。もういい、objdump する</div>
		<pre><code class="language-">hsjoihs@LAPTOP-BKHPSENK:~/c-compilers/c_to_elf_compiler$ objdump -d failing.out

failing.out:     file format elf64-x86-64
</code></pre>
		<div class="content">うお～ section が存在しないから disass されない</div>
		<div class="content">もういいや、バイナリエディタを開いて、中身を <a href="https://defuse.ca/online-x86-assembler.htm" target="_blank" rel="noopener noreferrer">https://defuse.ca/online-x86-assembler.htm</a> に突っ込んで、</div>
		<pre><code class="language-">えーとこれが __builtin_putchar よね。あれ？__builtin_three はどこ行った？
0:  55                      push   rbp
1:  48 89 e5                mov    rbp,rsp
4:  48 83 ec 08             sub    rsp,0x8
8:  89 7d f8                mov    DWORD PTR [rbp-0x8],edi
b:  b8 01 00 00 00          mov    eax,0x1
10: bf 01 00 00 00          mov    edi,0x1
15: 48 8d 75 f8             lea    rsi,[rbp-0x8]
19: ba 01 00 00 00          mov    edx,0x1
1e: 0f 05                   syscall
20: c9                      leave
21: c3                      ret

次にこれが __builtin_alloc4 だけど……あっプロローグでローカル変数の分の引き算をしていない！！これだ
22: 55                      push   rbp
23: 48 89 e5                mov    rbp,rsp
26: 48 83 ec 08             sub    rsp,0x8
2a: 89 7d f8                mov    DWORD PTR [rbp-0x8],edi
2d: 89 75 f0                mov    DWORD PTR [rbp-0x10],esi
30: 89 55 e8                mov    DWORD PTR [rbp-0x18],edx
33: 89 4d e0                mov    DWORD PTR [rbp-0x20],ecx
36: b8 0c 00 00 00          mov    eax,0xc
3b: bf 00 00 00 00          mov    edi,0x0
40: 0f 05                   syscall
42: 50                      push   rax
43: 5f                      pop    rdi
44: b8 10 00 00 00          mov    eax,0x10
49: 48 01 c7                add    rdi,rax
4c: b8 0c 00 00 00          mov    eax,0xc
51: 0f 05                   syscall
53: 48 83 e8 04             sub    rax,0x4
57: 48 8d 7d e0             lea    rdi,[rbp-0x20]
5b: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
5e: 48 89 38                mov    QWORD PTR [rax],rdi
61: 48 83 e8 04             sub    rax,0x4
65: 48 8d 7d e8             lea    rdi,[rbp-0x18]
69: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
6c: 48 89 38                mov    QWORD PTR [rax],rdi
6f: 48 83 e8 04             sub    rax,0x4
73: 48 8d 7d f0             lea    rdi,[rbp-0x10]
77: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
7a: 48 89 38                mov    QWORD PTR [rax],rdi
7d: 48 83 e8 04             sub    rax,0x4
81: 48 8d 7d f8             lea    rdi,[rbp-0x8]
85: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
88: 48 89 38                mov    QWORD PTR [rax],rdi
8b: c9                      leave
8c: c3                      ret
</code></pre>
		<div class="content">はい～単純な凡ミス。これを直して………あれ？？？まだ通らない。なにゆえ～</div>
		<div class="content">とりあえず、もう一回検体を生成しよう</div>
		<pre><code class="language-">ああ普通に __builtin_three あるね。さっきはコピペ範囲をミスっただけか
0:  55                      push   rbp
1:  48 89 e5                mov    rbp,rsp
4:  48 83 ec 00             sub    rsp,0x0
8:  b8 03 00 00 00          mov    eax,0x3
d:  c9                      leave
e:  c3                      ret

次にこれが __builtin_putchar で、
f:  55                      push   rbp
10: 48 89 e5                mov    rbp,rsp
13: 48 83 ec 08             sub    rsp,0x8
17: 89 7d f8                mov    DWORD PTR [rbp-0x8],edi
1a: b8 01 00 00 00          mov    eax,0x1
1f: bf 01 00 00 00          mov    edi,0x1
24: 48 8d 75 f8             lea    rsi,[rbp-0x8]
28: ba 01 00 00 00          mov    edx,0x1
2d: 0f 05                   syscall
2f: c9                      leave
30: c3                      ret

お次のこれが __builtin_alloc4 のはず。今度はちゃんと 0x20 を引いてるんだけどなぁ
31: 55                      push   rbp
32: 48 89 e5                mov    rbp,rsp
35: 48 83 ec 20             sub    rsp,0x20
39: 89 7d f8                mov    DWORD PTR [rbp-0x8],edi
3c: 89 75 f0                mov    DWORD PTR [rbp-0x10],esi
3f: 89 55 e8                mov    DWORD PTR [rbp-0x18],edx
42: 89 4d e0                mov    DWORD PTR [rbp-0x20],ecx
45: b8 0c 00 00 00          mov    eax,0xc
4a: bf 00 00 00 00          mov    edi,0x0
4f: 0f 05                   syscall
51: 50                      push   rax
52: 5f                      pop    rdi
53: b8 10 00 00 00          mov    eax,0x10
58: 48 01 c7                add    rdi,rax
5b: b8 0c 00 00 00          mov    eax,0xc
60: 0f 05                   syscall
62: 48 83 e8 04             sub    rax,0x4
66: 48 8d 7d e0             lea    rdi,[rbp-0x20]
6a: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
6d: 48 89 38                mov    QWORD PTR [rax],rdi
70: 48 83 e8 04             sub    rax,0x4
74: 48 8d 7d e8             lea    rdi,[rbp-0x18]
78: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
7b: 48 89 38                mov    QWORD PTR [rax],rdi
7e: 48 83 e8 04             sub    rax,0x4
82: 48 8d 7d f0             lea    rdi,[rbp-0x10]
86: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
89: 48 89 38                mov    QWORD PTR [rax],rdi
8c: 48 83 e8 04             sub    rax,0x4
90: 48 8d 7d f8             lea    rdi,[rbp-0x8]
94: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
97: 48 89 38                mov    QWORD PTR [rax],rdi
9a: c9                      leave
9b: c3                      ret

で、こいつが今回試されるべき int main() { int *p; p = __builtin_alloc4(1, 2, 4, 8); return *p + *(p+1) + *(p+2) + *(p+3); }
9c: 55                      push   rbp
9d: 48 89 e5                mov    rbp,rsp
a0: 48 83 ec 08             sub    rsp,0x8
a4: 55                      push   rbp
a5: 5f                      pop    rdi
a6: 48 83 ef 08             sub    rdi,0x8
aa: 57                      push   rdi
ab: 48 83 ec 10             sub    rsp,0x10
af: bf 08 00 00 00          mov    edi,0x8
b4: 57                      push   rdi
b5: bf 04 00 00 00          mov    edi,0x4
ba: 57                      push   rdi
bb: bf 02 00 00 00          mov    edi,0x2
c0: 57                      push   rdi
c1: bf 01 00 00 00          mov    edi,0x1
c6: 57                      push   rdi
c7: 5f                      pop    rdi
c8: 5e                      pop    rsi
c9: 5a                      pop    rdx
ca: 59                      pop    rcx
cb: b8 a9 00 40 00          mov    eax,0x4000a9
d0: ff d0                   call   rax
d2: 89 c7                   mov    edi,eax
d4: 48 83 c4 10             add    rsp,0x10
d8: 58                      pop    rax
d9: 48 89 38                mov    QWORD PTR [rax],rdi
dc: 55                      push   rbp
dd: 5f                      pop    rdi
de: 48 83 ef 08             sub    rdi,0x8
e2: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
e5: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
e8: 57                      push   rdi
e9: 55                      push   rbp
ea: 5f                      pop    rdi
eb: 48 83 ef 08             sub    rdi,0x8
ef: 48 8b 3f                mov    rdi,QWORD PTR [rdi]
f2: 57                      push   rdi
f3: bf 04 00 00 00          mov    edi,0x4
f8: 57                      push   rdi
f9: bf 01 00 00 00          mov    edi,0x1
fe: 57                      push   rdi
ff: 58                      pop    rax
100:    5f                      pop    rdi
101:    48 0f af f8             imul   rdi,rax
105:    57                      push   rdi
106:    58                      pop    rax
107:    5f                      pop    rdi
108:    48 01 c7                add    rdi,rax
10b:    48 8b 3f                mov    rdi,QWORD PTR [rdi]
10e:    57                      push   rdi
10f:    58                      pop    rax
110:    5f                      pop    rdi
111:    48 01 c7                add    rdi,rax
114:    57                      push   rdi
115:    55                      push   rbp
116:    5f                      pop    rdi
117:    48 83 ef 08             sub    rdi,0x8
11b:    48 8b 3f                mov    rdi,QWORD PTR [rdi]
11e:    57                      push   rdi
11f:    bf 04 00 00 00          mov    edi,0x4
124:    57                      push   rdi
125:    bf 02 00 00 00          mov    edi,0x2
12a:    57                      push   rdi
12b:    58                      pop    rax
12c:    5f                      pop    rdi
12d:    48 0f af f8             imul   rdi,rax
131:    57                      push   rdi
132:    58                      pop    rax
133:    5f                      pop    rdi
134:    48 01 c7                add    rdi,rax
137:    48 8b 3f                mov    rdi,QWORD PTR [rdi]
13a:    57                      push   rdi
13b:    58                      pop    rax
13c:    5f                      pop    rdi
13d:    48 01 c7                add    rdi,rax
140:    57                      push   rdi
141:    55                      push   rbp
142:    5f                      pop    rdi
143:    48 83 ef 08             sub    rdi,0x8
147:    48 8b 3f                mov    rdi,QWORD PTR [rdi]
14a:    57                      push   rdi
14b:    bf 04 00 00 00          mov    edi,0x4
150:    57                      push   rdi
151:    bf 03 00 00 00          mov    edi,0x3
156:    57                      push   rdi
157:    58                      pop    rax
158:    5f                      pop    rdi
159:    48 0f af f8             imul   rdi,rax
15d:    57                      push   rdi
15e:    58                      pop    rax
15f:    5f                      pop    rdi
160:    48 01 c7                add    rdi,rax
163:    48 8b 3f                mov    rdi,QWORD PTR [rdi]
166:    57                      push   rdi
167:    58                      pop    rax
168:    5f                      pop    rdi
169:    48 01 c7                add    rdi,rax
16c:    89 f8                   mov    eax,edi
16e:    c9                      leave
16f:    c3                      ret
170:    55                      push   rbp
171:    48 89 e5                mov    rbp,rsp
174:    48 83 ec 00             sub    rsp,0x0
178:    48 83 ec 08             sub    rsp,0x8
17c:    b8 14 01 40 00          mov    eax,0x400114
181:    ff d0                   call   rax
183:    89 c7                   mov    edi,eax
185:    48 83 c4 08             add    rsp,0x8
189:    b8 3c 00 00 00          mov    eax,0x3c
18e:    0f 05                   syscall
</code></pre>
		<div class="content">よし、わからん！</div>
		<div class="content">とりあえず、困難を分割しよう。p[0] から p[3] のうち、格納に成功しているのはどこまでだろうか</div>
		<pre><code class="language-bash">check 1 &quot;int main() { int *p; p = __builtin_alloc4(1, 2, 4, 8); return *p; }&quot;
check 7 &quot;int main() { int *p; p = __builtin_alloc4(7, 2, 4, 8); return *p; }&quot;
check 11 &quot;int main() { int *p; p = __builtin_alloc4(11, 2, 4, 8); return *p; }&quot;
</code></pre>
		<div class="content">通る。p[0]は格納できているようだ</div>
		<pre><code class="language-">[FAIL] int main() { int *p; p = __builtin_alloc4(2, 1, 4, 8); return *(p+1); } =&gt; 1 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 7, 4, 8); return *(p+1); } =&gt; 7 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 11, 4, 8); return *(p+1); } =&gt; 11 expected, but got 0
</code></pre>
		<div class="content">はいはい</div>
		<pre><code class="language-">[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 1, 8); return *(p+2); } =&gt; 1 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 7, 8); return *(p+2); } =&gt; 7 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 11, 8); return *(p+2); } =&gt; 11 expected, but got 0
</code></pre>
		<div class="content">パターン見えてきたよ</div>
		<pre><code class="language-">[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 8, 1); return *(p+3); } =&gt; 1 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 8, 7); return *(p+3); } =&gt; 7 expected, but got 0
[FAIL] int main() { int *p; p = __builtin_alloc4(2, 4, 8, 11); return *(p+3); } =&gt; 11 expected, but got 0
</code></pre>
		<div class="content">でしょうね</div>
		<div class="content">ということで、先頭要素の格納にだけは成功しているが、残りの 3 つが格納できておらず、必ず 0 で埋まっている</div>
		<div class="content">……あっ、分かったような気がするぞ</div>
		<div class="content">これ 32 bit 配列に 64 bit 書き込みをしてるのが原因だわ</div>
		<div class="content"><img width="500" src="media/64bit_assign.png"></div>
		<div class="content">なのでこれ直せば動くはず。まずは alloc4 の実装を直して、</div>
		<div class="content">よ～し動いた。しかし現状だと『このビルトインで確保した配列に、自分で値を書き込む』をやると 64 bit 書き込みになってバグるはず。試そう</div>
		<pre><code class="language-">[FAIL] int main() { int *p; p = __builtin_alloc4(3, 3, 3, 3); *(p+3) = 8; *(p+2) = 4; *(p+1) = 2; *p = 1; return *p + *(p+1) + *(p+2) + *(p+3); } =&gt; 15 expected, but got 1
</code></pre>
		<div class="content">よし期待通り。なので、ここの書き込みも sizeof を見るようにしなければならない</div>
		<pre><code class="language-rust">match typ.sizeof() {
    8 =&gt; buf.append(raxが指す位置にrdiを代入()),
    4 =&gt; buf.append(raxが指す位置にediを代入()),
    _ =&gt; panic!(&quot;size が {} な型への代入はできません&quot;, typ.sizeof()),
};
</code></pre>
		<div class="content">よし通った！！！</div>
		<div class="content">しかし、アセンブリの書きやすさのためにp[3] → p[2] → p[1] → p[0] の順で書き込んでいっていて幸いだったな。おかげでバグに気づけた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7e24f7b7e2f68f268382b864b50ee330').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7e24f7b7e2f68f268382b864b50ee330').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_7e24f7b7e2f68f268382b864b50ee330" href="#permalink_7e24f7b7e2f68f268382b864b50ee330" class="permalink">¶</a>
		<div class="content">sizeof演算子って型だけじゃなくて式もかけたのまじか</div>
	</div>
</div>
<h3 class="date">2023年2月1日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0a8837c4335662371bab1e6c4e66e382').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0a8837c4335662371bab1e6c4e66e382').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_0a8837c4335662371bab1e6c4e66e382" href="#permalink_0a8837c4335662371bab1e6c4e66e382" class="permalink">¶</a>
		<div class="content">次ってなんでしたっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e6d60fbcd983e14c8142d0c4d7b73a79').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e6d60fbcd983e14c8142d0c4d7b73a79').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e6d60fbcd983e14c8142d0c4d7b73a79" href="#permalink_e6d60fbcd983e14c8142d0c4d7b73a79" class="permalink">¶</a>
		<div class="content">sizeof なのでめちゃめちゃラクです</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_580cfb0e92108c9da5d0e0f8c94228bc').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_580cfb0e92108c9da5d0e0f8c94228bc').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_580cfb0e92108c9da5d0e0f8c94228bc" href="#permalink_580cfb0e92108c9da5d0e0f8c94228bc" class="permalink">¶</a>
		<div class="content">もう既に hsjoihs さんが実装終わらせてるようなもんだからな</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_e426fb72767c43a155eb94009024ed16').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_e426fb72767c43a155eb94009024ed16').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_e426fb72767c43a155eb94009024ed16" href="#permalink_e426fb72767c43a155eb94009024ed16" class="permalink">¶</a>
		<div class="content">ここ数回は奇数ステップの方が圧倒的に実装重いですね</div>
		<div class="content">現実逃避のパワーで、自分で別個でやってた C コンパイラ <a href="https://github.com/sozysozbot/2kmcc" target="_blank" rel="noopener noreferrer">https://github.com/sozysozbot/2kmcc</a> が compilerbook 基本走りきっちゃった</div>
		<div class="content">ということで、課題をやります。レビューと実装をとても素早く終わらせることによって、tkr は私の課題の進捗を邪魔することができます</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_89a03b91e8565e0dede8b2612e8e5468').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_89a03b91e8565e0dede8b2612e8e5468').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_89a03b91e8565e0dede8b2612e8e5468" href="#permalink_89a03b91e8565e0dede8b2612e8e5468" class="permalink">¶</a>
		<div class="content">圧を掛けられている</div>
		<blockquote>hsjoihs「で、現状だと +933 -625 とあまりに diff が大きすぎる。しかしこれの大部分は式パーサーを impl Context にしたことによるインデントの変更なんだよな」
</blockquote>
		<div class="content">これってgitの設定でなんとかできなかったっけ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_7955b0c5ac12814a8d2fbfaf026afba6').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_7955b0c5ac12814a8d2fbfaf026afba6').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_7955b0c5ac12814a8d2fbfaf026afba6" href="#permalink_7955b0c5ac12814a8d2fbfaf026afba6" class="permalink">¶</a>
		<div class="content">できるんだけど（てか VSCode では勝手になんとかなる）、レビューは GitHub 上で発生するので、そっちでの負担が少なくなる方がいいだろうとの判断です </div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_cb38d3b14f78e6499bb5486497ffa73f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_cb38d3b14f78e6499bb5486497ffa73f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_cb38d3b14f78e6499bb5486497ffa73f" href="#permalink_cb38d3b14f78e6499bb5486497ffa73f" class="permalink">¶</a>
		<div class="content">あ〜〜</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/southball02" target="_blank" rel="noopener noreferrer"><img alt="さうす" class="icon" src="icons/さうす.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_f0e44e3bf351d723bb9f9c0d89a79e65').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_f0e44e3bf351d723bb9f9c0d89a79e65').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/southball02" target="_blank" rel="noopener noreferrer">さうす</a></span><a id="permalink_f0e44e3bf351d723bb9f9c0d89a79e65" href="#permalink_f0e44e3bf351d723bb9f9c0d89a79e65" class="permalink">¶</a>
		<div class="content">これ使えない？</div>
		<div class="content"><img width="500" src="media/github-whitespace.png"></div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_4cef0e51cd21a2fbb38f32e358238971').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_4cef0e51cd21a2fbb38f32e358238971').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_4cef0e51cd21a2fbb38f32e358238971" href="#permalink_4cef0e51cd21a2fbb38f32e358238971" class="permalink">¶</a>
		<div class="content">へ〜こんなのが</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_965a745ad79435667385581d155e8122').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_965a745ad79435667385581d155e8122').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_965a745ad79435667385581d155e8122" href="#permalink_965a745ad79435667385581d155e8122" class="permalink">¶</a>
		<div class="content">そんなのあったの</div>
		<div class="content">便利だ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_28dbe5438c366c2398c7f81ecd983e44').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_28dbe5438c366c2398c7f81ecd983e44').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_28dbe5438c366c2398c7f81ecd983e44" href="#permalink_28dbe5438c366c2398c7f81ecd983e44" class="permalink">¶</a>
		<div class="content">まあ今回は &amp;mut Context じゃなくて &amp;Context なので、第一引数で引き回してもそんなに読みづらくならないだろうとの判断もありました</div>
		<div class="content">それはともかくさうすくんありがとうございます</div>
	</div>
</div>
<h3 class="date">2023年2月2日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6d62fa97612b13d4e58a6fce5280af23').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6d62fa97612b13d4e58a6fce5280af23').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_6d62fa97612b13d4e58a6fce5280af23" href="#permalink_6d62fa97612b13d4e58a6fce5280af23" class="permalink">¶</a>
		<div class="content">sizeofの実装やるぞ</div>
		<div class="content">トークナイザとパーサ変更して終わり。はい</div>
		<div class="content">sizeof 値 は一瞬で実装できたので、sizeof (型) を実装してからプルリク投げます</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_6b1cb23f6ea3adfd92bd24693bcbdb46').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_6b1cb23f6ea3adfd92bd24693bcbdb46').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_6b1cb23f6ea3adfd92bd24693bcbdb46" href="#permalink_6b1cb23f6ea3adfd92bd24693bcbdb46" class="permalink">¶</a>
		<div class="content">まだ配列ないから sizeof(int **[5][2]) とか考えなくていいし、よさそう</div>
		<div class="content">sizeof は型取るときはカッコ必要ですよ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a763950d86b47f79eb0533441ecf28da').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a763950d86b47f79eb0533441ecf28da').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_a763950d86b47f79eb0533441ecf28da" href="#permalink_a763950d86b47f79eb0533441ecf28da" class="permalink">¶</a>
		<div class="content">え、そうなのか。あぶなかった。カッコがなかったら絶対式だけど、カッコがあったら両方ありうる？めちゃくちゃ面倒じゃない？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_c291334c9799f3c8639330fb27158e9e').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_c291334c9799f3c8639330fb27158e9e').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_c291334c9799f3c8639330fb27158e9e" href="#permalink_c291334c9799f3c8639330fb27158e9e" class="permalink">¶</a>
		<div class="content">今の c_to_elf コンパイラの現状では型名はすべて int で始まるので、困りません</div>
		<div class="content">ところで、型がカッコで括られているといえばキャストもありますが、こいつと sizeof の兼ね合いでこういう話がありますね</div>
		<div class="content"><a href="https://godbolt.org/z/1fhT5GMb1" target="_blank" rel="noopener noreferrer">https://godbolt.org/z/1fhT5GMb1</a></div>
		<pre><code class="language-c">int foo() {
    int *p;
    return sizeof((int)*p);
}

int bar() {
    int a = 3;
    return sizeof(int)*a;
}
</code></pre>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_5cf4911cfd4f77dcb26a87800145fd7f').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_5cf4911cfd4f77dcb26a87800145fd7f').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_5cf4911cfd4f77dcb26a87800145fd7f" href="#permalink_5cf4911cfd4f77dcb26a87800145fd7f" class="permalink">¶</a>
		<div class="content">sizeof 実装できた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_8444f51b6380cea36903d18f2861d82d').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_8444f51b6380cea36903d18f2861d82d').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_8444f51b6380cea36903d18f2861d82d" href="#permalink_8444f51b6380cea36903d18f2861d82d" class="permalink">¶</a>
		<div class="content">ということで、『ステップ 21: 配列を実装する』をやっていきます</div>
		<div class="content">トークナイザに角括弧を追加</div>
		<div class="content">enum Type にも配列の存在を教え、Type::sizeof も実装</div>
		<div class="content">直前のステップ 20 で sizeof 演算子が実装してあることによりテストケースを書きやすくなっているの、なかなか上手い工夫なんだよな</div>
		<div class="content">さて、問題はパーサー。『型をパース』と『識別子名をパース』してる関数を先に一つに固め、そこに変更を加えて配列を差し込んでいくのがラクです</div>
		<div class="content">てか既に parse_parameter_type_and_identifier 関数がある。じゃあこれを改造しよう</div>
		<div class="content">ローカル変数も関数引数もともに parse_type_and_identifier 関数を呼ぶように変更</div>
		<div class="content">配列をポインタに decay させるのは、Box_ という型を間に挟んで</div>
		<pre><code class="language-rust">pub fn decay_if_arr(expr: Expr) -&gt; Box_&lt;Expr&gt; {
    match expr.typ() {
        Type::Arr(t, _) =&gt; Box_(Box::new(Expr::DecayedArr {
            expr: Box_(Box::new(expr)),
            typ: Type::Ptr(t),
        })),
        _ =&gt; Box_(Box::new(expr)),
    }
}

pub fn no_decay_even_if_arr(expr: Expr) -&gt; Box_&lt;Expr&gt; {
    Box_(Box::new(expr))
}
</code></pre>
		<div class="content">としてやることで解決。コード生成もした。さてあとは配列のための領域をスタックにアロケートするだけだな</div>
		<div class="content">えーと現状では local_var_table に『何番目の変数か』を入れていて idx と呼び、それに WORD_SIZE を掛け算してオフセットが計算されている</div>
		<div class="content">これを、オフセットを直に入れるように変更する必要があるな。これはもうこのテーブルを struct として切り出したりしたほうがいいんだろうか</div>
		<div class="content">てか未定義変数をエラーにするようにした時点で .or_insert は一個削られる運命だったんだな。まずそれを処理しよう</div>
		<div class="content">あ、.or_insert 全部外せる</div>
		<div class="content">で、今度はオフセットを直に HashMap に入れるようにして、</div>
		<div class="content">普通に更新を関数に切り出すべきだな</div>
		<div class="content">HashMap に入れて max_offset を増やす LocalVarTable::allocate() も実装</div>
		<div class="content">配列のサイズに基づいてアロケートするようにした。これでよかろう</div>
	</div>
</div>
<h3 class="date">2023年2月6日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_0c8843f3df9021e57d018f2d5d632e94').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_0c8843f3df9021e57d018f2d5d632e94').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_0c8843f3df9021e57d018f2d5d632e94" href="#permalink_0c8843f3df9021e57d018f2d5d632e94" class="permalink">¶</a>
		<div class="content">テスト実行するとMacの調子が悪くなる問題、多分サブプロセスの起動しすぎだったのでなおした</div>
		<div class="content">配列のインデックス構文はパーサ書き直すだけ。関数呼び出しも後置演算子の仲間にしたかったが意味解析も同時に行ってる現状では厳しそうなので諦め</div>
	</div>
</div>
<h3 class="date">2023年2月15日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_04921f52ad1f35f62a2333c059909c48').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_04921f52ad1f35f62a2333c059909c48').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_04921f52ad1f35f62a2333c059909c48" href="#permalink_04921f52ad1f35f62a2333c059909c48" class="permalink">¶</a>
		<div class="content">パーサーのリファクタリングもちょっとやってもらったし、そろそろステップ23（グローバル変数）の実装をやる必要がある</div>
		<div class="content">さてこれどうしたもんかね。流石にこれは ELF の中身を見ないことには回らないのかな。どうなんだろ</div>
		<div class="content">いやまあ、『グローバル変数はスタートアップ時にヒープに確保され、ゼロクリアされる』って処理系にしても規格には準拠するんだが</div>
		<div class="content">ん〜〜〜とはいえ、実際の処理系では『ゼロクリアされるような場所にグローバル変数を確保』するのはローダの仕事のはず</div>
		<div class="content">つまり！これは『いまローダがないから、それの代用として Linux システムコールに頼ってヒープに確保しているだけ』と主張することができる（ふむ〜？）</div>
		<div class="content">Q.『外部リンケージどうするの？』</div>
		<div class="content">A.『いままだリンカないから。リンカできたらそのときに初めて考えよう』</div>
		<div class="content">まあなにはともあれパースできないと始まらない</div>
		<div class="content">いまは parse_toplevel_function_definition しかないので、これを『関数定義かグローバル変数定義』へとすり替える必要がある</div>
		<div class="content">とりあえずハリボテして……</div>
		<div class="content">パーサーを書いた。動く。</div>
		<div class="content">さて、さっき実行時確保の案を出したが、グローバル変数のアドレスってコンパイル時に定数である必要があったりしなかったっけ</div>
		<div class="content">なんかそこらへんを考えると、規格に想定されていない曲芸をやるのはやめて、普通に策を練ったほうがいい気がしてくるな</div>
		<div class="content">よし、決めた、これは後回しにしよう。</div>
		<blockquote>予定変更！ @すーぱーてけらには引き続き 24 と 26 もやってもらいますが、私は 23 と 25 の実装をサボります

理由：グローバル変数は外部リンケージを持つ存在なので、「幕間」のあとにやるのが自然

「幕間」と呼んでいるのは、「今回の縛り特有」でどうしても必要になってくる要素をいくつか導入するフェーズ

幕間 1: プロトタイプ宣言と相互再帰
 - 現状の Buf を改造して、「名前付き穴」みたいなものを書けるようにし、.to_vec() で最終的に書き込むときにその「名前付き穴」を解決するようにする

幕間 2: 初めての依存ライブラリ、初めての中間ファイル
 - cargo add serde して、「名前付き穴」のある Buf を JSON として出力してしまう
 - その出力ファイルを読み、「名前付き穴」を解決し、ELF として吐く仕組みを作る

幕間 3: Yet Another Linkable Format.json
 - 複数の出力ファイルを読み、「名前付き穴」を解決し、ELF として吐く仕組みを作る
 - 分割コンパイルのテストケースを書く

ということで、私の step 23 は「グローバル変数が定義できるが、sizeof しか取ることができず、読み書きしようとするとコンパイルエラー」で一旦完成とします。同様に step 25 の文字列リテラルも「sizeof しか取ることができない定数」にします
</blockquote>
		<div class="content">sizeof のオペランドとしては正しく動くようにした。ということでこれで一旦完成とする</div>
	</div>
</div>
<h3 class="date">2023年2月16日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a81b28ad92f9bfd4a5143f865904ced7').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a81b28ad92f9bfd4a5143f865904ced7').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_a81b28ad92f9bfd4a5143f865904ced7" href="#permalink_a81b28ad92f9bfd4a5143f865904ced7" class="permalink">¶</a>
		<div class="content">あー、グローバル変数と関数が同じ名前空間に入るようにするか</div>
		<div class="content">名前空間をくっつけた</div>
	</div>
</div>
<h3 class="date">2023年3月2日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a63a1463b9879abc9d4828da3a929b53').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a63a1463b9879abc9d4828da3a929b53').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_a63a1463b9879abc9d4828da3a929b53" href="#permalink_a63a1463b9879abc9d4828da3a929b53" class="permalink">¶</a>
		<div class="content">char型の実装</div>
		<div class="content">型を追加する仕組みはすでにあるので少し修正加えるだけ。char+charがintになるの知らなくてバグらせてたけど直した</div>
	</div>
</div>
<h3 class="date">2023年3月6日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_971e292fd4d731e6adb749761f716095').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_971e292fd4d731e6adb749761f716095').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_971e292fd4d731e6adb749761f716095" href="#permalink_971e292fd4d731e6adb749761f716095" class="permalink">¶</a>
		<div class="content">文字列リテラルをやる。ただし、sizeof のオペランドとしてのみ動くようにする</div>
		<div class="content">まずはエスケープシーケンスなしで組む</div>
		<blockquote>このステップではバックスラッシュによるエスケープなどは実装する必要はありません。ステップバイステップで行くのが重要なので、簡単に実装できそうに思えても、しないようにしてみてください。
</blockquote>
		<div class="content">じゃあもうこれで終わりでいいか。まあ一応『バックスラッシュを見たらエラーを吐く』ぐらいはやってもいい</div>
	</div>
</div>
<h3 class="date">2023年4月3日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_2db73c819b5c8c2b0df7f84b2cbe9ef4').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_2db73c819b5c8c2b0df7f84b2cbe9ef4').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span><a id="permalink_2db73c819b5c8c2b0df7f84b2cbe9ef4" href="#permalink_2db73c819b5c8c2b0df7f84b2cbe9ef4" class="permalink">¶</a>
		<div class="content">さすがにそろそろ再開します</div>
		<div class="content">複数行入力、雑に実装してテストケース修正するだけかな</div>
		<div class="content">テストケースはプロセス置換で修正、トークナイザで改行などを無視するようにした</div>
		<div class="content">エラー位置の表示は filename:line:col の方がVSCodeのサポートとか考えると便利なのでこっちでいきます</div>
		<div class="content">filenameのバケツリレー大変だ</div>
		<div class="content">ちゃんと動いていそう</div>
		<pre><code class="language-c">int main() {
    b = 1;
}
</code></pre>
		<pre><code class="language-">test.c:2:5
    b = 1;
    ^ 識別子 b は定義されておらず、型が分かりません
</code></pre>
	</div>
</div>
<h3 class="date">2023年4月10日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_a88573a7e7a243bcc89b48fa6322605b').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_a88573a7e7a243bcc89b48fa6322605b').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_a88573a7e7a243bcc89b48fa6322605b" href="#permalink_a88573a7e7a243bcc89b48fa6322605b" class="permalink">¶</a>
		<div class="content">はいレビュー</div>
		<div class="content">はい複数行コメント</div>
		<div class="content">よしこれで any% クリアですね</div>
	</div>
</div>
<h3 class="date">2025年8月7日</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content" onmouseover="document.getElementById('permalink_bd3e0d7fd8c74c0fb58de4cc29a933e1').style.visibility = 'visible'" onmouseout="document.getElementById('permalink_bd3e0d7fd8c74c0fb58de4cc29a933e1').style.visibility = 'hidden'">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span><a id="permalink_bd3e0d7fd8c74c0fb58de4cc29a933e1" href="#permalink_bd3e0d7fd8c74c0fb58de4cc29a933e1" class="permalink">¶</a>
		<div class="content">あれから 2 年が経った。</div>
		<div class="content">その間に、ZEN 大学の構想が発表されて、私は 2 年間『オートマトンと形式言語理論』の教材を書き続け、ZEN 大学が開学した。</div>
		<div class="content">さて、2 日後の <a href="https://kernelvm.connpass.com/event/355100/">Kernel/VM 探検隊@東京 No18</a> で『Rui Ueyama compilerbook compile-a-compiler% 縛り実況 (C-to-ELF category)』という発表をすると宣言してしまったので、そろそろ作業をしていかんとな。</div>
		<div class="content">とりあえず 15:50～16:18 で過去ログを読んだ。</div>
		<div class="content">過去の私、『幕間』とかいう激ヤバ分量のタスクを残していないか？</div>
		<blockquote>予定変更！ @すーぱーてけらには引き続き 24 と 26 もやってもらいますが、私は 23 と 25 の実装をサボります

理由：グローバル変数は外部リンケージを持つ存在なので、「幕間」のあとにやるのが自然

「幕間」と呼んでいるのは、「今回の縛り特有」でどうしても必要になってくる要素をいくつか導入するフェーズ

幕間 1: プロトタイプ宣言と相互再帰
 - 現状の Buf を改造して、「名前付き穴」みたいなものを書けるようにし、.to_vec() で最終的に書き込むときにその「名前付き穴」を解決するようにする

幕間 2: 初めての依存ライブラリ、初めての中間ファイル
 - cargo add serde して、「名前付き穴」のある Buf を JSON として出力してしまう
 - その出力ファイルを読み、「名前付き穴」を解決し、ELF として吐く仕組みを作る

幕間 3: Yet Another Linkable Format.json
 - 複数の出力ファイルを読み、「名前付き穴」を解決し、ELF として吐く仕組みを作る
 - 分割コンパイルのテストケースを書く

ということで、私の step 23 は「グローバル変数が定義できるが、sizeof しか取ることができず、読み書きしようとするとコンパイルエラー」で一旦完成とします。同様に step 25 の文字列リテラルも「sizeof しか取ることができない定数」にします
</blockquote>
		<div class="content">夢がデカい。さ～てどこまでできることやら。</div>
		<div class="content">ん～、コンパイルすべきソースコードが 2kmcc なら、リンカの実装はだいぶサボれるのでは？</div>
		<div class="content">2kmcc って依存してる libc を極端に小さくしていて、</div>
		<pre><code class="language-c">int printf();
void exit();
void *calloc();
int strcmp();
int strncmp();
char *strchr();
char *strncpy();
char *strstr();
</code></pre>
		<div class="content">しか使っていない。文字列処理の関数は自前で実装すればよくて、exit はもう既に組まれていて、残る面倒は printf だけかぁ。</div>
		<div class="content">プロトタイプ宣言って 2kmcc 中に存在しますか？　存在しないのであれば『名前付き穴』とか実装しないで済むかもしれないが。</div>
		<div class="content">まあ、なにはともあれ、コードも一旦全部読まねばな。</div>
		<div class="content">このログを push しておくか。</div>
		<div class="content"><img width="500" src="media/ci_fail.png"></div>
		<div class="content">なぬ～ CI が落ちる。 <a href="https://github.blog/changelog/2024-04-16-deprecation-notice-v3-of-the-artifact-actions/" target="_blank" rel="noopener noreferrer">https://github.blog/changelog/2024-04-16-deprecation-notice-v3-of-the-artifact-actions/</a> を読む。</div>
		<div class="content">まあ actions/upload-pages-artifact@v1 を actions/upload-pages-artifact@v3 に変えたら通るんじゃないかな。通った。OK。</div>
		<div class="content">プロトタイプ宣言が 2kmcc 内にあるかどうかを調べる。2kmcc のコードに <code>^\S.+\);</code> で検索をかけると、</div>
		<pre><code class="language-c">int printf();
void exit();
void *calloc();
int strcmp();
int strncmp();
char *strchr();
char *strncpy();
char *strstr();
struct Expr *parseExpr(void);
struct Expr *parseUnary(void);
struct Type *consume_simple_type(void);
struct Expr *equalityExpr(struct Expr *lhs, struct Expr *rhs, int kind);
void EvaluateExprIntoRax(struct Expr *expr);
</code></pre>
		<div class="content">がある。まあそりゃ再帰下降は相互再帰するんだからプロトタイプ宣言が必要なのは当たり前か。うーむ。</div>
		<div class="content">とりあえず c-to-elf のコードを読んでいく。</div>
		<div class="content">パーサ以外は読んだ。まあパーサは読まなくても困らんだろ。現在 17:03。</div>
		<div class="content">どちらかというとテストケースを読む必要がある。</div>
		<div class="content">読んだ。まあ any% クリアと言ってるんだからそれぐらいの進捗よね。</div>
		<div class="content">これを 2kmcc に至らせるには、</div>
		<div class="content"><ul><li>複合代入演算子</li><li>インクリメント・デクリメント</li><li><code>int i = 0;</code></li><li><code>for (int i = 0;</code></li><li><code>int foo();</code></li><li>ヌルポインタ定数</li><li>論理否定</li><li>文字リテラル</li><li>エスケープシーケンス付き文字列リテラル</li><li><code>&&</code></li><li>構造体</li><li><code>void</code>, <code>void *</code>, <code>return;</code></li><li>||</li></ul></div>
		<div class="content">とかを実装する必要がある。</div>
		<div class="content">まあとりあえず簡単なやつから実装しましょう。とりあえずインクリメント・デクリメントかなぁ。</div>
		<div class="content">rust-analyzer がない。起動する。ああ rust が 1.62 なので起動しない。Rust 古すぎ罪だ。とりあえず rustup update</div>
		<div class="content">ん～ cargo -V が cargo 1.62.1 だ。which cargo すると /home/hsjoihs/.cargo/bin/cargo となる。</div>
		<div class="content">一旦吹き飛ばして入れなおすか。まずは rustup self uninstall</div>
		<div class="content">そうしたら <code>curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh</code></div>
		<pre><code class="language-">warn: It looks like you have an existing installation of Rust at:
warn: /usr/bin
warn: It is recommended that rustup be the primary Rust installation.
warn: Otherwise you may have confusion unless you are careful with your PATH.
warn: If you are sure that you want both rustup and your already installed Rust
warn: then please reply &#x60;y&#x27; or &#x60;yes&#x27; or set RUSTUP_INIT_SKIP_PATH_CHECK to yes
warn: or pass &#x60;-y&#x27; to ignore all ignorable checks.
</code></pre>
		<div class="content">なるほど？</div>
		<div class="content">もう sudo rm -rf /usr/bin/rust* するか</div>
		<div class="content">あれっ cargo check で 1.62.1 がインストールされる</div>
		<div class="content">なるほど rust-toolchain.toml のせいか</div>
		<pre><code class="language-">[toolchain]
channel = &quot;1.62.1&quot;
components = [&quot;rustfmt&quot;, &quot;clippy&quot;]
</code></pre>
		<div class="content"><code>channel = "1.88.0"</code> にしておこう</div>
		<div class="content">よ～し rust-analyzer が復活。現在時刻 17:39。</div>
		<div class="content">トークナイザに Increment と Decrement を足して、</div>
		<div class="content">前置インクリメントは素直に実装……あれ？ 汎整数拡張って起きるんだっけ？ &#x60;char a; return sizeof(++a);&#x60; で実験すると 1。了解。</div>
		<div class="content">expression.rs に足して現在 17:50</div>
		<div class="content">となると次は codegen で、</div>
		<div class="content">BinaryOp::Assign の実装をコピペしよう</div>
		<div class="content">ほしいのは &#x60;raxが指す位置の(8|4|1)バイトの値をインクリメント&#x60; を表す機械語列</div>
		<div class="content">あとインクリメント後の値を edi レジスタにセットすることも必要か</div>
		<div class="content">rax を読んでその位置の(8|4|1)バイトの値をedi 系統にセットする機械語がほしいな</div>
		<div class="content">あとは、</div>
		<pre><code class="language-rust">8 =&gt; {
    buf.append(raxが指す位置の8バイトの値をインクリメント());
    buf.append(raxが指す位置の8バイトの値をrdiに代入());
},
4 =&gt; {
    buf.append(raxが指す位置の4バイトの値をインクリメント());
    buf.append(raxが指す位置の4バイトの値をediに代入());
},
1 =&gt; {buf.append(raxが指す位置の1バイトの値をインクリメント());
    buf.append(raxが指す位置の1バイトの値をdilに代入());
},
</code></pre>
		<div class="content">の各メソッドを実装するのみ</div>
		<div class="content">x64 なので当然 <code>inc    BYTE PTR [rax] </code> とかが使える。ありがとう CISC</div>
		<div class="content">さてテストケースを足しましょうね～。はい inc 通った。一旦コミットするか。</div>
		<div class="content"><code>check 16 "int main() { int a; int b; a = 3; b = ++a; return b * a; }"</code> で 16 が返ってくることを確認</div>
		<div class="content">今度は後置インクリメント・デクリメント。</div>
		<div class="content">えーと現状だと後置演算子が添字アクセスしかないので、ちょっとパーサーに非自明な変更が要る</div>
		<div class="content">とりあえず定義をほぐした</div>
		<div class="content">後置インクリメントを実装。現在 18:44</div>
		<div class="content">後置デクリメントも実装。現在 18:46</div>
		<div class="content">次は複合代入演算子かなぁ</div>
		<div class="content">2kmcc 内では複合代入演算子は <code>+=</code> と <code>-=</code> しか使われていないので、これだけ実装すればいい</div>
		<div class="content"><code>+=</code> と <code>-=</code> を実装した。現在 19:11</div>
		<div class="content">次。文字リテラル。世の中 (2kmcc の中) にはエスケープシーケンスが \n と \\ と \&#x27; しかないので、やるだけ。</div>
		<div class="content">トークナイザに文字リテラルを追加。テストケースでシェルが解釈する（かつ、ソースコード中にシングルクオートがあるのでシングルクオートで括るのを避けたい）ので、シェルスクリプト内ではバックスラッシュを倍加</div>
		<div class="content">残るは</div>
		<div class="content"><ul><li><code>int i = 0;</code></li><li><code>for (int i = 0;</code></li><li><code>int foo();</code></li><li>ヌルポインタ定数</li><li>論理否定</li><li>エスケープシーケンス付き文字列リテラル</li><li><code>&&</code></li><li>構造体</li><li><code>void</code>, <code>void *</code>, <code>return;</code></li><li>||</li></ul></div>
		<div class="content">論理否定が安そう。組むか。</div>
		<div class="content">The expression !E is equivalent to (0==E) と規定されているので、それを組めばよい。オペランドがポインタなら比較対象はヌルポインタ定数。</div>
		<div class="content">論理否定が多分組めた。テストを書く</div>
		<div class="content">ヌルポインタを書く手は現状無いので、とりあえず『数値 0 の論理否定』『数値 42 の論理否定』『合法なポインタの論理否定』だけテスト</div>
		<div class="content">さ～て、構造体でも組みますか。ということで _Alignof を実装します</div>
		<div class="content">ん？</div>
		<pre><code class="language-">thread &#x27;main&#x27; panicked at src/main.rs:26:56:
called &#x60;Result::unwrap()&#x60; on an &#x60;Err&#x60; value: AppError { message: &quot;A (U+0041) はトークナイズできない不正な文字です&quot;, input: &quot;int main() { return _Alignof(int); }\n&quot;, filename: &quot;/dev/fd/63&quot;, pos: 21 }
</code></pre>
		<div class="content">なるほど、識別子に大文字を許すのを忘れていた</div>
		<div class="content">はいテストが通った。ということで、構造体を実装していきますか</div>
		<div class="content">とりあえず struct というキーワードを足す</div>
	</div>
</div>

<div style="font-size: 70%; display: flex; justify-content: center;">
	<div>
		Powered by <a href="https://github.com/sozysozbot/PseudoRoku">PseudoRoku</a>, which is designed by <a href="https://twitter.com/hsjoihs">hsjoihs</a>. <a href="https://github.com/sozysozbot/PseudoRoku/issues">Feel free to report any issues</a>.
	</div>
</div></body>
